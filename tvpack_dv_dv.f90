!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.13 (r6666M) -  1 Mar 2018 15:30
!
!  Differentiation of tvtl_dv in forward (tangent) mode (with options multiDirectional i4 dr8 r4):
!   variations   of useful results: tvtl tvtld
!   with respect to varying inputs: h r hd rd tvtld
!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.13 (r6666M) -  1 Mar 2018 15:30
!
!  Differentiation of tvtl in forward (tangent) mode (with options multiDirectional i4 dr8 r4):
!   variations   of useful results: tvtl
!   with respect to varying inputs: h r
!
! This file is adapted from the TVPACK.F file by Alan Genz available from
! http://www.math.wsu.edu/faculty/genz/software/fort77/tvpack.fhttp://www.math.wsu.edu/faculty/genz/software/fort77/tvpack.f
! It contains functions TVTL (trivariate normal 
! and t), BVTL (bivariate t), BVND (bivariate normal), STUDNT (univariate
! t), PHID (univariate normal), plus some support functions.
!
SUBROUTINE TVTL_DV_DV(nu, h, hd0, hd, hdd, r, rd0, rd, rdd, epsi, tvtl, &
& tvtld0, tvtld, tvtldd, nbdirs, nbdirs0)
  USE DIFFSIZES
  IMPLICIT NONE
!    
!     A function for computing trivariate normal and t-probabilities.
!     This function uses algorithms developed from the ideas 
!     described in the papers:
!       R.L. Plackett, Biometrika 41(1954), pp. 351-360.
!       Z. Drezner, Math. Comp. 62(1994), pp. 289-294.
!     with adaptive integration from (0,0,1) to (0,0,r23) to R. 
!
!      Calculate the probability that X(I) < H(I), for I = 1,2,3     
!    NU   INTEGER degrees of freedom; use NU = 0 for normal cases.
!    H    REAL array of uppoer limits for probability distribution 
!    R    REAL array of three correlation coefficients, R should 
!         contain the lower left portion of the correlation matrix r. 
!         R should contains the values r21, r31, r23 in that order.
!   EPSI  REAL required absolute accuracy; maximum accuracy for most
!          computations is approximately 1D-14
! 
  REAL*8, EXTERNAL :: TVTMFN
  INTEGER :: nu, nuc
  DOUBLE PRECISION :: h(3), h1, h2, h3, r(3), r12, r13, r23, epsi
  DOUBLE PRECISION :: hd0(nbdirsmax0, 3), h1d0(nbdirsmax0), h2d0(&
& nbdirsmax0), h3d0(nbdirsmax0), rd0(nbdirsmax0, 3), r12d0(nbdirsmax0), &
& r13d0(nbdirsmax0), r23d0(nbdirsmax0)
  DOUBLE PRECISION :: hd(nbdirsmax, 3), h1d(nbdirsmax), h2d(nbdirsmax), &
& h3d(nbdirsmax), rd(nbdirsmax, 3), r12d(nbdirsmax), r13d(nbdirsmax), &
& r23d(nbdirsmax)
  DOUBLE PRECISION :: hdd(nbdirsmax0, nbdirsmax, 3), h1dd(nbdirsmax0, &
& nbdirsmax), h2dd(nbdirsmax0, nbdirsmax), h3dd(nbdirsmax0, nbdirsmax), &
& rdd(nbdirsmax0, nbdirsmax, 3), r12dd(nbdirsmax0, nbdirsmax), r13dd(&
& nbdirsmax0, nbdirsmax), r23dd(nbdirsmax0, nbdirsmax)
  DOUBLE PRECISION :: one, zro, eps, zros(3), hs(3), tvt
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: tvtd0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: tvtd
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: tvtdd
  DOUBLE PRECISION :: rua, rub, ar, ruc, pt, bvtl, phid, ADONET
  PARAMETER (zro=0, one=1)
  COMMON /tvtmbk/ h1, h2, h3, r23, rua, rub, ar, ruc, nuc
  INTRINSIC MAX
  INTRINSIC ASIN
  INTRINSIC ABS
  INTRINSIC MIN
  INTRINSIC SIGN
  DOUBLE PRECISION :: abs0
  DOUBLE PRECISION :: abs1
  DOUBLE PRECISION :: abs2
  DOUBLE PRECISION :: abs3
  DOUBLE PRECISION :: abs4
  DOUBLE PRECISION :: abs5
  DOUBLE PRECISION :: min1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: min1d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: min1d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: min1dd
  DOUBLE PRECISION :: min2
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: min2d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: min2d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: min2dd
  DOUBLE PRECISION :: abs6
  DOUBLE PRECISION :: abs7
  DOUBLE PRECISION :: abs8
  DOUBLE PRECISION :: abs9
  DOUBLE PRECISION :: abs10
  DOUBLE PRECISION :: abs11
  DOUBLE PRECISION :: abs12
  DOUBLE PRECISION :: result1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: result1d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: result1d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: result1dd
  DOUBLE PRECISION :: result2
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: result2d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: result2d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: result2dd
  DOUBLE PRECISION :: result3
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: result3d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: result3d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: result3dd
  INTEGER :: nd
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: dummyzerodiffd
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: dummyzerodiffdd
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: dummyzerodiffd0
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: dummyzerodiffd0d
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: dummyzerodiffd1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: dummyzerodiffd1d
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: y1d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: y1dd
  DOUBLE PRECISION :: tvtl
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: tvtld0
  DOUBLE PRECISION :: tvtld(nbdirsmax)
  DOUBLE PRECISION :: tvtldd(nbdirsmax0, nbdirsmax)
  INTEGER :: nbdirs
  DOUBLE PRECISION :: y1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: y1d0
  INTRINSIC SQRT
  DOUBLE PRECISION :: arg1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: arg1d
  DOUBLE PRECISION :: result10
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: result10d
  INTEGER :: nd0
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: dummyzerodiffd2
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: dummyzerodiffd3
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: dummyzerodiffd4
  INTEGER :: nbdirs0
  IF (1d-14 .LT. epsi) THEN
    eps = epsi
  ELSE
    eps = 1d-14
  END IF
  pt = ASIN(one)
  nuc = nu
  DO nd0=1,nbdirs0
    r23dd(nd0, :) = 0.D0
    r12dd(nd0, :) = 0.D0
    h3dd(nd0, :) = 0.D0
    r13dd(nd0, :) = 0.D0
    h1dd(nd0, :) = 0.D0
    h2dd(nd0, :) = 0.D0
  END DO
  DO nd=1,nbdirs
    DO nd0=1,nbdirs0
      h1dd(nd0, nd) = hdd(nd0, nd, 1)
      h2dd(nd0, nd) = hdd(nd0, nd, 2)
      h3dd(nd0, nd) = hdd(nd0, nd, 3)
      r12dd(nd0, nd) = rdd(nd0, nd, 1)
      r13dd(nd0, nd) = rdd(nd0, nd, 2)
      r23dd(nd0, nd) = rdd(nd0, nd, 3)
    END DO
    h1d(nd) = hd(nd, 1)
    h2d(nd) = hd(nd, 2)
    h3d(nd) = hd(nd, 3)
    r12d(nd) = rd(nd, 1)
    r13d(nd) = rd(nd, 2)
    r23d(nd) = rd(nd, 3)
  END DO
  DO nd0=1,nbdirs0
    h1d0(nd0) = hd0(nd0, 1)
    h2d0(nd0) = hd0(nd0, 2)
    h3d0(nd0) = hd0(nd0, 3)
    r12d0(nd0) = rd0(nd0, 1)
    r13d0(nd0) = rd0(nd0, 2)
    r23d0(nd0) = rd0(nd0, 3)
  END DO
  h1 = h(1)
  h2 = h(2)
  h3 = h(3)
  r12 = r(1)
  r13 = r(2)
  r23 = r(3)
  IF (r12 .GE. 0.) THEN
    abs0 = r12
  ELSE
    abs0 = -r12
  END IF
  IF (r13 .GE. 0.) THEN
    abs6 = r13
  ELSE
    abs6 = -r13
  END IF
!
!     Sort R's and check for special cases
!
  IF (abs0 .GT. abs6) THEN
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        h2dd(nd0, nd) = h3dd(nd0, nd)
        h3dd(nd0, nd) = hdd(nd0, nd, 2)
        r12dd(nd0, nd) = r13dd(nd0, nd)
        r13dd(nd0, nd) = rdd(nd0, nd, 1)
      END DO
      h2d(nd) = h3d(nd)
      h3d(nd) = hd(nd, 2)
      r12d(nd) = r13d(nd)
      r13d(nd) = rd(nd, 1)
    END DO
    DO nd0=1,nbdirs0
      h2d0(nd0) = h3d0(nd0)
      h3d0(nd0) = hd0(nd0, 2)
      r12d0(nd0) = r13d0(nd0)
      r13d0(nd0) = rd0(nd0, 1)
    END DO
    h2 = h3
    h3 = h(2)
    r12 = r13
    r13 = r(1)
  END IF
  IF (r13 .GE. 0.) THEN
    abs1 = r13
  ELSE
    abs1 = -r13
  END IF
  IF (r23 .GE. 0.) THEN
    abs7 = r23
  ELSE
    abs7 = -r23
  END IF
  IF (abs1 .GT. abs7) THEN
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        h1dd(nd0, nd) = h2dd(nd0, nd)
        h2dd(nd0, nd) = hdd(nd0, nd, 1)
        r23dd(nd0, nd) = r13dd(nd0, nd)
        r13dd(nd0, nd) = rdd(nd0, nd, 3)
      END DO
      h1d(nd) = h2d(nd)
      h2d(nd) = hd(nd, 1)
      r23d(nd) = r13d(nd)
      r13d(nd) = rd(nd, 3)
    END DO
    DO nd0=1,nbdirs0
      h1d0(nd0) = h2d0(nd0)
      h2d0(nd0) = hd0(nd0, 1)
      r23d0(nd0) = r13d0(nd0)
      r13d0(nd0) = rd0(nd0, 3)
    END DO
    h1 = h2
    h2 = h(1)
    r23 = r13
    r13 = r(3)
  END IF
  tvt = 0
  IF (h1 .GE. 0.) THEN
    abs2 = h1
  ELSE
    abs2 = -h1
  END IF
  IF (h2 .GE. 0.) THEN
    abs8 = h2
  ELSE
    abs8 = -h2
  END IF
  IF (h3 .GE. 0.) THEN
    abs12 = h3
  ELSE
    abs12 = -h3
  END IF
  IF (abs2 + abs8 + abs12 .LT. eps) THEN
    DO nd0=1,nbdirs0
      result2dd(nd0, :) = 0.D0
      result3dd(nd0, :) = 0.D0
      tvtdd(nd0, :) = 0.D0
      result1dd(nd0, :) = 0.D0
    END DO
    DO nd=1,nbdirs
      IF (r12 .EQ. 1.0 .OR. r12 .EQ. -1.0) THEN
        DO nd0=1,nbdirs0
          result1dd(nd0, nd) = 0.D0
        END DO
        result1d(nd) = 0.d0
      ELSE
        arg1 = 1.0 - r12**2
        result10 = SQRT(arg1)
        DO nd0=1,nbdirs0
          arg1d(nd0) = -(2*r12*r12d0(nd0))
          IF (arg1 .EQ. 0.0) THEN
            result10d(nd0) = 0.D0
          ELSE
            result10d(nd0) = arg1d(nd0)/(2.0*SQRT(arg1))
          END IF
          result1dd(nd0, nd) = (r12dd(nd0, nd)*result10-r12d(nd)*&
&           result10d(nd0))/result10**2
        END DO
        result1d(nd) = r12d(nd)/result10
      END IF
      IF (r13 .EQ. 1.0 .OR. r13 .EQ. -1.0) THEN
        DO nd0=1,nbdirs0
          result2dd(nd0, nd) = 0.D0
        END DO
        result2d(nd) = 0.d0
      ELSE
        arg1 = 1.0 - r13**2
        result10 = SQRT(arg1)
        DO nd0=1,nbdirs0
          arg1d(nd0) = -(2*r13*r13d0(nd0))
          IF (arg1 .EQ. 0.0) THEN
            result10d(nd0) = 0.D0
          ELSE
            result10d(nd0) = arg1d(nd0)/(2.0*SQRT(arg1))
          END IF
          result2dd(nd0, nd) = (r13dd(nd0, nd)*result10-r13d(nd)*&
&           result10d(nd0))/result10**2
        END DO
        result2d(nd) = r13d(nd)/result10
      END IF
      IF (r23 .EQ. 1.0 .OR. r23 .EQ. -1.0) THEN
        DO nd0=1,nbdirs0
          result3dd(nd0, nd) = 0.D0
        END DO
        result3d(nd) = 0.d0
      ELSE
        arg1 = 1.0 - r23**2
        result10 = SQRT(arg1)
        DO nd0=1,nbdirs0
          arg1d(nd0) = -(2*r23*r23d0(nd0))
          IF (arg1 .EQ. 0.0) THEN
            result10d(nd0) = 0.D0
          ELSE
            result10d(nd0) = arg1d(nd0)/(2.0*SQRT(arg1))
          END IF
          result3dd(nd0, nd) = (r23dd(nd0, nd)*result10-r23d(nd)*&
&           result10d(nd0))/result10**2
        END DO
        result3d(nd) = r23d(nd)/result10
      END IF
      DO nd0=1,nbdirs0
        tvtdd(nd0, nd) = (result1dd(nd0, nd)+result2dd(nd0, nd)+&
&         result3dd(nd0, nd))/pt/8
      END DO
      tvtd(nd) = (result1d(nd)+result2d(nd)+result3d(nd))/pt/8
    END DO
    DO nd0=1,nbdirs0
      IF (r12 .EQ. 1.0 .OR. r12 .EQ. (-1.0)) THEN
        result1d0(nd0) = 0.D0
      ELSE
        result1d0(nd0) = r12d0(nd0)/SQRT(1.0-r12**2)
      END IF
      IF (r13 .EQ. 1.0 .OR. r13 .EQ. (-1.0)) THEN
        result2d0(nd0) = 0.D0
      ELSE
        result2d0(nd0) = r13d0(nd0)/SQRT(1.0-r13**2)
      END IF
      IF (r23 .EQ. 1.0 .OR. r23 .EQ. (-1.0)) THEN
        result3d0(nd0) = 0.D0
      ELSE
        result3d0(nd0) = r23d0(nd0)/SQRT(1.0-r23**2)
      END IF
      tvtd0(nd0) = (result1d0(nd0)+result2d0(nd0)+result3d0(nd0))/pt/8
    END DO
    result1 = ASIN(r12)
    result2 = ASIN(r13)
    result3 = ASIN(r23)
    tvt = (1+(result1+result2+result3)/pt)/8
  ELSE
    IF (r12 .GE. 0.) THEN
      abs3 = r12
    ELSE
      abs3 = -r12
    END IF
    IF (r13 .GE. 0.) THEN
      abs9 = r13
    ELSE
      abs9 = -r13
    END IF
    IF (nu .LT. 1 .AND. abs3 + abs9 .LT. eps) THEN
      DO nd0=1,nbdirs0
        result1dd(nd0, :) = 0.D0
      END DO
      CALL PHID_DV_DV(h1, h1d0, h1d, h1dd, result1, result1d0, result1d&
&               , result1dd, nbdirs, nbdirs0)
      CALL BVTL_DV_DV(nu, h2, h2d0, h2d, h2dd, h3, h3d0, h3d, h3dd, r23&
&               , r23d0, r23d, r23dd, result2, result2d0, result2d, &
&               result2dd, nbdirs, nbdirs0)
      DO nd0=1,nbdirs0
        tvtdd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          tvtdd(nd0, nd) = result1dd(nd0, nd)*result2 + result1d(nd)*&
&           result2d0(nd0) + result1d0(nd0)*result2d(nd) + result1*&
&           result2dd(nd0, nd)
        END DO
        tvtd(nd) = result1d(nd)*result2 + result1*result2d(nd)
      END DO
      DO nd0=1,nbdirs0
        tvtd0(nd0) = result1d0(nd0)*result2 + result1*result2d0(nd0)
      END DO
      tvt = result1*result2
    ELSE
      IF (r13 .GE. 0.) THEN
        abs4 = r13
      ELSE
        abs4 = -r13
      END IF
      IF (r23 .GE. 0.) THEN
        abs10 = r23
      ELSE
        abs10 = -r23
      END IF
      IF (nu .LT. 1 .AND. abs4 + abs10 .LT. eps) THEN
        DO nd0=1,nbdirs0
          result1dd(nd0, :) = 0.D0
        END DO
        CALL PHID_DV_DV(h3, h3d0, h3d, h3dd, result1, result1d0, &
&                 result1d, result1dd, nbdirs, nbdirs0)
        CALL BVTL_DV_DV(nu, h1, h1d0, h1d, h1dd, h2, h2d0, h2d, h2dd, &
&                 r12, r12d0, r12d, r12dd, result2, result2d0, result2d&
&                 , result2dd, nbdirs, nbdirs0)
        DO nd0=1,nbdirs0
          tvtdd(nd0, :) = 0.D0
        END DO
        DO nd=1,nbdirs
          DO nd0=1,nbdirs0
            tvtdd(nd0, nd) = result1dd(nd0, nd)*result2 + result1d(nd)*&
&             result2d0(nd0) + result1d0(nd0)*result2d(nd) + result1*&
&             result2dd(nd0, nd)
          END DO
          tvtd(nd) = result1d(nd)*result2 + result1*result2d(nd)
        END DO
        DO nd0=1,nbdirs0
          tvtd0(nd0) = result1d0(nd0)*result2 + result1*result2d0(nd0)
        END DO
        tvt = result1*result2
      ELSE
        IF (r12 .GE. 0.) THEN
          abs5 = r12
        ELSE
          abs5 = -r12
        END IF
        IF (r23 .GE. 0.) THEN
          abs11 = r23
        ELSE
          abs11 = -r23
        END IF
        IF (nu .LT. 1 .AND. abs5 + abs11 .LT. eps) THEN
          DO nd0=1,nbdirs0
            result1dd(nd0, :) = 0.D0
          END DO
          CALL PHID_DV_DV(h2, h2d0, h2d, h2dd, result1, result1d0, &
&                   result1d, result1dd, nbdirs, nbdirs0)
          CALL BVTL_DV_DV(nu, h1, h1d0, h1d, h1dd, h3, h3d0, h3d, h3dd, &
&                   r13, r13d0, r13d, r13dd, result2, result2d0, &
&                   result2d, result2dd, nbdirs, nbdirs0)
          DO nd0=1,nbdirs0
            tvtdd(nd0, :) = 0.D0
          END DO
          DO nd=1,nbdirs
            DO nd0=1,nbdirs0
              tvtdd(nd0, nd) = result1dd(nd0, nd)*result2 + result1d(nd)&
&               *result2d0(nd0) + result1d0(nd0)*result2d(nd) + result1*&
&               result2dd(nd0, nd)
            END DO
            tvtd(nd) = result1d(nd)*result2 + result1*result2d(nd)
          END DO
          DO nd0=1,nbdirs0
            tvtd0(nd0) = result1d0(nd0)*result2 + result1*result2d0(nd0)
          END DO
          tvt = result1*result2
        ELSE IF (1 - r23 .LT. eps) THEN
          IF (h2 .GT. h3) THEN
            DO nd0=1,nbdirs0
              min1dd(nd0, :) = 0.D0
            END DO
            DO nd=1,nbdirs
              DO nd0=1,nbdirs0
                min1dd(nd0, nd) = h3dd(nd0, nd)
              END DO
              min1d(nd) = h3d(nd)
            END DO
            DO nd0=1,nbdirs0
              min1d0(nd0) = h3d0(nd0)
            END DO
            min1 = h3
          ELSE
            DO nd0=1,nbdirs0
              min1dd(nd0, :) = 0.D0
            END DO
            DO nd=1,nbdirs
              DO nd0=1,nbdirs0
                min1dd(nd0, nd) = h2dd(nd0, nd)
              END DO
              min1d(nd) = h2d(nd)
            END DO
            DO nd0=1,nbdirs0
              min1d0(nd0) = h2d0(nd0)
            END DO
            min1 = h2
          END IF
          CALL BVTL_DV_DV(nu, h1, h1d0, h1d, h1dd, min1, min1d0, min1d, &
&                   min1dd, r12, r12d0, r12d, r12dd, tvt, tvtd0, tvtd, &
&                   tvtdd, nbdirs, nbdirs0)
        ELSE IF (r23 + 1 .LT. eps) THEN
          IF (h2 .GT. -h3) THEN
            CALL BVTL_DV_DV(nu, h1, h1d0, h1d, h1dd, h2, h2d0, h2d, h2dd&
&                     , r12, r12d0, r12d, r12dd, result1, result1d0, &
&                     result1d, result1dd, nbdirs, nbdirs0)
            CALL BVTL_DV_DV(nu, h1, h1d0, h1d, h1dd, -h3, -h3d0, -h3d, -&
&                     h3dd, r12, r12d0, r12d, r12dd, result2, result2d0&
&                     , result2d, result2dd, nbdirs, nbdirs0)
            DO nd0=1,nbdirs0
              tvtdd(nd0, :) = 0.D0
            END DO
            DO nd=1,nbdirs
              DO nd0=1,nbdirs0
                tvtdd(nd0, nd) = result1dd(nd0, nd) - result2dd(nd0, nd)
              END DO
              tvtd(nd) = result1d(nd) - result2d(nd)
            END DO
            DO nd0=1,nbdirs0
              tvtd0(nd0) = result1d0(nd0) - result2d0(nd0)
            END DO
            tvt = result1 - result2
          ELSE
            DO nd=1,nbdirs
              tvtd(nd) = 0.d0
            END DO
            DO nd0=1,nbdirs0
              tvtdd(nd0, :) = 0.D0
              tvtd0(nd0) = 0.D0
            END DO
          END IF
        ELSE
!
!        Compute singular TVT value
!
          IF (nu .LT. 1) THEN
            CALL BVTL_DV_DV(nu, h2, h2d0, h2d, h2dd, h3, h3d0, h3d, h3dd&
&                     , r23, r23d0, r23d, r23dd, result1, result1d0, &
&                     result1d, result1dd, nbdirs, nbdirs0)
            DO nd0=1,nbdirs0
              result2dd(nd0, :) = 0.D0
            END DO
            CALL PHID_DV_DV(h1, h1d0, h1d, h1dd, result2, result2d0, &
&                     result2d, result2dd, nbdirs, nbdirs0)
            DO nd0=1,nbdirs0
              tvtdd(nd0, :) = 0.D0
            END DO
            DO nd=1,nbdirs
              DO nd0=1,nbdirs0
                tvtdd(nd0, nd) = result1dd(nd0, nd)*result2 + result1d(&
&                 nd)*result2d0(nd0) + result1d0(nd0)*result2d(nd) + &
&                 result1*result2dd(nd0, nd)
              END DO
              tvtd(nd) = result1d(nd)*result2 + result1*result2d(nd)
            END DO
            DO nd0=1,nbdirs0
              tvtd0(nd0) = result1d0(nd0)*result2 + result1*result2d0(&
&               nd0)
            END DO
            tvt = result1*result2
          ELSE IF (r23 .GE. 0) THEN
            IF (h2 .GT. h3) THEN
              DO nd0=1,nbdirs0
                min2dd(nd0, :) = 0.D0
              END DO
              DO nd=1,nbdirs
                DO nd0=1,nbdirs0
                  min2dd(nd0, nd) = h3dd(nd0, nd)
                END DO
                min2d(nd) = h3d(nd)
              END DO
              DO nd0=1,nbdirs0
                min2d0(nd0) = h3d0(nd0)
              END DO
              min2 = h3
            ELSE
              DO nd0=1,nbdirs0
                min2dd(nd0, :) = 0.D0
              END DO
              DO nd=1,nbdirs
                DO nd0=1,nbdirs0
                  min2dd(nd0, nd) = h2dd(nd0, nd)
                END DO
                min2d(nd) = h2d(nd)
              END DO
              DO nd0=1,nbdirs0
                min2d0(nd0) = h2d0(nd0)
              END DO
              min2 = h2
            END IF
            DO nd=1,nbdirs
              dummyzerodiffd(nd) = 0.d0
            END DO
            DO nd0=1,nbdirs0
              dummyzerodiffdd(nd0, :) = 0.D0
              dummyzerodiffd2(nd0) = 0.D0
            END DO
            CALL BVTL_DV_DV(nu, h1, h1d0, h1d, h1dd, min2, min2d0, min2d&
&                     , min2dd, zro, dummyzerodiffd2, dummyzerodiffd, &
&                     dummyzerodiffdd, tvt, tvtd0, tvtd, tvtdd, nbdirs, &
&                     nbdirs0)
          ELSE IF (h2 .GT. -h3) THEN
            DO nd=1,nbdirs
              dummyzerodiffd0(nd) = 0.d0
              dummyzerodiffd1(nd) = 0.d0
            END DO
            DO nd0=1,nbdirs0
              dummyzerodiffd0d(nd0, :) = 0.D0
              dummyzerodiffd3(nd0) = 0.D0
              dummyzerodiffd1d(nd0, :) = 0.D0
              dummyzerodiffd4(nd0) = 0.D0
            END DO
            CALL BVTL_DV_DV(nu, h1, h1d0, h1d, h1dd, h2, h2d0, h2d, h2dd&
&                     , zro, dummyzerodiffd3, dummyzerodiffd0, &
&                     dummyzerodiffd0d, result1, result1d0, result1d, &
&                     result1dd, nbdirs, nbdirs0)
            CALL BVTL_DV_DV(nu, h1, h1d0, h1d, h1dd, -h3, -h3d0, -h3d, -&
&                     h3dd, zro, dummyzerodiffd4, dummyzerodiffd1, &
&                     dummyzerodiffd1d, result2, result2d0, result2d, &
&                     result2dd, nbdirs, nbdirs0)
            DO nd0=1,nbdirs0
              tvtdd(nd0, :) = 0.D0
            END DO
            DO nd=1,nbdirs
              DO nd0=1,nbdirs0
                tvtdd(nd0, nd) = result1dd(nd0, nd) - result2dd(nd0, nd)
              END DO
              tvtd(nd) = result1d(nd) - result2d(nd)
            END DO
            DO nd0=1,nbdirs0
              tvtd0(nd0) = result1d0(nd0) - result2d0(nd0)
            END DO
            tvt = result1 - result2
          ELSE
            DO nd=1,nbdirs
              tvtd(nd) = 0.d0
            END DO
            DO nd0=1,nbdirs0
              tvtdd(nd0, :) = 0.D0
              tvtd0(nd0) = 0.D0
            END DO
          END IF
!
!        Use numerical integration to compute probability
!
!
          rua = ASIN(r12)
          rub = ASIN(r13)
          ar = ASIN(r23)
          ruc = SIGN(pt, ar) - ar
          result1 = ADONET(tvtmfn, zro, one, eps)
          tvt = tvt + result1/(4*pt)
        END IF
      END IF
    END IF
  END IF
  IF (tvt .GT. one) THEN
    y1 = one
    DO nd=1,nbdirs
      y1d(nd) = 0.d0
    END DO
    DO nd0=1,nbdirs0
      y1d0(nd0) = 0.D0
      y1dd(nd0, :) = 0.D0
    END DO
  ELSE
    DO nd0=1,nbdirs0
      y1dd(nd0, :) = 0.D0
    END DO
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        y1dd(nd0, nd) = tvtdd(nd0, nd)
      END DO
      y1d(nd) = tvtd(nd)
    END DO
    DO nd0=1,nbdirs0
      y1d0(nd0) = tvtd0(nd0)
    END DO
    y1 = tvt
  END IF
  IF (zro .LT. y1) THEN
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        tvtldd(nd0, nd) = y1dd(nd0, nd)
      END DO
      tvtld(nd) = y1d(nd)
    END DO
    DO nd0=1,nbdirs0
      tvtld0(nd0) = y1d0(nd0)
    END DO
    tvtl = y1
  ELSE
    tvtl = zro
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        tvtldd(nd0, nd) = 0.D0
      END DO
      tvtld(nd) = 0.d0
    END DO
    DO nd0=1,nbdirs0
      tvtld0(nd0) = 0.D0
    END DO
  END IF
END SUBROUTINE TVTL_DV_DV

!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.13 (r6666M) -  1 Mar 2018 15:30
!
!  Differentiation of studnt_dv in forward (tangent) mode (with options multiDirectional i4 dr8 r4):
!   variations   of useful results: studnt studntd
!   with respect to varying inputs: t td
!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.13 (r6666M) -  1 Mar 2018 15:30
!
!  Differentiation of studnt in forward (tangent) mode (with options multiDirectional i4 dr8 r4):
!   variations   of useful results: studnt
!   with respect to varying inputs: t
!
SUBROUTINE STUDNT_DV_DV(nu, t, td0, td, tdd, studnt, studntd0, studntd, &
& studntdd, nbdirs, nbdirs0)
  USE DIFFSIZES
  IMPLICIT NONE
!
!     Student t Distribution Function
!
!                       T
!         STUDNT = C   I  ( 1 + y*y/NU )**( -(NU+1)/2 ) dy
!                   NU -INF
!
  INTEGER :: nu, j
  DOUBLE PRECISION :: t, zro, one, pi, phid
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: td0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: td
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: tdd
  DOUBLE PRECISION :: cssthe, snthe, polyn, tt, ts, rn
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: cssthed0, snthed0, polynd0&
& , ttd0, tsd0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: cssthed, snthed, polynd, ttd&
& , tsd
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: cssthedd, &
& snthedd, polyndd, ttdd, tsdd
  PARAMETER (zro=0, one=1)
  INTRINSIC ACOS
  INTRINSIC ATAN
  INTRINSIC SQRT
  INTRINSIC MOD
  INTRINSIC MIN
  INTRINSIC MAX
  DOUBLE PRECISION :: arg1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: arg1d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: arg1d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: arg1dd
  DOUBLE PRECISION :: result1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: result1d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: result1d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: result1dd
  INTEGER :: nd
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: y1d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: y1dd
  DOUBLE PRECISION :: studnt
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: studntd0
  DOUBLE PRECISION :: studntd(nbdirsmax)
  DOUBLE PRECISION :: studntdd(nbdirsmax0, nbdirsmax)
  INTEGER :: nbdirs
  DOUBLE PRECISION :: y1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: y1d0
  DOUBLE PRECISION :: result10
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: result10d
  INTEGER :: nd0
  INTEGER :: nbdirs0
  pi = ACOS(-one)
  IF (nu .LT. 1) THEN
    DO nd0=1,nbdirs0
      studntdd(nd0, :) = 0.D0
    END DO
    CALL PHID_DV_DV(t, td0, td, tdd, studnt, studntd0, studntd, studntdd&
&             , nbdirs, nbdirs0)
  ELSE IF (nu .EQ. 1) THEN
    DO nd0=1,nbdirs0
      studntdd(nd0, :) = 0.D0
    END DO
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        studntdd(nd0, nd) = (2*tdd(nd0, nd)*(1.0+t**2)-2**2*td(nd)*t*td0&
&         (nd0))/(1.0+t**2)**2/pi/2
      END DO
      studntd(nd) = 2*td(nd)/(1.0+t**2)/pi/2
    END DO
    DO nd0=1,nbdirs0
      studntd0(nd0) = 2*td0(nd0)/(1.0+t**2)/pi/2
    END DO
    studnt = (1+2*ATAN(t)/pi)/2
  ELSE IF (nu .EQ. 2) THEN
    arg1 = 2 + t*t
    DO nd0=1,nbdirs0
      arg1d0(nd0) = td0(nd0)*t + t*td0(nd0)
      IF (arg1 .EQ. 0.0) THEN
        result1d0(nd0) = 0.D0
      ELSE
        result1d0(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
      END IF
    END DO
    result1 = SQRT(arg1)
    DO nd0=1,nbdirs0
      studntdd(nd0, :) = 0.D0
      arg1dd(nd0, :) = 0.D0
      result1dd(nd0, :) = 0.D0
    END DO
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        arg1dd(nd0, nd) = tdd(nd0, nd)*t + td(nd)*td0(nd0) + td0(nd0)*td&
&         (nd) + t*tdd(nd0, nd)
      END DO
      arg1d(nd) = td(nd)*t + t*td(nd)
      IF (arg1 .EQ. 0.0) THEN
        DO nd0=1,nbdirs0
          result1dd(nd0, nd) = 0.D0
        END DO
        result1d(nd) = 0.d0
      ELSE
        result10 = SQRT(arg1)
        DO nd0=1,nbdirs0
          IF (arg1 .EQ. 0.0) THEN
            result10d(nd0) = 0.D0
          ELSE
            result10d(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
          END IF
          result1dd(nd0, nd) = (arg1dd(nd0, nd)*2.0*result10-arg1d(nd)*&
&           2.0*result10d(nd0))/(2.0*result10)**2
        END DO
        result1d(nd) = arg1d(nd)/(2.0*result10)
      END IF
      DO nd0=1,nbdirs0
        studntdd(nd0, nd) = ((tdd(nd0, nd)*result1+td(nd)*result1d0(nd0)&
&         -td0(nd0)*result1d(nd)-t*result1dd(nd0, nd))*result1**2-(td(nd&
&         )*result1-t*result1d(nd))*2*result1*result1d0(nd0))/(result1**&
&         2)**2/2
      END DO
      studntd(nd) = (td(nd)*result1-t*result1d(nd))/result1**2/2
    END DO
    DO nd0=1,nbdirs0
      studntd0(nd0) = (td0(nd0)*result1-t*result1d0(nd0))/result1**2/2
    END DO
    studnt = (1+t/result1)/2
  ELSE
    DO nd0=1,nbdirs0
      ttd0(nd0) = td0(nd0)*t + t*td0(nd0)
    END DO
    tt = t*t
    DO nd0=1,nbdirs0
      cssthedd(nd0, :) = 0.D0
      ttdd(nd0, :) = 0.D0
    END DO
    DO nd=1,nbdirs
      ttd(nd) = td(nd)*t + t*td(nd)
      DO nd0=1,nbdirs0
        ttdd(nd0, nd) = tdd(nd0, nd)*t + td(nd)*td0(nd0) + td0(nd0)*td(&
&         nd) + t*tdd(nd0, nd)
        cssthedd(nd0, nd) = (ttd(nd)*2*(1+tt/nu)*ttd0(nd0)/nu**2-ttdd(&
&         nd0, nd)*(1+tt/nu)**2/nu)/((1+tt/nu)**2)**2
      END DO
      cssthed(nd) = (-(ttd(nd)/nu))/(1+tt/nu)**2
    END DO
    DO nd0=1,nbdirs0
      cssthed0(nd0) = (-(ttd0(nd0)/nu))/(1+tt/nu)**2
    END DO
    cssthe = 1/(1+tt/nu)
    polyn = 1
    DO nd=1,nbdirs
      polynd(nd) = 0.d0
    END DO
    DO nd0=1,nbdirs0
      polynd0(nd0) = 0.D0
      polyndd(nd0, :) = 0.D0
    END DO
    DO j=nu-2,2,-2
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          polyndd(nd0, nd) = (j-1)*(cssthedd(nd0, nd)*polyn+cssthed(nd)*&
&           polynd0(nd0)+cssthed0(nd0)*polynd(nd)+cssthe*polyndd(nd0, nd&
&           ))/j
        END DO
        polynd(nd) = (j-1)*(cssthed(nd)*polyn+cssthe*polynd(nd))/j
      END DO
      DO nd0=1,nbdirs0
        polynd0(nd0) = (j-1)*(cssthed0(nd0)*polyn+cssthe*polynd0(nd0))/j
      END DO
      polyn = 1 + (j-1)*cssthe*polyn/j
    END DO
    IF (MOD(nu, 2) .EQ. 1) THEN
      rn = nu
      result1 = SQRT(rn)
      DO nd0=1,nbdirs0
        tsd0(nd0) = td0(nd0)/result1
      END DO
      ts = t/result1
      DO nd0=1,nbdirs0
        studntdd(nd0, :) = 0.D0
        tsdd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        tsd(nd) = td(nd)/result1
        DO nd0=1,nbdirs0
          tsdd(nd0, nd) = tdd(nd0, nd)/result1
          studntdd(nd0, nd) = 2*((tsdd(nd0, nd)*(1.0+ts**2)-tsd(nd)*2*ts&
&           *tsd0(nd0))/(1.0+ts**2)**2+(tsdd(nd0, nd)*cssthe+tsd(nd)*&
&           cssthed0(nd0)+tsd0(nd0)*cssthed(nd)+ts*cssthedd(nd0, nd))*&
&           polyn+(tsd(nd)*cssthe+ts*cssthed(nd))*polynd0(nd0)+(tsd0(nd0&
&           )*cssthe+ts*cssthed0(nd0))*polynd(nd)+ts*cssthe*polyndd(nd0&
&           , nd))/pi/2
        END DO
        studntd(nd) = 2*(tsd(nd)/(1.0+ts**2)+(tsd(nd)*cssthe+ts*cssthed(&
&         nd))*polyn+ts*cssthe*polynd(nd))/pi/2
      END DO
      DO nd0=1,nbdirs0
        studntd0(nd0) = 2*(tsd0(nd0)/(1.0+ts**2)+(tsd0(nd0)*cssthe+ts*&
&         cssthed0(nd0))*polyn+ts*cssthe*polynd0(nd0))/pi/2
      END DO
      studnt = (1+2*(ATAN(ts)+ts*cssthe*polyn)/pi)/2
    ELSE
      arg1 = nu + tt
      result1 = SQRT(arg1)
      DO nd0=1,nbdirs0
        arg1d0(nd0) = ttd0(nd0)
        IF (arg1 .EQ. 0.0) THEN
          result1d0(nd0) = 0.D0
        ELSE
          result1d0(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
        END IF
        snthed0(nd0) = (td0(nd0)*result1-t*result1d0(nd0))/result1**2
      END DO
      snthe = t/result1
      DO nd0=1,nbdirs0
        studntdd(nd0, :) = 0.D0
        snthedd(nd0, :) = 0.D0
        arg1dd(nd0, :) = 0.D0
        result1dd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          arg1dd(nd0, nd) = ttdd(nd0, nd)
        END DO
        arg1d(nd) = ttd(nd)
        IF (arg1 .EQ. 0.0) THEN
          DO nd0=1,nbdirs0
            result1dd(nd0, nd) = 0.D0
          END DO
          result1d(nd) = 0.d0
        ELSE
          result10 = SQRT(arg1)
          DO nd0=1,nbdirs0
            IF (arg1 .EQ. 0.0) THEN
              result10d(nd0) = 0.D0
            ELSE
              result10d(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
            END IF
            result1dd(nd0, nd) = (arg1dd(nd0, nd)*2.0*result10-arg1d(nd)&
&             *2.0*result10d(nd0))/(2.0*result10)**2
          END DO
          result1d(nd) = arg1d(nd)/(2.0*result10)
        END IF
        snthed(nd) = (td(nd)*result1-t*result1d(nd))/result1**2
        DO nd0=1,nbdirs0
          snthedd(nd0, nd) = ((tdd(nd0, nd)*result1+td(nd)*result1d0(nd0&
&           )-td0(nd0)*result1d(nd)-t*result1dd(nd0, nd))*result1**2-(td&
&           (nd)*result1-t*result1d(nd))*2*result1*result1d0(nd0))/(&
&           result1**2)**2
          studntdd(nd0, nd) = (snthedd(nd0, nd)*polyn+snthed(nd)*polynd0&
&           (nd0)+snthed0(nd0)*polynd(nd)+snthe*polyndd(nd0, nd))/2
        END DO
        studntd(nd) = (snthed(nd)*polyn+snthe*polynd(nd))/2
      END DO
      DO nd0=1,nbdirs0
        studntd0(nd0) = (snthed0(nd0)*polyn+snthe*polynd0(nd0))/2
      END DO
      studnt = (1+snthe*polyn)/2
    END IF
    IF (studnt .GT. one) THEN
      y1 = one
      DO nd=1,nbdirs
        y1d(nd) = 0.d0
      END DO
      DO nd0=1,nbdirs0
        y1d0(nd0) = 0.D0
        y1dd(nd0, :) = 0.D0
      END DO
    ELSE
      DO nd0=1,nbdirs0
        y1dd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          y1dd(nd0, nd) = studntdd(nd0, nd)
        END DO
        y1d(nd) = studntd(nd)
      END DO
      DO nd0=1,nbdirs0
        y1d0(nd0) = studntd0(nd0)
      END DO
      y1 = studnt
    END IF
    IF (zro .LT. y1) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          studntdd(nd0, nd) = y1dd(nd0, nd)
        END DO
        studntd(nd) = y1d(nd)
      END DO
      DO nd0=1,nbdirs0
        studntd0(nd0) = y1d0(nd0)
      END DO
      studnt = y1
    ELSE
      studnt = zro
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          studntdd(nd0, nd) = 0.D0
        END DO
        studntd(nd) = 0.d0
      END DO
      DO nd0=1,nbdirs0
        studntd0(nd0) = 0.D0
      END DO
    END IF
  END IF
END SUBROUTINE STUDNT_DV_DV

!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.13 (r6666M) -  1 Mar 2018 15:30
!
!  Differentiation of bvtl_dv in forward (tangent) mode (with options multiDirectional i4 dr8 r4):
!   variations   of useful results: bvtld bvtl
!   with respect to varying inputs: dh dk r dkd dhd rd
!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.13 (r6666M) -  1 Mar 2018 15:30
!
!  Differentiation of bvtl in forward (tangent) mode (with options multiDirectional i4 dr8 r4):
!   variations   of useful results: bvtl
!   with respect to varying inputs: dh dk r
!
SUBROUTINE BVTL_DV_DV(nu, dh, dhd0, dhd, dhdd, dk, dkd0, dkd, dkdd, r, &
& rd0, rd, rdd, bvtl, bvtld0, bvtld, bvtldd, nbdirs, nbdirs0)
  USE DIFFSIZES
  IMPLICIT NONE
!     END BVTL
!
!     A function for computing bivariate t probabilities.
!
!       Alan Genz
!       Department of Mathematics
!       Washington State University
!       Pullman, WA 99164-3113
!       Email : alangenz@wsu.edu
!
!    This function is based on the method described by 
!        Dunnett, C.W. and M. Sobel, (1954),
!        A bivariate generalization of Student's t-distribution
!        with tables for certain special cases,
!        Biometrika 41, pp. 153-169.
!
! BVTL - calculate the probability that X < DH and Y < DK. 
!
! parameters
!
!   NU number of degrees of freedom
!   DH 1st lower integration limit
!   DK 2nd lower integration limit
!   R   correlation coefficient
!
  INTEGER :: nu, j, hs, ks
  DOUBLE PRECISION :: dh, dk, r
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: dhd0, dkd0, rd0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: dhd, dkd, rd
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: dhdd, dkdd, rdd
  DOUBLE PRECISION :: tpi, pi, ors, hrk, krh, bvt, snu, bvnd, studnt
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: orsd0, hrkd0, krhd0, bvtd0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: orsd, hrkd, krhd, bvtd
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: orsdd, hrkdd, &
& krhdd, bvtdd
  DOUBLE PRECISION :: gmph, gmpk, xnkh, xnhk, qhrk, hkn, hpk, hkrn
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: gmphd0, gmpkd0, xnkhd0, &
& xnhkd0, qhrkd0, hknd0, hpkd0, hkrnd0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: gmphd, gmpkd, xnkhd, xnhkd, &
& qhrkd, hknd, hpkd, hkrnd
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: gmphdd, gmpkdd, &
& xnkhdd, xnhkdd, qhrkdd, hkndd, hpkdd, hkrndd
  DOUBLE PRECISION :: btnckh, btnchk, btpdkh, btpdhk, one, eps
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: btnckhd0, btnchkd0, &
& btpdkhd0, btpdhkd0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: btnckhd, btnchkd, btpdkhd, &
& btpdhkd
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: btnckhdd, &
& btnchkdd, btpdkhdd, btpdhkdd
  PARAMETER (one=1, eps=1d-15)
  INTRINSIC MIN
  INTRINSIC ACOS
  INTRINSIC SQRT
  INTRINSIC ABS
  INTRINSIC SIGN
  INTRINSIC MOD
  INTRINSIC ATAN2
  DOUBLE PRECISION :: min1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: min1d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: min1d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: min1dd
  DOUBLE PRECISION :: abs0
  DOUBLE PRECISION :: result1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: result1d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: result1d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: result1dd
  DOUBLE PRECISION :: result2
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: result2d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: result2d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: result2dd
  DOUBLE PRECISION :: arg1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: arg1d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: arg1d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: arg1dd
  DOUBLE PRECISION :: arg2
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: arg2d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: arg2d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: arg2dd
  INTEGER :: nd
  DOUBLE PRECISION :: bvtld(nbdirsmax)
  DOUBLE PRECISION :: bvtldd(nbdirsmax0, nbdirsmax)
  DOUBLE PRECISION :: bvtl
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: bvtld0
  INTEGER :: nbdirs
  DOUBLE PRECISION :: result10
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: result10d
  INTEGER :: nd0
  INTEGER :: nbdirs0
  IF (nu .LT. 1) THEN
    DO nd0=1,nbdirs0
      bvtldd(nd0, :) = 0.D0
    END DO
    CALL BVND_DV_DV(-dh, -dhd0, -dhd, -dhdd, -dk, -dkd0, -dkd, -dkdd, r&
&             , rd0, rd, rdd, bvtl, bvtld0, bvtld, bvtldd, nbdirs, &
&             nbdirs0)
  ELSE IF (1 - r .LE. eps) THEN
    IF (dh .GT. dk) THEN
      DO nd0=1,nbdirs0
        min1dd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          min1dd(nd0, nd) = dkdd(nd0, nd)
        END DO
        min1d(nd) = dkd(nd)
      END DO
      DO nd0=1,nbdirs0
        min1d0(nd0) = dkd0(nd0)
      END DO
      min1 = dk
    ELSE
      DO nd0=1,nbdirs0
        min1dd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          min1dd(nd0, nd) = dhdd(nd0, nd)
        END DO
        min1d(nd) = dhd(nd)
      END DO
      DO nd0=1,nbdirs0
        min1d0(nd0) = dhd0(nd0)
      END DO
      min1 = dh
    END IF
    CALL STUDNT_DV_DV(nu, min1, min1d0, min1d, min1dd, bvtl, bvtld0, &
&               bvtld, bvtldd, nbdirs, nbdirs0)
  ELSE IF (r + 1 .LE. eps) THEN
    IF (dh .GT. -dk) THEN
      CALL STUDNT_DV_DV(nu, dh, dhd0, dhd, dhdd, result1, result1d0, &
&                 result1d, result1dd, nbdirs, nbdirs0)
      CALL STUDNT_DV_DV(nu, -dk, -dkd0, -dkd, -dkdd, result2, result2d0&
&                 , result2d, result2dd, nbdirs, nbdirs0)
      DO nd0=1,nbdirs0
        bvtldd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          bvtldd(nd0, nd) = result1dd(nd0, nd) - result2dd(nd0, nd)
        END DO
        bvtld(nd) = result1d(nd) - result2d(nd)
      END DO
      DO nd0=1,nbdirs0
        bvtld0(nd0) = result1d0(nd0) - result2d0(nd0)
      END DO
      bvtl = result1 - result2
    ELSE
      bvtl = 0
      DO nd=1,nbdirs
        bvtld(nd) = 0.d0
      END DO
      DO nd0=1,nbdirs0
        bvtldd(nd0, :) = 0.D0
        bvtld0(nd0) = 0.D0
      END DO
    END IF
  ELSE
    pi = ACOS(-one)
    tpi = 2*pi
    snu = nu
    snu = SQRT(snu)
    DO nd0=1,nbdirs0
      krhdd(nd0, :) = 0.D0
      orsdd(nd0, :) = 0.D0
      hrkdd(nd0, :) = 0.D0
    END DO
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        orsdd(nd0, nd) = -(rdd(nd0, nd)*r) - rd(nd)*rd0(nd0) - rd0(nd0)*&
&         rd(nd) - r*rdd(nd0, nd)
        hrkdd(nd0, nd) = dhdd(nd0, nd) - rdd(nd0, nd)*dk - rd(nd)*dkd0(&
&         nd0) - rd0(nd0)*dkd(nd) - r*dkdd(nd0, nd)
        krhdd(nd0, nd) = dkdd(nd0, nd) - rdd(nd0, nd)*dh - rd(nd)*dhd0(&
&         nd0) - rd0(nd0)*dhd(nd) - r*dhdd(nd0, nd)
      END DO
      orsd(nd) = -(rd(nd)*r) - r*rd(nd)
      hrkd(nd) = dhd(nd) - rd(nd)*dk - r*dkd(nd)
      krhd(nd) = dkd(nd) - rd(nd)*dh - r*dhd(nd)
    END DO
    DO nd0=1,nbdirs0
      orsd0(nd0) = -(rd0(nd0)*r) - r*rd0(nd0)
      hrkd0(nd0) = dhd0(nd0) - rd0(nd0)*dk - r*dkd0(nd0)
      krhd0(nd0) = dkd0(nd0) - rd0(nd0)*dh - r*dhd0(nd0)
    END DO
    ors = 1 - r*r
    hrk = dh - r*dk
    krh = dk - r*dh
    IF (hrk .GE. 0.) THEN
      abs0 = hrk
    ELSE
      abs0 = -hrk
    END IF
    IF (abs0 + ors .GT. 0) THEN
      DO nd0=1,nbdirs0
        xnkhdd(nd0, :) = 0.D0
        xnhkdd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          xnhkdd(nd0, nd) = ((2*((hrkd0(nd0)*hrkd(nd)+hrk*hrkdd(nd0, nd)&
&           )*(hrk**2+ors*(nu+dk**2)))+2*(hrk*hrkd(nd)*(2*hrk*hrkd0(nd0)&
&           +orsd0(nd0)*(nu+dk**2)+ors*2*dk*dkd0(nd0)))-2*hrk*hrkd0(nd0)&
&           *(2*hrk*hrkd(nd)+orsd(nd)*(nu+dk**2)+ors*2*dk*dkd(nd))-hrk**&
&           2*(2*(hrkd0(nd0)*hrkd(nd))+2*(hrk*hrkdd(nd0, nd))+orsdd(nd0&
&           , nd)*(nu+dk**2)+orsd(nd)*2*dk*dkd0(nd0)+2*((orsd0(nd0)*dk+&
&           ors*dkd0(nd0))*dkd(nd))+2*(ors*dk*dkdd(nd0, nd))))*(hrk**2+&
&           ors*(nu+dk**2))**2-(2*hrk*hrkd(nd)*(hrk**2+ors*(nu+dk**2))-&
&           hrk**2*(2*hrk*hrkd(nd)+orsd(nd)*(nu+dk**2)+ors*2*dk*dkd(nd))&
&           )*2*(hrk**2+ors*(nu+dk**2))*(2*hrk*hrkd0(nd0)+orsd0(nd0)*(nu&
&           +dk**2)+ors*2*dk*dkd0(nd0)))/((hrk**2+ors*(nu+dk**2))**2)**2
          xnkhdd(nd0, nd) = ((2*((krhd0(nd0)*krhd(nd)+krh*krhdd(nd0, nd)&
&           )*(krh**2+ors*(nu+dh**2)))+2*(krh*krhd(nd)*(2*krh*krhd0(nd0)&
&           +orsd0(nd0)*(nu+dh**2)+ors*2*dh*dhd0(nd0)))-2*krh*krhd0(nd0)&
&           *(2*krh*krhd(nd)+orsd(nd)*(nu+dh**2)+ors*2*dh*dhd(nd))-krh**&
&           2*(2*(krhd0(nd0)*krhd(nd))+2*(krh*krhdd(nd0, nd))+orsdd(nd0&
&           , nd)*(nu+dh**2)+orsd(nd)*2*dh*dhd0(nd0)+2*((orsd0(nd0)*dh+&
&           ors*dhd0(nd0))*dhd(nd))+2*(ors*dh*dhdd(nd0, nd))))*(krh**2+&
&           ors*(nu+dh**2))**2-(2*krh*krhd(nd)*(krh**2+ors*(nu+dh**2))-&
&           krh**2*(2*krh*krhd(nd)+orsd(nd)*(nu+dh**2)+ors*2*dh*dhd(nd))&
&           )*2*(krh**2+ors*(nu+dh**2))*(2*krh*krhd0(nd0)+orsd0(nd0)*(nu&
&           +dh**2)+ors*2*dh*dhd0(nd0)))/((krh**2+ors*(nu+dh**2))**2)**2
        END DO
        xnhkd(nd) = (2*hrk*hrkd(nd)*(hrk**2+ors*(nu+dk**2))-hrk**2*(2*&
&         hrk*hrkd(nd)+orsd(nd)*(nu+dk**2)+ors*2*dk*dkd(nd)))/(hrk**2+&
&         ors*(nu+dk**2))**2
        xnkhd(nd) = (2*krh*krhd(nd)*(krh**2+ors*(nu+dh**2))-krh**2*(2*&
&         krh*krhd(nd)+orsd(nd)*(nu+dh**2)+ors*2*dh*dhd(nd)))/(krh**2+&
&         ors*(nu+dh**2))**2
      END DO
      DO nd0=1,nbdirs0
        xnhkd0(nd0) = (2*hrk*hrkd0(nd0)*(hrk**2+ors*(nu+dk**2))-hrk**2*(&
&         2*hrk*hrkd0(nd0)+orsd0(nd0)*(nu+dk**2)+ors*2*dk*dkd0(nd0)))/(&
&         hrk**2+ors*(nu+dk**2))**2
        xnkhd0(nd0) = (2*krh*krhd0(nd0)*(krh**2+ors*(nu+dh**2))-krh**2*(&
&         2*krh*krhd0(nd0)+orsd0(nd0)*(nu+dh**2)+ors*2*dh*dhd0(nd0)))/(&
&         krh**2+ors*(nu+dh**2))**2
      END DO
      xnhk = hrk**2/(hrk**2+ors*(nu+dk**2))
      xnkh = krh**2/(krh**2+ors*(nu+dh**2))
    ELSE
      xnhk = 0
      xnkh = 0
      DO nd=1,nbdirs
        xnkhd(nd) = 0.d0
        xnhkd(nd) = 0.d0
      END DO
      DO nd0=1,nbdirs0
        xnkhd0(nd0) = 0.D0
        xnhkd0(nd0) = 0.D0
        xnkhdd(nd0, :) = 0.D0
        xnhkdd(nd0, :) = 0.D0
      END DO
    END IF
    arg1 = dh - r*dk
    hs = SIGN(one, arg1)
    arg1 = dk - r*dh
    ks = SIGN(one, arg1)
    IF (MOD(nu, 2) .EQ. 0) THEN
      DO nd0=1,nbdirs0
        IF (ors .EQ. 0.0) THEN
          result1d0(nd0) = 0.D0
        ELSE
          result1d0(nd0) = orsd0(nd0)/(2.0*SQRT(ors))
        END IF
        arg1d0(nd0) = 16*2*dh*dhd0(nd0)
      END DO
      result1 = SQRT(ors)
      arg1 = 16*(nu+dh**2)
      DO nd0=1,nbdirs0
        bvtdd(nd0, :) = 0.D0
        arg1dd(nd0, :) = 0.D0
        result2dd(nd0, :) = 0.D0
        result1dd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        IF (ors .EQ. 0.0) THEN
          DO nd0=1,nbdirs0
            result1dd(nd0, nd) = 0.D0
          END DO
          result1d(nd) = 0.d0
        ELSE
          result10 = SQRT(ors)
          DO nd0=1,nbdirs0
            IF (ors .EQ. 0.0) THEN
              result10d(nd0) = 0.D0
            ELSE
              result10d(nd0) = orsd0(nd0)/(2.0*SQRT(ors))
            END IF
            result1dd(nd0, nd) = (orsdd(nd0, nd)*2.0*result10-orsd(nd)*&
&             2.0*result10d(nd0))/(2.0*result10)**2
          END DO
          result1d(nd) = orsd(nd)/(2.0*result10)
        END IF
        DO nd0=1,nbdirs0
          bvtdd(nd0, nd) = ((rdd(nd0, nd)*result1+rd(nd)*result1d0(nd0)-&
&           result1dd(nd0, nd)*r-result1d(nd)*rd0(nd0))*(result1**2+(-r)&
&           **2)-(rd(nd)*result1-result1d(nd)*r)*(2*result1*result1d0(&
&           nd0)+2*r*rd0(nd0)))/(result1**2+(-r)**2)**2/tpi
          arg1dd(nd0, nd) = 16*2*(dhd0(nd0)*dhd(nd)+dh*dhdd(nd0, nd))
        END DO
        bvtd(nd) = (rd(nd)*result1-result1d(nd)*r)/(result1**2+(-r)**2)/&
&         tpi
        arg1d(nd) = 16*2*dh*dhd(nd)
        IF (arg1 .EQ. 0.0) THEN
          DO nd0=1,nbdirs0
            result1dd(nd0, nd) = 0.D0
          END DO
          result1d(nd) = 0.d0
        ELSE
          result10 = SQRT(arg1)
          DO nd0=1,nbdirs0
            IF (arg1 .EQ. 0.0) THEN
              result10d(nd0) = 0.D0
            ELSE
              result10d(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
            END IF
            result1dd(nd0, nd) = (arg1dd(nd0, nd)*2.0*result10-arg1d(nd)&
&             *2.0*result10d(nd0))/(2.0*result10)**2
          END DO
          result1d(nd) = arg1d(nd)/(2.0*result10)
        END IF
        result10 = SQRT(1 - xnkh)
        DO nd0=1,nbdirs0
          arg1dd(nd0, nd) = 16*2*(dkd0(nd0)*dkd(nd)+dk*dkdd(nd0, nd))
          result10d(nd0) = -(xnkhd0(nd0)/(2.0*SQRT(1-xnkh)))
          result2dd(nd0, nd) = -((xnkhdd(nd0, nd)*2.0*result10-xnkhd(nd)&
&           *2.0*result10d(nd0))/(2.0*result10)**2)
        END DO
        arg1d(nd) = 16*2*dk*dkd(nd)
        result2d(nd) = -(xnkhd(nd)/(2.0*result10))
      END DO
      DO nd0=1,nbdirs0
        bvtd0(nd0) = (rd0(nd0)*result1-result1d0(nd0)*r)/(result1**2+(-r&
&         )**2)/tpi
        IF (arg1 .EQ. 0.0) THEN
          result1d0(nd0) = 0.D0
        ELSE
          result1d0(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
        END IF
        arg1d0(nd0) = 16*2*dk*dkd0(nd0)
      END DO
      bvt = ATAN2(result1, -r)/tpi
      result1 = SQRT(arg1)
      arg1 = 16*(nu+dk**2)
      DO nd0=1,nbdirs0
        gmphdd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          gmphdd(nd0, nd) = ((dhdd(nd0, nd)*result1+dhd(nd)*result1d0(&
&           nd0)-dhd0(nd0)*result1d(nd)-dh*result1dd(nd0, nd))*result1**&
&           2-(dhd(nd)*result1-dh*result1d(nd))*2*result1*result1d0(nd0)&
&           )/(result1**2)**2
        END DO
        gmphd(nd) = (dhd(nd)*result1-dh*result1d(nd))/result1**2
        IF (arg1 .EQ. 0.0) THEN
          DO nd0=1,nbdirs0
            result1dd(nd0, nd) = 0.D0
          END DO
          result1d(nd) = 0.d0
        ELSE
          result10 = SQRT(arg1)
          DO nd0=1,nbdirs0
            IF (arg1 .EQ. 0.0) THEN
              result10d(nd0) = 0.D0
            ELSE
              result10d(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
            END IF
            result1dd(nd0, nd) = (arg1dd(nd0, nd)*2.0*result10-arg1d(nd)&
&             *2.0*result10d(nd0))/(2.0*result10)**2
          END DO
          result1d(nd) = arg1d(nd)/(2.0*result10)
        END IF
        DO nd0=1,nbdirs0
          arg1dd(nd0, nd) = xnkhdd(nd0, nd)*(1-xnkh) - xnkhd(nd)*xnkhd0(&
&           nd0) - xnkhd0(nd0)*xnkhd(nd) - xnkh*xnkhdd(nd0, nd)
        END DO
        arg1d(nd) = xnkhd(nd)*(1-xnkh) - xnkh*xnkhd(nd)
      END DO
      DO nd0=1,nbdirs0
        gmphd0(nd0) = (dhd0(nd0)*result1-dh*result1d0(nd0))/result1**2
        IF (arg1 .EQ. 0.0) THEN
          result1d0(nd0) = 0.D0
        ELSE
          result1d0(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
        END IF
      END DO
      gmph = dh/result1
      result1 = SQRT(arg1)
      DO nd0=1,nbdirs0
        gmpkdd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          gmpkdd(nd0, nd) = ((dkdd(nd0, nd)*result1+dkd(nd)*result1d0(&
&           nd0)-dkd0(nd0)*result1d(nd)-dk*result1dd(nd0, nd))*result1**&
&           2-(dkd(nd)*result1-dk*result1d(nd))*2*result1*result1d0(nd0)&
&           )/(result1**2)**2
        END DO
        gmpkd(nd) = (dkd(nd)*result1-dk*result1d(nd))/result1**2
        IF (xnkh .EQ. 0.0) THEN
          DO nd0=1,nbdirs0
            result1dd(nd0, nd) = 0.D0
          END DO
          result1d(nd) = 0.d0
        ELSE
          result10 = SQRT(xnkh)
          DO nd0=1,nbdirs0
            IF (xnkh .EQ. 0.0) THEN
              result10d(nd0) = 0.D0
            ELSE
              result10d(nd0) = xnkhd0(nd0)/(2.0*SQRT(xnkh))
            END IF
            result1dd(nd0, nd) = (xnkhdd(nd0, nd)*2.0*result10-xnkhd(nd)&
&             *2.0*result10d(nd0))/(2.0*result10)**2
          END DO
          result1d(nd) = xnkhd(nd)/(2.0*result10)
        END IF
      END DO
      DO nd0=1,nbdirs0
        gmpkd0(nd0) = (dkd0(nd0)*result1-dk*result1d0(nd0))/result1**2
        IF (xnkh .EQ. 0.0) THEN
          result1d0(nd0) = 0.D0
        ELSE
          result1d0(nd0) = xnkhd0(nd0)/(2.0*SQRT(xnkh))
        END IF
        result2d0(nd0) = -(xnkhd0(nd0)/(2.0*SQRT(1-xnkh)))
        arg1d0(nd0) = xnkhd0(nd0)*(1-xnkh) - xnkh*xnkhd0(nd0)
      END DO
      gmpk = dk/result1
      result1 = SQRT(xnkh)
      result2 = SQRT(1 - xnkh)
      arg1 = xnkh*(1-xnkh)
      DO nd0=1,nbdirs0
        btnckhdd(nd0, :) = 0.D0
        btpdkhdd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          btnckhdd(nd0, nd) = (2*(result1dd(nd0, nd)*result2+result1d(nd&
&           )*result2d0(nd0)-result2dd(nd0, nd)*result1-result2d(nd)*&
&           result1d0(nd0))*(result1**2+result2**2)-2*(result1d(nd)*&
&           result2-result2d(nd)*result1)*(2*result1*result1d0(nd0)+2*&
&           result2*result2d0(nd0)))/(result1**2+result2**2)**2/pi
        END DO
        btnckhd(nd) = 2*(result1d(nd)*result2-result2d(nd)*result1)/(&
&         result1**2+result2**2)/pi
        IF (arg1 .EQ. 0.0) THEN
          DO nd0=1,nbdirs0
            result1dd(nd0, nd) = 0.D0
          END DO
          result1d(nd) = 0.d0
        ELSE
          result10 = SQRT(arg1)
          DO nd0=1,nbdirs0
            IF (arg1 .EQ. 0.0) THEN
              result10d(nd0) = 0.D0
            ELSE
              result10d(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
            END IF
            result1dd(nd0, nd) = (arg1dd(nd0, nd)*2.0*result10-arg1d(nd)&
&             *2.0*result10d(nd0))/(2.0*result10)**2
          END DO
          result1d(nd) = arg1d(nd)/(2.0*result10)
        END IF
        DO nd0=1,nbdirs0
          btpdkhdd(nd0, nd) = 2*result1dd(nd0, nd)/pi
        END DO
        btpdkhd(nd) = 2*result1d(nd)/pi
        IF (xnhk .EQ. 0.0) THEN
          DO nd0=1,nbdirs0
            result1dd(nd0, nd) = 0.D0
          END DO
          result1d(nd) = 0.d0
        ELSE
          result10 = SQRT(xnhk)
          DO nd0=1,nbdirs0
            IF (xnhk .EQ. 0.0) THEN
              result10d(nd0) = 0.D0
            ELSE
              result10d(nd0) = xnhkd0(nd0)/(2.0*SQRT(xnhk))
            END IF
            result1dd(nd0, nd) = (xnhkdd(nd0, nd)*2.0*result10-xnhkd(nd)&
&             *2.0*result10d(nd0))/(2.0*result10)**2
          END DO
          result1d(nd) = xnhkd(nd)/(2.0*result10)
        END IF
        result10 = SQRT(1 - xnhk)
        DO nd0=1,nbdirs0
          result10d(nd0) = -(xnhkd0(nd0)/(2.0*SQRT(1-xnhk)))
          result2dd(nd0, nd) = -((xnhkdd(nd0, nd)*2.0*result10-xnhkd(nd)&
&           *2.0*result10d(nd0))/(2.0*result10)**2)
          arg1dd(nd0, nd) = xnhkdd(nd0, nd)*(1-xnhk) - xnhkd(nd)*xnhkd0(&
&           nd0) - xnhkd0(nd0)*xnhkd(nd) - xnhk*xnhkdd(nd0, nd)
        END DO
        result2d(nd) = -(xnhkd(nd)/(2.0*result10))
        arg1d(nd) = xnhkd(nd)*(1-xnhk) - xnhk*xnhkd(nd)
      END DO
      DO nd0=1,nbdirs0
        btnckhd0(nd0) = 2*(result1d0(nd0)*result2-result2d0(nd0)*result1&
&         )/(result1**2+result2**2)/pi
        IF (arg1 .EQ. 0.0) THEN
          result1d0(nd0) = 0.D0
        ELSE
          result1d0(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
        END IF
        btpdkhd0(nd0) = 2*result1d0(nd0)/pi
        IF (xnhk .EQ. 0.0) THEN
          result1d0(nd0) = 0.D0
        ELSE
          result1d0(nd0) = xnhkd0(nd0)/(2.0*SQRT(xnhk))
        END IF
        result2d0(nd0) = -(xnhkd0(nd0)/(2.0*SQRT(1-xnhk)))
        arg1d0(nd0) = xnhkd0(nd0)*(1-xnhk) - xnhk*xnhkd0(nd0)
      END DO
      btnckh = 2*ATAN2(result1, result2)/pi
      result1 = SQRT(arg1)
      btpdkh = 2*result1/pi
      result1 = SQRT(xnhk)
      result2 = SQRT(1 - xnhk)
      arg1 = xnhk*(1-xnhk)
      DO nd0=1,nbdirs0
        btnchkdd(nd0, :) = 0.D0
        btpdhkdd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          btnchkdd(nd0, nd) = (2*(result1dd(nd0, nd)*result2+result1d(nd&
&           )*result2d0(nd0)-result2dd(nd0, nd)*result1-result2d(nd)*&
&           result1d0(nd0))*(result1**2+result2**2)-2*(result1d(nd)*&
&           result2-result2d(nd)*result1)*(2*result1*result1d0(nd0)+2*&
&           result2*result2d0(nd0)))/(result1**2+result2**2)**2/pi
        END DO
        btnchkd(nd) = 2*(result1d(nd)*result2-result2d(nd)*result1)/(&
&         result1**2+result2**2)/pi
        IF (arg1 .EQ. 0.0) THEN
          DO nd0=1,nbdirs0
            result1dd(nd0, nd) = 0.D0
          END DO
          result1d(nd) = 0.d0
        ELSE
          result10 = SQRT(arg1)
          DO nd0=1,nbdirs0
            IF (arg1 .EQ. 0.0) THEN
              result10d(nd0) = 0.D0
            ELSE
              result10d(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
            END IF
            result1dd(nd0, nd) = (arg1dd(nd0, nd)*2.0*result10-arg1d(nd)&
&             *2.0*result10d(nd0))/(2.0*result10)**2
          END DO
          result1d(nd) = arg1d(nd)/(2.0*result10)
        END IF
        DO nd0=1,nbdirs0
          btpdhkdd(nd0, nd) = 2*result1dd(nd0, nd)/pi
        END DO
        btpdhkd(nd) = 2*result1d(nd)/pi
      END DO
      DO nd0=1,nbdirs0
        btnchkd0(nd0) = 2*(result1d0(nd0)*result2-result2d0(nd0)*result1&
&         )/(result1**2+result2**2)/pi
        IF (arg1 .EQ. 0.0) THEN
          result1d0(nd0) = 0.D0
        ELSE
          result1d0(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
        END IF
        btpdhkd0(nd0) = 2*result1d0(nd0)/pi
      END DO
      btnchk = 2*ATAN2(result1, result2)/pi
      result1 = SQRT(arg1)
      btpdhk = 2*result1/pi
      DO j=1,nu/2
        DO nd=1,nbdirs
          DO nd0=1,nbdirs0
            bvtdd(nd0, nd) = bvtdd(nd0, nd) + gmphdd(nd0, nd)*(1+ks*&
&             btnckh) + gmphd(nd)*ks*btnckhd0(nd0) + ks*(gmphd0(nd0)*&
&             btnckhd(nd)+gmph*btnckhdd(nd0, nd))
            bvtdd(nd0, nd) = bvtdd(nd0, nd) + gmpkdd(nd0, nd)*(1+hs*&
&             btnchk) + gmpkd(nd)*hs*btnchkd0(nd0) + hs*(gmpkd0(nd0)*&
&             btnchkd(nd)+gmpk*btnchkdd(nd0, nd))
            btnckhdd(nd0, nd) = btnckhdd(nd0, nd) + btpdkhdd(nd0, nd)
            btpdkhdd(nd0, nd) = 2*j*(btpdkhdd(nd0, nd)*(1-xnkh)-btpdkhd(&
&             nd)*xnkhd0(nd0)-btpdkhd0(nd0)*xnkhd(nd)-btpdkh*xnkhdd(nd0&
&             , nd))/(2*j+1)
            btnchkdd(nd0, nd) = btnchkdd(nd0, nd) + btpdhkdd(nd0, nd)
            btpdhkdd(nd0, nd) = 2*j*(btpdhkdd(nd0, nd)*(1-xnhk)-btpdhkd(&
&             nd)*xnhkd0(nd0)-btpdhkd0(nd0)*xnhkd(nd)-btpdhk*xnhkdd(nd0&
&             , nd))/(2*j+1)
            gmphdd(nd0, nd) = (((2*j-1)*2*j*(gmphdd(nd0, nd)*(1+dh**2/nu&
&             )+gmphd(nd)*2*dh*dhd0(nd0)/nu)-(2*j-1)*2**2*j*((gmphd0(nd0&
&             )*dh+gmph*dhd0(nd0))*dhd(nd)+gmph*dh*dhdd(nd0, nd))/nu)*2&
&             **2*j**2*(1+dh**2/nu)**2-((2*j-1)*gmphd(nd)*2*j*(1+dh**2/&
&             nu)-gmph*(2*j-1)*2**2*j*dh*dhd(nd)/nu)*2**4*j**2*(1+dh**2/&
&             nu)*dh*dhd0(nd0)/nu)/((2*j*(1+dh**2/nu))**2)**2
            gmpkdd(nd0, nd) = (((2*j-1)*2*j*(gmpkdd(nd0, nd)*(1+dk**2/nu&
&             )+gmpkd(nd)*2*dk*dkd0(nd0)/nu)-(2*j-1)*2**2*j*((gmpkd0(nd0&
&             )*dk+gmpk*dkd0(nd0))*dkd(nd)+gmpk*dk*dkdd(nd0, nd))/nu)*2&
&             **2*j**2*(1+dk**2/nu)**2-((2*j-1)*gmpkd(nd)*2*j*(1+dk**2/&
&             nu)-gmpk*(2*j-1)*2**2*j*dk*dkd(nd)/nu)*2**4*j**2*(1+dk**2/&
&             nu)*dk*dkd0(nd0)/nu)/((2*j*(1+dk**2/nu))**2)**2
          END DO
          bvtd(nd) = bvtd(nd) + gmphd(nd)*(1+ks*btnckh) + gmph*ks*&
&           btnckhd(nd)
          bvtd(nd) = bvtd(nd) + gmpkd(nd)*(1+hs*btnchk) + gmpk*hs*&
&           btnchkd(nd)
          btnckhd(nd) = btnckhd(nd) + btpdkhd(nd)
          btpdkhd(nd) = 2*j*(btpdkhd(nd)*(1-xnkh)-btpdkh*xnkhd(nd))/(2*j&
&           +1)
          btnchkd(nd) = btnchkd(nd) + btpdhkd(nd)
          btpdhkd(nd) = 2*j*(btpdhkd(nd)*(1-xnhk)-btpdhk*xnhkd(nd))/(2*j&
&           +1)
          gmphd(nd) = ((2*j-1)*gmphd(nd)*2*j*(1+dh**2/nu)-gmph*(2*j-1)*2&
&           **2*j*dh*dhd(nd)/nu)/(2*j*(1+dh**2/nu))**2
          gmpkd(nd) = ((2*j-1)*gmpkd(nd)*2*j*(1+dk**2/nu)-gmpk*(2*j-1)*2&
&           **2*j*dk*dkd(nd)/nu)/(2*j*(1+dk**2/nu))**2
        END DO
        DO nd0=1,nbdirs0
          bvtd0(nd0) = bvtd0(nd0) + gmphd0(nd0)*(1+ks*btnckh) + gmph*ks*&
&           btnckhd0(nd0)
          bvtd0(nd0) = bvtd0(nd0) + gmpkd0(nd0)*(1+hs*btnchk) + gmpk*hs*&
&           btnchkd0(nd0)
          btnckhd0(nd0) = btnckhd0(nd0) + btpdkhd0(nd0)
          btpdkhd0(nd0) = 2*j*(btpdkhd0(nd0)*(1-xnkh)-btpdkh*xnkhd0(nd0)&
&           )/(2*j+1)
          btnchkd0(nd0) = btnchkd0(nd0) + btpdhkd0(nd0)
          btpdhkd0(nd0) = 2*j*(btpdhkd0(nd0)*(1-xnhk)-btpdhk*xnhkd0(nd0)&
&           )/(2*j+1)
          gmphd0(nd0) = ((2*j-1)*gmphd0(nd0)*2*j*(1+dh**2/nu)-gmph*(2*j-&
&           1)*2**2*j*dh*dhd0(nd0)/nu)/(2*j*(1+dh**2/nu))**2
          gmpkd0(nd0) = ((2*j-1)*gmpkd0(nd0)*2*j*(1+dk**2/nu)-gmpk*(2*j-&
&           1)*2**2*j*dk*dkd0(nd0)/nu)/(2*j*(1+dk**2/nu))**2
        END DO
        bvt = bvt + gmph*(1+ks*btnckh)
        bvt = bvt + gmpk*(1+hs*btnchk)
        btnckh = btnckh + btpdkh
        btpdkh = 2*j*btpdkh*(1-xnkh)/(2*j+1)
        btnchk = btnchk + btpdhk
        btpdhk = 2*j*btpdhk*(1-xnhk)/(2*j+1)
        gmph = gmph*(2*j-1)/(2*j*(1+dh**2/nu))
        gmpk = gmpk*(2*j-1)/(2*j*(1+dk**2/nu))
      END DO
      DO nd0=1,nbdirs0
        bvtldd(nd0, :) = 0.D0
      END DO
    ELSE
      arg1 = dh**2 + dk**2 - 2*r*dh*dk + nu*ors
      DO nd0=1,nbdirs0
        arg1d0(nd0) = 2*dh*dhd0(nd0) + 2*dk*dkd0(nd0) - 2*((rd0(nd0)*dh+&
&         r*dhd0(nd0))*dk) - 2*(r*dh*dkd0(nd0)) + nu*orsd0(nd0)
        IF (arg1 .EQ. 0.0) THEN
          qhrkd0(nd0) = 0.D0
        ELSE
          qhrkd0(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
        END IF
        hkrnd0(nd0) = dhd0(nd0)*dk + dh*dkd0(nd0) + nu*rd0(nd0)
        hknd0(nd0) = dhd0(nd0)*dk + dh*dkd0(nd0)
        hpkd0(nd0) = dhd0(nd0) + dkd0(nd0)
      END DO
      qhrk = SQRT(arg1)
      hkrn = dh*dk + r*nu
      hkn = dh*dk - nu
      hpk = dh + dk
      DO nd0=1,nbdirs0
        hkndd(nd0, :) = 0.D0
        qhrkdd(nd0, :) = 0.D0
        arg1dd(nd0, :) = 0.D0
        hpkdd(nd0, :) = 0.D0
        arg2dd(nd0, :) = 0.D0
        hkrndd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          arg1dd(nd0, nd) = 2*(dhd0(nd0)*dhd(nd)) + 2*(dh*dhdd(nd0, nd))&
&           + 2*(dkd0(nd0)*dkd(nd)) + 2*(dk*dkdd(nd0, nd)) - 2*((rdd(nd0&
&           , nd)*dh+rd(nd)*dhd0(nd0)+rd0(nd0)*dhd(nd)+r*dhdd(nd0, nd))*&
&           dk) - 2*((rd(nd)*dh+r*dhd(nd))*dkd0(nd0)) - 2*((rd0(nd0)*dh+&
&           r*dhd0(nd0))*dkd(nd)) - 2*(r*dh*dkdd(nd0, nd)) + nu*orsdd(&
&           nd0, nd)
        END DO
        arg1d(nd) = 2*dh*dhd(nd) + 2*dk*dkd(nd) - 2*((rd(nd)*dh+r*dhd(nd&
&         ))*dk) - 2*(r*dh*dkd(nd)) + nu*orsd(nd)
        IF (arg1 .EQ. 0.0) THEN
          DO nd0=1,nbdirs0
            qhrkdd(nd0, nd) = 0.D0
          END DO
          qhrkd(nd) = 0.d0
        ELSE
          result10 = SQRT(arg1)
          DO nd0=1,nbdirs0
            IF (arg1 .EQ. 0.0) THEN
              result10d(nd0) = 0.D0
            ELSE
              result10d(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
            END IF
            qhrkdd(nd0, nd) = (arg1dd(nd0, nd)*2.0*result10-arg1d(nd)*&
&             2.0*result10d(nd0))/(2.0*result10)**2
          END DO
          qhrkd(nd) = arg1d(nd)/(2.0*result10)
        END IF
        hkrnd(nd) = dhd(nd)*dk + dh*dkd(nd) + nu*rd(nd)
        hknd(nd) = dhd(nd)*dk + dh*dkd(nd)
        hpkd(nd) = dhd(nd) + dkd(nd)
        DO nd0=1,nbdirs0
          hkrndd(nd0, nd) = dhdd(nd0, nd)*dk + dhd(nd)*dkd0(nd0) + dhd0(&
&           nd0)*dkd(nd) + dh*dkdd(nd0, nd) + nu*rdd(nd0, nd)
          hkndd(nd0, nd) = dhdd(nd0, nd)*dk + dhd(nd)*dkd0(nd0) + dhd0(&
&           nd0)*dkd(nd) + dh*dkdd(nd0, nd)
          hpkdd(nd0, nd) = dhdd(nd0, nd) + dkdd(nd0, nd)
          arg1dd(nd0, nd) = -(snu*(hkndd(nd0, nd)*qhrk+hknd(nd)*qhrkd0(&
&           nd0)+hknd0(nd0)*qhrkd(nd)+hkn*qhrkdd(nd0, nd)+hpkdd(nd0, nd)&
&           *hkrn+hpkd(nd)*hkrnd0(nd0)+hpkd0(nd0)*hkrnd(nd)+hpk*hkrndd(&
&           nd0, nd)))
          arg2dd(nd0, nd) = hkndd(nd0, nd)*hkrn + hknd(nd)*hkrnd0(nd0) +&
&           hknd0(nd0)*hkrnd(nd) + hkn*hkrndd(nd0, nd) - nu*(hpkdd(nd0, &
&           nd)*qhrk+hpkd(nd)*qhrkd0(nd0)+hpkd0(nd0)*qhrkd(nd)+hpk*&
&           qhrkdd(nd0, nd))
        END DO
        arg1d(nd) = -(snu*(hknd(nd)*qhrk+hkn*qhrkd(nd)+hpkd(nd)*hkrn+hpk&
&         *hkrnd(nd)))
        arg2d(nd) = hknd(nd)*hkrn + hkn*hkrnd(nd) - nu*(hpkd(nd)*qhrk+&
&         hpk*qhrkd(nd))
      END DO
      DO nd0=1,nbdirs0
        arg1d0(nd0) = -(snu*(hknd0(nd0)*qhrk+hkn*qhrkd0(nd0)+hpkd0(nd0)*&
&         hkrn+hpk*hkrnd0(nd0)))
        arg2d0(nd0) = hknd0(nd0)*hkrn + hkn*hkrnd0(nd0) - nu*(hpkd0(nd0)&
&         *qhrk+hpk*qhrkd0(nd0))
      END DO
      arg1 = -(snu*(hkn*qhrk+hpk*hkrn))
      arg2 = hkn*hkrn - nu*hpk*qhrk
      DO nd0=1,nbdirs0
        bvtdd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          bvtdd(nd0, nd) = ((arg1dd(nd0, nd)*arg2+arg1d(nd)*arg2d0(nd0)-&
&           arg2dd(nd0, nd)*arg1-arg2d(nd)*arg1d0(nd0))*(arg1**2+arg2**2&
&           )-(arg1d(nd)*arg2-arg2d(nd)*arg1)*(2*arg1*arg1d0(nd0)+2*arg2&
&           *arg2d0(nd0)))/(arg1**2+arg2**2)**2/tpi
        END DO
        bvtd(nd) = (arg1d(nd)*arg2-arg2d(nd)*arg1)/(arg1**2+arg2**2)/tpi
      END DO
      DO nd0=1,nbdirs0
        bvtd0(nd0) = (arg1d0(nd0)*arg2-arg2d0(nd0)*arg1)/(arg1**2+arg2**&
&         2)/tpi
      END DO
      bvt = ATAN2(arg1, arg2)/tpi
      IF (bvt .LT. -eps) THEN
        bvt = bvt + 1
        DO nd0=1,nbdirs0
          btnckhdd(nd0, :) = 0.D0
          btnchkdd(nd0, :) = 0.D0
          gmpkdd(nd0, :) = 0.D0
          gmphdd(nd0, :) = 0.D0
          btpdkhdd(nd0, :) = 0.D0
          btpdhkdd(nd0, :) = 0.D0
        END DO
      ELSE
        DO nd0=1,nbdirs0
          btnckhdd(nd0, :) = 0.D0
          btnchkdd(nd0, :) = 0.D0
          gmpkdd(nd0, :) = 0.D0
          gmphdd(nd0, :) = 0.D0
          btpdkhdd(nd0, :) = 0.D0
          btpdhkdd(nd0, :) = 0.D0
        END DO
      END IF
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          gmphdd(nd0, nd) = ((tpi*snu*(dhdd(nd0, nd)*(1+dh**2/nu)+dhd(nd&
&           )*2*dh*dhd0(nd0)/nu)-tpi*snu*2*(2*dh*dhd0(nd0)*dhd(nd)+dh**2&
&           *dhdd(nd0, nd))/nu)*tpi**2*snu**2*(1+dh**2/nu)**2-(dhd(nd)*&
&           tpi*snu*(1+dh**2/nu)-dh**2*tpi*snu*2*dhd(nd)/nu)*2**2*tpi**2&
&           *snu**2*(1+dh**2/nu)*dh*dhd0(nd0)/nu)/((tpi*snu*(1+dh**2/nu)&
&           )**2)**2
          gmpkdd(nd0, nd) = ((tpi*snu*(dkdd(nd0, nd)*(1+dk**2/nu)+dkd(nd&
&           )*2*dk*dkd0(nd0)/nu)-tpi*snu*2*(2*dk*dkd0(nd0)*dkd(nd)+dk**2&
&           *dkdd(nd0, nd))/nu)*tpi**2*snu**2*(1+dk**2/nu)**2-(dkd(nd)*&
&           tpi*snu*(1+dk**2/nu)-dk**2*tpi*snu*2*dkd(nd)/nu)*2**2*tpi**2&
&           *snu**2*(1+dk**2/nu)*dk*dkd0(nd0)/nu)/((tpi*snu*(1+dk**2/nu)&
&           )**2)**2
        END DO
        gmphd(nd) = (dhd(nd)*tpi*snu*(1+dh**2/nu)-dh**2*tpi*snu*2*dhd(nd&
&         )/nu)/(tpi*snu*(1+dh**2/nu))**2
        gmpkd(nd) = (dkd(nd)*tpi*snu*(1+dk**2/nu)-dk**2*tpi*snu*2*dkd(nd&
&         )/nu)/(tpi*snu*(1+dk**2/nu))**2
        IF (xnkh .EQ. 0.0) THEN
          DO nd0=1,nbdirs0
            btnckhdd(nd0, nd) = 0.D0
          END DO
          btnckhd(nd) = 0.d0
        ELSE
          result10 = SQRT(xnkh)
          DO nd0=1,nbdirs0
            IF (xnkh .EQ. 0.0) THEN
              result10d(nd0) = 0.D0
            ELSE
              result10d(nd0) = xnkhd0(nd0)/(2.0*SQRT(xnkh))
            END IF
            btnckhdd(nd0, nd) = (xnkhdd(nd0, nd)*2.0*result10-xnkhd(nd)*&
&             2.0*result10d(nd0))/(2.0*result10)**2
          END DO
          btnckhd(nd) = xnkhd(nd)/(2.0*result10)
        END IF
        DO nd0=1,nbdirs0
          btpdkhdd(nd0, nd) = btnckhdd(nd0, nd)
        END DO
        btpdkhd(nd) = btnckhd(nd)
        IF (xnhk .EQ. 0.0) THEN
          DO nd0=1,nbdirs0
            btnchkdd(nd0, nd) = 0.D0
          END DO
          btnchkd(nd) = 0.d0
        ELSE
          result10 = SQRT(xnhk)
          DO nd0=1,nbdirs0
            IF (xnhk .EQ. 0.0) THEN
              result10d(nd0) = 0.D0
            ELSE
              result10d(nd0) = xnhkd0(nd0)/(2.0*SQRT(xnhk))
            END IF
            btnchkdd(nd0, nd) = (xnhkdd(nd0, nd)*2.0*result10-xnhkd(nd)*&
&             2.0*result10d(nd0))/(2.0*result10)**2
          END DO
          btnchkd(nd) = xnhkd(nd)/(2.0*result10)
        END IF
        DO nd0=1,nbdirs0
          btpdhkdd(nd0, nd) = btnchkdd(nd0, nd)
        END DO
        btpdhkd(nd) = btnchkd(nd)
      END DO
      DO nd0=1,nbdirs0
        gmphd0(nd0) = (dhd0(nd0)*tpi*snu*(1+dh**2/nu)-dh**2*tpi*snu*2*&
&         dhd0(nd0)/nu)/(tpi*snu*(1+dh**2/nu))**2
        gmpkd0(nd0) = (dkd0(nd0)*tpi*snu*(1+dk**2/nu)-dk**2*tpi*snu*2*&
&         dkd0(nd0)/nu)/(tpi*snu*(1+dk**2/nu))**2
        IF (xnkh .EQ. 0.0) THEN
          btnckhd0(nd0) = 0.D0
        ELSE
          btnckhd0(nd0) = xnkhd0(nd0)/(2.0*SQRT(xnkh))
        END IF
        btpdkhd0(nd0) = btnckhd0(nd0)
        IF (xnhk .EQ. 0.0) THEN
          btnchkd0(nd0) = 0.D0
        ELSE
          btnchkd0(nd0) = xnhkd0(nd0)/(2.0*SQRT(xnhk))
        END IF
        btpdhkd0(nd0) = btnchkd0(nd0)
      END DO
      gmph = dh/(tpi*snu*(1+dh**2/nu))
      gmpk = dk/(tpi*snu*(1+dk**2/nu))
      btnckh = SQRT(xnkh)
      btpdkh = btnckh
      btnchk = SQRT(xnhk)
      btpdhk = btnchk
      DO j=1,(nu-1)/2
        DO nd=1,nbdirs
          DO nd0=1,nbdirs0
            bvtdd(nd0, nd) = bvtdd(nd0, nd) + gmphdd(nd0, nd)*(1+ks*&
&             btnckh) + gmphd(nd)*ks*btnckhd0(nd0) + ks*(gmphd0(nd0)*&
&             btnckhd(nd)+gmph*btnckhdd(nd0, nd))
            bvtdd(nd0, nd) = bvtdd(nd0, nd) + gmpkdd(nd0, nd)*(1+hs*&
&             btnchk) + gmpkd(nd)*hs*btnchkd0(nd0) + hs*(gmpkd0(nd0)*&
&             btnchkd(nd)+gmpk*btnchkdd(nd0, nd))
            btpdkhdd(nd0, nd) = (2*j-1)*(btpdkhdd(nd0, nd)*(1-xnkh)-&
&             btpdkhd(nd)*xnkhd0(nd0)-btpdkhd0(nd0)*xnkhd(nd)-btpdkh*&
&             xnkhdd(nd0, nd))/(2*j)
            btnckhdd(nd0, nd) = btnckhdd(nd0, nd) + btpdkhdd(nd0, nd)
            btpdhkdd(nd0, nd) = (2*j-1)*(btpdhkdd(nd0, nd)*(1-xnhk)-&
&             btpdhkd(nd)*xnhkd0(nd0)-btpdhkd0(nd0)*xnhkd(nd)-btpdhk*&
&             xnhkdd(nd0, nd))/(2*j)
            btnchkdd(nd0, nd) = btnchkdd(nd0, nd) + btpdhkdd(nd0, nd)
            gmphdd(nd0, nd) = ((2*j*(2*j+1)*(gmphdd(nd0, nd)*(1+dh**2/nu&
&             )+gmphd(nd)*2*dh*dhd0(nd0)/nu)-2**2*j*(2*j+1)*((gmphd0(nd0&
&             )*dh+gmph*dhd0(nd0))*dhd(nd)+gmph*dh*dhdd(nd0, nd))/nu)*(2&
&             *j+1)**2*(1+dh**2/nu)**2-(2*j*gmphd(nd)*(2*j+1)*(1+dh**2/&
&             nu)-2**2*j*gmph*(2*j+1)*dh*dhd(nd)/nu)*2**2*(2*j+1)**2*(1+&
&             dh**2/nu)*dh*dhd0(nd0)/nu)/(((2*j+1)*(1+dh**2/nu))**2)**2
            gmpkdd(nd0, nd) = ((2*j*(2*j+1)*(gmpkdd(nd0, nd)*(1+dk**2/nu&
&             )+gmpkd(nd)*2*dk*dkd0(nd0)/nu)-2**2*j*(2*j+1)*((gmpkd0(nd0&
&             )*dk+gmpk*dkd0(nd0))*dkd(nd)+gmpk*dk*dkdd(nd0, nd))/nu)*(2&
&             *j+1)**2*(1+dk**2/nu)**2-(2*j*gmpkd(nd)*(2*j+1)*(1+dk**2/&
&             nu)-2**2*j*gmpk*(2*j+1)*dk*dkd(nd)/nu)*2**2*(2*j+1)**2*(1+&
&             dk**2/nu)*dk*dkd0(nd0)/nu)/(((2*j+1)*(1+dk**2/nu))**2)**2
          END DO
          bvtd(nd) = bvtd(nd) + gmphd(nd)*(1+ks*btnckh) + gmph*ks*&
&           btnckhd(nd)
          bvtd(nd) = bvtd(nd) + gmpkd(nd)*(1+hs*btnchk) + gmpk*hs*&
&           btnchkd(nd)
          btpdkhd(nd) = (2*j-1)*(btpdkhd(nd)*(1-xnkh)-btpdkh*xnkhd(nd))/&
&           (2*j)
          btnckhd(nd) = btnckhd(nd) + btpdkhd(nd)
          btpdhkd(nd) = (2*j-1)*(btpdhkd(nd)*(1-xnhk)-btpdhk*xnhkd(nd))/&
&           (2*j)
          btnchkd(nd) = btnchkd(nd) + btpdhkd(nd)
          gmphd(nd) = (2*j*gmphd(nd)*(2*j+1)*(1+dh**2/nu)-2**2*j*gmph*(2&
&           *j+1)*dh*dhd(nd)/nu)/((2*j+1)*(1+dh**2/nu))**2
          gmpkd(nd) = (2*j*gmpkd(nd)*(2*j+1)*(1+dk**2/nu)-2**2*j*gmpk*(2&
&           *j+1)*dk*dkd(nd)/nu)/((2*j+1)*(1+dk**2/nu))**2
        END DO
        DO nd0=1,nbdirs0
          bvtd0(nd0) = bvtd0(nd0) + gmphd0(nd0)*(1+ks*btnckh) + gmph*ks*&
&           btnckhd0(nd0)
          bvtd0(nd0) = bvtd0(nd0) + gmpkd0(nd0)*(1+hs*btnchk) + gmpk*hs*&
&           btnchkd0(nd0)
          btpdkhd0(nd0) = (2*j-1)*(btpdkhd0(nd0)*(1-xnkh)-btpdkh*xnkhd0(&
&           nd0))/(2*j)
          btnckhd0(nd0) = btnckhd0(nd0) + btpdkhd0(nd0)
          btpdhkd0(nd0) = (2*j-1)*(btpdhkd0(nd0)*(1-xnhk)-btpdhk*xnhkd0(&
&           nd0))/(2*j)
          btnchkd0(nd0) = btnchkd0(nd0) + btpdhkd0(nd0)
          gmphd0(nd0) = (2*j*gmphd0(nd0)*(2*j+1)*(1+dh**2/nu)-2**2*j*&
&           gmph*(2*j+1)*dh*dhd0(nd0)/nu)/((2*j+1)*(1+dh**2/nu))**2
          gmpkd0(nd0) = (2*j*gmpkd0(nd0)*(2*j+1)*(1+dk**2/nu)-2**2*j*&
&           gmpk*(2*j+1)*dk*dkd0(nd0)/nu)/((2*j+1)*(1+dk**2/nu))**2
        END DO
        bvt = bvt + gmph*(1+ks*btnckh)
        bvt = bvt + gmpk*(1+hs*btnchk)
        btpdkh = (2*j-1)*btpdkh*(1-xnkh)/(2*j)
        btnckh = btnckh + btpdkh
        btpdhk = (2*j-1)*btpdhk*(1-xnhk)/(2*j)
        btnchk = btnchk + btpdhk
        gmph = 2*j*gmph/((2*j+1)*(1+dh**2/nu))
        gmpk = 2*j*gmpk/((2*j+1)*(1+dk**2/nu))
      END DO
      DO nd0=1,nbdirs0
        bvtldd(nd0, :) = 0.D0
      END DO
    END IF
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        bvtldd(nd0, nd) = bvtdd(nd0, nd)
      END DO
      bvtld(nd) = bvtd(nd)
    END DO
    DO nd0=1,nbdirs0
      bvtld0(nd0) = bvtd0(nd0)
    END DO
    bvtl = bvt
  END IF
END SUBROUTINE BVTL_DV_DV

!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.13 (r6666M) -  1 Mar 2018 15:30
!
!  Differentiation of phid_dv in forward (tangent) mode (with options multiDirectional i4 dr8 r4):
!   variations   of useful results: phidd phid
!   with respect to varying inputs: phidd z zd
!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.13 (r6666M) -  1 Mar 2018 15:30
!
!  Differentiation of phid in forward (tangent) mode (with options multiDirectional i4 dr8 r4):
!   variations   of useful results: phid
!   with respect to varying inputs: z
!
SUBROUTINE PHID_DV_DV(z, zd0, zd, zdd, phid, phidd0, phidd, phiddd, &
& nbdirs, nbdirs0)
  USE DIFFSIZES
  IMPLICIT NONE
!     
!     Normal distribution probabilities accurate to 1d-15.
!     Reference: J.L. Schonfelder, Math Comp 32(1978), pp 1232-1240. 
!     
  INTEGER :: i, im
  DOUBLE PRECISION :: a(0:43), bm, b, bp, p, rtwo, t, xa, z
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: bmd0, bd0, bpd0, pd0, td0, &
& xad0, zd0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: bmd, bd, bpd, pd, td, xad, &
& zd
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: bmdd, bdd, bpdd&
& , pdd, tdd, xadd, zdd
  PARAMETER (rtwo=1.414213562373095048801688724209d0, im=24)
  SAVE a
  INTRINSIC ABS
  INTRINSIC EXP
  DOUBLE PRECISION :: abs0
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: abs0d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: abs0d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: abs0dd
  DOUBLE PRECISION :: arg1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: arg1d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: arg1d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: arg1dd
  INTEGER :: nd
  DOUBLE PRECISION :: phidd(nbdirsmax)
  DOUBLE PRECISION :: phiddd(nbdirsmax0, nbdirsmax)
  DOUBLE PRECISION :: phid
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: phidd0
  INTEGER :: nbdirs
  INTEGER :: nd0
  INTEGER :: nbdirs0
  DATA (a(i), i=0,43) /6.10143081923200417926465815756d-1, -&
&      4.34841272712577471828182820888d-1, &
&      1.76351193643605501125840298123d-1, -&
&      6.0710795609249414860051215825d-2, &
&      1.7712068995694114486147141191d-2, -&
&      4.321119385567293818599864968d-3, 8.54216676887098678819832055d-4&
&      , -1.27155090609162742628893940d-4, &
&      1.1248167243671189468847072d-5, 3.13063885421820972630152d-7, -&
&      2.70988068537762022009086d-7, 3.0737622701407688440959d-8, &
&      2.515620384817622937314d-9, -1.028929921320319127590d-9, &
&      2.9944052119949939363d-11, 2.6051789687266936290d-11, -&
&      2.634839924171969386d-12, -6.43404509890636443d-13, &
&      1.12457401801663447d-13, 1.7281533389986098d-14, -&
&      4.264101694942375d-15, -5.45371977880191d-16, &
&      1.58697607761671d-16, 2.0899837844334d-17, -5.900526869409d-18, -&
&      9.41893387554d-19, 2.14977356470d-19, 4.6660985008d-20, -&
&      7.243011862d-21, -2.387966824d-21, 1.91177535d-22, 1.20482568d-22&
&      , -6.72377d-25, -5.747997d-24, -4.28493d-25, 2.44856d-25, &
&      4.3793d-26, -8.151d-27, -3.089d-27, 9.3d-29, 1.74d-28, 1.6d-29, -&
&      8.0d-30, -2.0d-30/
  IF (z .GE. 0.) THEN
    DO nd0=1,nbdirs0
      abs0dd(nd0, :) = 0.D0
    END DO
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        abs0dd(nd0, nd) = zdd(nd0, nd)
      END DO
      abs0d(nd) = zd(nd)
    END DO
    DO nd0=1,nbdirs0
      abs0d0(nd0) = zd0(nd0)
    END DO
    abs0 = z
    DO nd0=1,nbdirs0
      xadd(nd0, :) = 0.D0
    END DO
  ELSE
    DO nd0=1,nbdirs0
      abs0dd(nd0, :) = 0.D0
    END DO
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        abs0dd(nd0, nd) = -zdd(nd0, nd)
      END DO
      abs0d(nd) = -zd(nd)
    END DO
    DO nd0=1,nbdirs0
      abs0d0(nd0) = -zd0(nd0)
    END DO
    abs0 = -z
    DO nd0=1,nbdirs0
      xadd(nd0, :) = 0.D0
    END DO
  END IF
  DO nd=1,nbdirs
    DO nd0=1,nbdirs0
!     
      xadd(nd0, nd) = abs0dd(nd0, nd)/rtwo
    END DO
    xad(nd) = abs0d(nd)/rtwo
  END DO
  DO nd0=1,nbdirs0
    xad0(nd0) = abs0d0(nd0)/rtwo
  END DO
  xa = abs0/rtwo
  IF (xa .GT. 100) THEN
    p = 0
    DO nd=1,nbdirs
      pd(nd) = 0.d0
    END DO
    DO nd0=1,nbdirs0
      pd0(nd0) = 0.D0
      pdd(nd0, :) = 0.D0
    END DO
  ELSE
    DO nd0=1,nbdirs0
      tdd(nd0, :) = 0.D0
    END DO
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        tdd(nd0, nd) = ((8*(xadd(nd0, nd)*(4*xa+15))+8*(xad(nd)*4*xad0(&
&         nd0))-4*(8*xad0(nd0)*xad(nd))-4*((8*xa-30)*xadd(nd0, nd)))*(4*&
&         xa+15)**2-(8*xad(nd)*(4*xa+15)-(8*xa-30)*4*xad(nd))*2*(4*xa+15&
&         )*4*xad0(nd0))/((4*xa+15)**2)**2
      END DO
      td(nd) = (8*xad(nd)*(4*xa+15)-(8*xa-30)*4*xad(nd))/(4*xa+15)**2
    END DO
    DO nd0=1,nbdirs0
      td0(nd0) = (8*xad0(nd0)*(4*xa+15)-(8*xa-30)*4*xad0(nd0))/(4*xa+15)&
&       **2
    END DO
    t = (8*xa-30)/(4*xa+15)
    bm = 0
    b = 0
    DO nd=1,nbdirs
      bmd(nd) = 0.d0
      bpd(nd) = 0.d0
      bd(nd) = 0.d0
    END DO
    DO nd0=1,nbdirs0
      bdd(nd0, :) = 0.D0
      bmd0(nd0) = 0.D0
      bpdd(nd0, :) = 0.D0
      bpd0(nd0) = 0.D0
      bmdd(nd0, :) = 0.D0
      bd0(nd0) = 0.D0
    END DO
    DO i=im,0,-1
      DO nd0=1,nbdirs0
        bpd0(nd0) = bd0(nd0)
        bd0(nd0) = bmd0(nd0)
      END DO
      bp = b
      b = bm
      DO nd=1,nbdirs
        bpd(nd) = bd(nd)
        bd(nd) = bmd(nd)
        DO nd0=1,nbdirs0
          bpdd(nd0, nd) = bdd(nd0, nd)
          bdd(nd0, nd) = bmdd(nd0, nd)
          bmdd(nd0, nd) = tdd(nd0, nd)*b + td(nd)*bd0(nd0) + td0(nd0)*bd&
&           (nd) + t*bdd(nd0, nd) - bpdd(nd0, nd)
        END DO
        bmd(nd) = td(nd)*b + t*bd(nd) - bpd(nd)
      END DO
      DO nd0=1,nbdirs0
        bmd0(nd0) = td0(nd0)*b + t*bd0(nd0) - bpd0(nd0)
      END DO
      bm = t*b - bp + a(i)
    END DO
    DO nd0=1,nbdirs0
      arg1d0(nd0) = -(xad0(nd0)*xa+xa*xad0(nd0))
    END DO
    arg1 = -(xa*xa)
    DO nd0=1,nbdirs0
      arg1dd(nd0, :) = 0.D0
      pdd(nd0, :) = 0.D0
    END DO
    DO nd=1,nbdirs
      arg1d(nd) = -(xad(nd)*xa+xa*xad(nd))
      DO nd0=1,nbdirs0
        arg1dd(nd0, nd) = -(xadd(nd0, nd)*xa+xad(nd)*xad0(nd0)+xad0(nd0)&
&         *xad(nd)+xa*xadd(nd0, nd))
        pdd(nd0, nd) = ((arg1dd(nd0, nd)*(bm-bp)+arg1d(nd)*(bmd0(nd0)-&
&         bpd0(nd0)))*EXP(arg1)+arg1d(nd)*(bm-bp)*arg1d0(nd0)*EXP(arg1)+&
&         arg1d0(nd0)*EXP(arg1)*(bmd(nd)-bpd(nd))+EXP(arg1)*(bmdd(nd0, &
&         nd)-bpdd(nd0, nd)))/4
      END DO
      pd(nd) = (arg1d(nd)*EXP(arg1)*(bm-bp)+EXP(arg1)*(bmd(nd)-bpd(nd)))&
&       /4
    END DO
    DO nd0=1,nbdirs0
      pd0(nd0) = (arg1d0(nd0)*EXP(arg1)*(bm-bp)+EXP(arg1)*(bmd0(nd0)-&
&       bpd0(nd0)))/4
    END DO
    p = EXP(arg1)*(bm-bp)/4
  END IF
  IF (z .GT. 0) THEN
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        pdd(nd0, nd) = -pdd(nd0, nd)
      END DO
      pd(nd) = -pd(nd)
    END DO
    DO nd0=1,nbdirs0
      pd0(nd0) = -pd0(nd0)
    END DO
    p = 1 - p
  END IF
  DO nd=1,nbdirs
    DO nd0=1,nbdirs0
      phiddd(nd0, nd) = pdd(nd0, nd)
    END DO
    phidd(nd) = pd(nd)
  END DO
  DO nd0=1,nbdirs0
    phidd0(nd0) = pd0(nd0)
  END DO
  phid = p
END SUBROUTINE PHID_DV_DV

!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.13 (r6666M) -  1 Mar 2018 15:30
!
!  Differentiation of bvnd_dv in forward (tangent) mode (with options multiDirectional i4 dr8 r4):
!   variations   of useful results: bvndd bvnd
!   with respect to varying inputs: dh bvndd dk r dkd dhd rd
!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.13 (r6666M) -  1 Mar 2018 15:30
!
!  Differentiation of bvnd in forward (tangent) mode (with options multiDirectional i4 dr8 r4):
!   variations   of useful results: bvnd
!   with respect to varying inputs: dh dk r
!
SUBROUTINE BVND_DV_DV(dh, dhd0, dhd, dhdd, dk, dkd0, dkd, dkdd, r, rd0, &
& rd, rdd, bvnd, bvndd0, bvndd, bvnddd, nbdirs, nbdirs0)
  USE DIFFSIZES
  IMPLICIT NONE
!
!     A function for computing bivariate normal probabilities.
!
!       Alan Genz
!       Department of Mathematics
!       Washington State University
!       Pullman, WA 99164-3113
!       Email : alangenz@wsu.edu
!
!    This function is based on the method described by 
!        Drezner, Z and G.O. Wesolowsky, (1989),
!        On the computation of the bivariate normal integral,
!        Journal of Statist. Comput. Simul. 35, pp. 101-107,
!    with major modifications for double precision, and for |R| close to 1.
!
! BVND calculates the probability that X > DH and Y > DK.
!      Note: Prob( X < DH, Y < DK ) = BVND( -DH, -DK, R ).
!
! Parameters
!
!   DH  DOUBLE PRECISION, integration limit
!   DK  DOUBLE PRECISION, integration limit
!   R   DOUBLE PRECISION, correlation coefficient
!
  DOUBLE PRECISION :: dh, dk, r, twopi
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: dhd0, dkd0, rd0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: dhd, dkd, rd
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: dhdd, dkdd, rdd
  INTEGER :: i, is, lg, ng
  PARAMETER (twopi=6.283185307179586d0)
  DOUBLE PRECISION :: x(10, 3), w(10, 3), as, a, b, c, d, rs, xs, bvn
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: asd0, ad0, bd0, cd0, dd0, &
& rsd0, xsd0, bvnd1
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: asd, ad, bd, cd, dd, rsd, &
& xsd, bvnd0
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: asdd, add, bdd, &
& cdd, ddd, rsdd, xsdd, bvnd0d
  DOUBLE PRECISION :: phid, sn, asr, h, k, bs, hs, hk
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: snd0, asrd0, hd0, kd0, bsd0&
& , hsd0, hkd0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: snd, asrd, hd, kd, bsd, hsd&
& , hkd
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: sndd, asrdd, hdd&
& , kdd, bsdd, hsdd, hkdd
  SAVE x, w
  INTRINSIC ABS
  INTRINSIC ASIN
  INTRINSIC SIN
  INTRINSIC EXP
  INTRINSIC SQRT
  INTRINSIC MAX
  DOUBLE PRECISION :: abs0
  DOUBLE PRECISION :: abs1
  DOUBLE PRECISION :: abs2
  DOUBLE PRECISION :: abs3
  DOUBLE PRECISION :: abs4
  DOUBLE PRECISION :: max1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: max1d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: max1d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: max1dd
  DOUBLE PRECISION :: arg1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: arg1d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: arg1d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: arg1dd
  DOUBLE PRECISION :: result1
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: result1d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: result1d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: result1dd
  DOUBLE PRECISION :: result2
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: result2d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: result2d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: result2dd
  DOUBLE PRECISION :: arg2
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: arg2d0
  DOUBLE PRECISION, DIMENSION(nbdirsmax) :: arg2d
  DOUBLE PRECISION, DIMENSION(nbdirsmax0, nbdirsmax) :: arg2dd
  INTEGER :: nd
  DOUBLE PRECISION :: bvndd(nbdirsmax)
  DOUBLE PRECISION :: bvnddd(nbdirsmax0, nbdirsmax)
  DOUBLE PRECISION :: bvnd
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: bvndd0
  INTEGER :: nbdirs
  INTRINSIC COS
  DOUBLE PRECISION :: arg10
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: arg10d
  DOUBLE PRECISION :: result10
  DOUBLE PRECISION, DIMENSION(nbdirsmax0) :: result10d
  INTEGER :: nd0
  INTEGER :: nbdirs0
!     Gauss Legendre Points and Weights, N =  6
  DATA (w(i, 1), x(i, 1), i=1,3) /0.1713244923791705d+00, -&
&      0.9324695142031522d+00, 0.3607615730481384d+00, -&
&      0.6612093864662647d+00, 0.4679139345726904d+00, -&
&      0.2386191860831970d+00/
!     Gauss Legendre Points and Weights, N = 12
  DATA (w(i, 2), x(i, 2), i=1,6) /0.4717533638651177d-01, -&
&      0.9815606342467191d+00, 0.1069393259953183d+00, -&
&      0.9041172563704750d+00, 0.1600783285433464d+00, -&
&      0.7699026741943050d+00, 0.2031674267230659d+00, -&
&      0.5873179542866171d+00, 0.2334925365383547d+00, -&
&      0.3678314989981802d+00, 0.2491470458134029d+00, -&
&      0.1252334085114692d+00/
!     Gauss Legendre Points and Weights, N = 20
  DATA (w(i, 3), x(i, 3), i=1,10) /0.1761400713915212d-01, -&
&      0.9931285991850949d+00, 0.4060142980038694d-01, -&
&      0.9639719272779138d+00, 0.6267204833410906d-01, -&
&      0.9122344282513259d+00, 0.8327674157670475d-01, -&
&      0.8391169718222188d+00, 0.1019301198172404d+00, -&
&      0.7463319064601508d+00, 0.1181945319615184d+00, -&
&      0.6360536807265150d+00, 0.1316886384491766d+00, -&
&      0.5108670019508271d+00, 0.1420961093183821d+00, -&
&      0.3737060887154196d+00, 0.1491729864726037d+00, -&
&      0.2277858511416451d+00, 0.1527533871307259d+00, -&
&      0.7652652113349733d-01/
  IF (r .GE. 0.) THEN
    abs0 = r
  ELSE
    abs0 = -r
  END IF
  IF (abs0 .LT. 0.3) THEN
    ng = 1
    lg = 3
  ELSE
    IF (r .GE. 0.) THEN
      abs1 = r
    ELSE
      abs1 = -r
    END IF
    IF (abs1 .LT. 0.75) THEN
      ng = 2
      lg = 6
    ELSE
      ng = 3
      lg = 10
    END IF
  END IF
  DO nd0=1,nbdirs0
    hd0(nd0) = dhd0(nd0)
    kd0(nd0) = dkd0(nd0)
  END DO
  h = dh
  k = dk
  DO nd0=1,nbdirs0
    kdd(nd0, :) = 0.D0
    hdd(nd0, :) = 0.D0
    hkdd(nd0, :) = 0.D0
  END DO
  DO nd=1,nbdirs
    hd(nd) = dhd(nd)
    kd(nd) = dkd(nd)
    DO nd0=1,nbdirs0
      hdd(nd0, nd) = dhdd(nd0, nd)
      kdd(nd0, nd) = dkdd(nd0, nd)
      hkdd(nd0, nd) = hdd(nd0, nd)*k + hd(nd)*kd0(nd0) + hd0(nd0)*kd(nd)&
&       + h*kdd(nd0, nd)
    END DO
    hkd(nd) = hd(nd)*k + h*kd(nd)
  END DO
  DO nd0=1,nbdirs0
    hkd0(nd0) = hd0(nd0)*k + h*kd0(nd0)
  END DO
  hk = h*k
  bvn = 0
  IF (r .GE. 0.) THEN
    abs2 = r
  ELSE
    abs2 = -r
  END IF
  IF (abs2 .LT. 0.925) THEN
    IF (r .GE. 0.) THEN
      abs3 = r
    ELSE
      abs3 = -r
    END IF
    IF (abs3 .GT. 0) THEN
      DO nd0=1,nbdirs0
        hsdd(nd0, :) = 0.D0
        asrdd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          hsdd(nd0, nd) = (hdd(nd0, nd)*h+hd(nd)*hd0(nd0)+hd0(nd0)*hd(nd&
&           )+h*hdd(nd0, nd)+kdd(nd0, nd)*k+kd(nd)*kd0(nd0)+kd0(nd0)*kd(&
&           nd)+k*kdd(nd0, nd))/2
        END DO
        hsd(nd) = (hd(nd)*h+h*hd(nd)+kd(nd)*k+k*kd(nd))/2
        IF (r .EQ. 1.0 .OR. r .EQ. -1.0) THEN
          DO nd0=1,nbdirs0
            asrdd(nd0, nd) = 0.D0
          END DO
          asrd(nd) = 0.d0
        ELSE
          arg10 = 1.0 - r**2
          result10 = SQRT(arg10)
          DO nd0=1,nbdirs0
            arg10d(nd0) = -(2*r*rd0(nd0))
            IF (arg10 .EQ. 0.0) THEN
              result10d(nd0) = 0.D0
            ELSE
              result10d(nd0) = arg10d(nd0)/(2.0*SQRT(arg10))
            END IF
            asrdd(nd0, nd) = (rdd(nd0, nd)*result10-rd(nd)*result10d(nd0&
&             ))/result10**2
          END DO
          asrd(nd) = rd(nd)/result10
        END IF
      END DO
      DO nd0=1,nbdirs0
        hsd0(nd0) = (hd0(nd0)*h+h*hd0(nd0)+kd0(nd0)*k+k*kd0(nd0))/2
        IF (r .EQ. 1.0 .OR. r .EQ. (-1.0)) THEN
          asrd0(nd0) = 0.D0
        ELSE
          asrd0(nd0) = rd0(nd0)/SQRT(1.0-r**2)
        END IF
      END DO
      hs = (h*h+k*k)/2
      asr = ASIN(r)
      DO nd=1,nbdirs
        bvnd0(nd) = 0.d0
      END DO
      DO nd0=1,nbdirs0
        arg1dd(nd0, :) = 0.D0
        sndd(nd0, :) = 0.D0
        bvnd1(nd0) = 0.D0
        bvnd0d(nd0, :) = 0.D0
      END DO
      DO i=1,lg
        DO is=-1,1,2
          arg1 = asr*(is*x(i, ng)+1)/2
          DO nd0=1,nbdirs0
            arg1d0(nd0) = (is*x(i, ng)+1)*asrd0(nd0)/2
            snd0(nd0) = arg1d0(nd0)*COS(arg1)
          END DO
          sn = SIN(arg1)
          DO nd=1,nbdirs
            arg1d(nd) = (is*x(i, ng)+1)*asrd(nd)/2
            snd(nd) = arg1d(nd)*COS(arg1)
            DO nd0=1,nbdirs0
              arg1dd(nd0, nd) = (is*x(i, ng)+1)*asrdd(nd0, nd)/2
              sndd(nd0, nd) = arg1dd(nd0, nd)*COS(arg1) - arg1d(nd)*&
&               arg1d0(nd0)*SIN(arg1)
              arg1dd(nd0, nd) = (((sndd(nd0, nd)*hk+snd(nd)*hkd0(nd0)+&
&               snd0(nd0)*hkd(nd)+sn*hkdd(nd0, nd)-hsdd(nd0, nd))*(1-sn*&
&               sn)+(snd(nd)*hk+sn*hkd(nd)-hsd(nd))*(-(snd0(nd0)*sn)-sn*&
&               snd0(nd0))-(snd0(nd0)*hk+sn*hkd0(nd0)-hsd0(nd0))*(-(snd(&
&               nd)*sn)-sn*snd(nd))-(sn*hk-hs)*(-(sndd(nd0, nd)*sn)-snd(&
&               nd)*snd0(nd0)-snd0(nd0)*snd(nd)-sn*sndd(nd0, nd)))*(1-sn&
&               *sn)**2-((snd(nd)*hk+sn*hkd(nd)-hsd(nd))*(1-sn*sn)-(sn*&
&               hk-hs)*(-(snd(nd)*sn)-sn*snd(nd)))*2*(1-sn*sn)*(-(snd0(&
&               nd0)*sn)-sn*snd0(nd0)))/((1-sn*sn)**2)**2
            END DO
            arg1d(nd) = ((snd(nd)*hk+sn*hkd(nd)-hsd(nd))*(1-sn*sn)-(sn*&
&             hk-hs)*(-(snd(nd)*sn)-sn*snd(nd)))/(1-sn*sn)**2
          END DO
          DO nd0=1,nbdirs0
            arg1d0(nd0) = ((snd0(nd0)*hk+sn*hkd0(nd0)-hsd0(nd0))*(1-sn*&
&             sn)-(sn*hk-hs)*(-(snd0(nd0)*sn)-sn*snd0(nd0)))/(1-sn*sn)**&
&             2
          END DO
          arg1 = (sn*hk-hs)/(1-sn*sn)
          DO nd=1,nbdirs
            DO nd0=1,nbdirs0
              bvnd0d(nd0, nd) = bvnd0d(nd0, nd) + w(i, ng)*(arg1dd(nd0, &
&               nd)*EXP(arg1)+arg1d(nd)*arg1d0(nd0)*EXP(arg1))
            END DO
            bvnd0(nd) = bvnd0(nd) + w(i, ng)*arg1d(nd)*EXP(arg1)
          END DO
          DO nd0=1,nbdirs0
            bvnd1(nd0) = bvnd1(nd0) + w(i, ng)*arg1d0(nd0)*EXP(arg1)
          END DO
          bvn = bvn + w(i, ng)*EXP(arg1)
        END DO
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          bvnd0d(nd0, nd) = (bvnd0d(nd0, nd)*asr+bvnd0(nd)*asrd0(nd0)+&
&           bvnd1(nd0)*asrd(nd)+bvn*asrdd(nd0, nd))/(2*twopi)
        END DO
        bvnd0(nd) = (bvnd0(nd)*asr+bvn*asrd(nd))/(2*twopi)
      END DO
      DO nd0=1,nbdirs0
        bvnd1(nd0) = (bvnd1(nd0)*asr+bvn*asrd0(nd0))/(2*twopi)
      END DO
      bvn = bvn*asr/(2*twopi)
    ELSE
      DO nd=1,nbdirs
        bvnd0(nd) = 0.d0
      END DO
      DO nd0=1,nbdirs0
        bvnd1(nd0) = 0.D0
        bvnd0d(nd0, :) = 0.D0
      END DO
    END IF
    DO nd0=1,nbdirs0
      result1dd(nd0, :) = 0.D0
      result2dd(nd0, :) = 0.D0
    END DO
    CALL PHID_DV_DV(-h, -hd0, -hd, -hdd, result1, result1d0, result1d, &
&             result1dd, nbdirs, nbdirs0)
    CALL PHID_DV_DV(-k, -kd0, -kd, -kdd, result2, result2d0, result2d, &
&             result2dd, nbdirs, nbdirs0)
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        bvnd0d(nd0, nd) = bvnd0d(nd0, nd) + result1dd(nd0, nd)*result2 +&
&         result1d(nd)*result2d0(nd0) + result1d0(nd0)*result2d(nd) + &
&         result1*result2dd(nd0, nd)
      END DO
      bvnd0(nd) = bvnd0(nd) + result1d(nd)*result2 + result1*result2d(nd&
&       )
    END DO
    DO nd0=1,nbdirs0
      bvnd1(nd0) = bvnd1(nd0) + result1d0(nd0)*result2 + result1*&
&       result2d0(nd0)
    END DO
    bvn = bvn + result1*result2
  ELSE
    IF (r .LT. 0) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          kdd(nd0, nd) = -kdd(nd0, nd)
          hkdd(nd0, nd) = -hkdd(nd0, nd)
        END DO
        kd(nd) = -kd(nd)
        hkd(nd) = -hkd(nd)
      END DO
      DO nd0=1,nbdirs0
        kd0(nd0) = -kd0(nd0)
        hkd0(nd0) = -hkd0(nd0)
      END DO
      k = -k
      hk = -hk
    END IF
    IF (r .GE. 0.) THEN
      abs4 = r
    ELSE
      abs4 = -r
    END IF
    IF (abs4 .LT. 1) THEN
      DO nd0=1,nbdirs0
        asd0(nd0) = (1-r)*rd0(nd0) - rd0(nd0)*(1+r)
        bsd0(nd0) = 2*(h-k)*(hd0(nd0)-kd0(nd0))
      END DO
      as = (1-r)*(1+r)
      bs = (h-k)**2
      DO nd0=1,nbdirs0
        ddd(nd0, :) = 0.D0
        add(nd0, :) = 0.D0
        bsdd(nd0, :) = 0.D0
        cdd(nd0, :) = 0.D0
        asrdd(nd0, :) = 0.D0
        asdd(nd0, :) = 0.D0
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          asdd(nd0, nd) = (1-r)*rdd(nd0, nd) - rd0(nd0)*rd(nd) - rdd(nd0&
&           , nd)*(1+r) - rd(nd)*rd0(nd0)
        END DO
        asd(nd) = (1-r)*rd(nd) - rd(nd)*(1+r)
        IF (as .EQ. 0.0) THEN
          DO nd0=1,nbdirs0
            add(nd0, nd) = 0.D0
          END DO
          ad(nd) = 0.d0
        ELSE
          result10 = SQRT(as)
          DO nd0=1,nbdirs0
            IF (as .EQ. 0.0) THEN
              result10d(nd0) = 0.D0
            ELSE
              result10d(nd0) = asd0(nd0)/(2.0*SQRT(as))
            END IF
            add(nd0, nd) = (asdd(nd0, nd)*2.0*result10-asd(nd)*2.0*&
&             result10d(nd0))/(2.0*result10)**2
          END DO
          ad(nd) = asd(nd)/(2.0*result10)
        END IF
        bsd(nd) = 2*(h-k)*(hd(nd)-kd(nd))
        DO nd0=1,nbdirs0
          bsdd(nd0, nd) = 2*((hd0(nd0)-kd0(nd0))*(hd(nd)-kd(nd))+(h-k)*(&
&           hdd(nd0, nd)-kdd(nd0, nd)))
          cdd(nd0, nd) = (-hkdd(nd0, nd))/8
          ddd(nd0, nd) = (-hkdd(nd0, nd))/16
          asrdd(nd0, nd) = -((((bsdd(nd0, nd)*as+bsd(nd)*asd0(nd0)-bsd0(&
&           nd0)*asd(nd)-bs*asdd(nd0, nd))*as**2-(bsd(nd)*as-bs*asd(nd))&
&           *2*as*asd0(nd0))/(as**2)**2+hkdd(nd0, nd))/2)
        END DO
        cd(nd) = (-hkd(nd))/8
        dd(nd) = (-hkd(nd))/16
        asrd(nd) = -(((bsd(nd)*as-bs*asd(nd))/as**2+hkd(nd))/2)
      END DO
      DO nd0=1,nbdirs0
        IF (as .EQ. 0.0) THEN
          ad0(nd0) = 0.D0
        ELSE
          ad0(nd0) = asd0(nd0)/(2.0*SQRT(as))
        END IF
        cd0(nd0) = (-hkd0(nd0))/8
        dd0(nd0) = (-hkd0(nd0))/16
        asrd0(nd0) = -(((bsd0(nd0)*as-bs*asd0(nd0))/as**2+hkd0(nd0))/2)
      END DO
      a = SQRT(as)
      c = (4-hk)/8
      d = (12-hk)/16
      asr = -((bs/as+hk)/2)
      IF (asr .GT. -100) THEN
        DO nd0=1,nbdirs0
          bvnd0d(nd0, :) = 0.D0
        END DO
        DO nd=1,nbdirs
          DO nd0=1,nbdirs0
            bvnd0d(nd0, nd) = (add(nd0, nd)*EXP(asr)+ad(nd)*asrd0(nd0)*&
&             EXP(asr)+(ad0(nd0)*asrd(nd)+a*asrdd(nd0, nd))*EXP(asr)+a*&
&             asrd(nd)*asrd0(nd0)*EXP(asr))*(1-c*(bs-as)*(1-d*bs/5)/3+c*&
&             d*as*as/5) + (ad(nd)*EXP(asr)+a*asrd(nd)*EXP(asr))*(((cd0(&
&             nd0)*d+c*dd0(nd0))*as**2+c*d*(asd0(nd0)*as+as*asd0(nd0)))/&
&             5-((cd0(nd0)*(bs-as)+c*(bsd0(nd0)-asd0(nd0)))*(1-d*bs/5)-c&
&             *(bs-as)*(dd0(nd0)*bs+d*bsd0(nd0))/5)/3) + (ad0(nd0)*EXP(&
&             asr)+a*asrd0(nd0)*EXP(asr))*(((cd(nd)*d+c*dd(nd))*as**2+c*&
&             d*(asd(nd)*as+as*asd(nd)))/5-((cd(nd)*(bs-as)+c*(bsd(nd)-&
&             asd(nd)))*(1-d*bs/5)-c*(bs-as)*(dd(nd)*bs+d*bsd(nd))/5)/3)&
&             + a*EXP(asr)*(((cdd(nd0, nd)*d+cd(nd)*dd0(nd0)+cd0(nd0)*dd&
&             (nd)+c*ddd(nd0, nd))*as**2+(cd(nd)*d+c*dd(nd))*2*as*asd0(&
&             nd0)+(cd0(nd0)*d+c*dd0(nd0))*(asd(nd)*as+as*asd(nd))+c*d*(&
&             asdd(nd0, nd)*as+asd(nd)*asd0(nd0)+asd0(nd0)*asd(nd)+as*&
&             asdd(nd0, nd)))/5-((cdd(nd0, nd)*(bs-as)+cd(nd)*(bsd0(nd0)&
&             -asd0(nd0))+cd0(nd0)*(bsd(nd)-asd(nd))+c*(bsdd(nd0, nd)-&
&             asdd(nd0, nd)))*(1-d*bs/5)-(cd(nd)*(bs-as)+c*(bsd(nd)-asd(&
&             nd)))*(dd0(nd0)*bs+d*bsd0(nd0))/5-((cd0(nd0)*(bs-as)+c*(&
&             bsd0(nd0)-asd0(nd0)))*(dd(nd)*bs+d*bsd(nd))+c*(bs-as)*(ddd&
&             (nd0, nd)*bs+dd(nd)*bsd0(nd0)+dd0(nd0)*bsd(nd)+d*bsdd(nd0&
&             , nd)))/5)/3)
          END DO
          bvnd0(nd) = (ad(nd)*EXP(asr)+a*asrd(nd)*EXP(asr))*(1-c*(bs-as)&
&           *(1-d*bs/5)/3+c*d*as*as/5) + a*EXP(asr)*(((cd(nd)*d+c*dd(nd)&
&           )*as**2+c*d*(asd(nd)*as+as*asd(nd)))/5-((cd(nd)*(bs-as)+c*(&
&           bsd(nd)-asd(nd)))*(1-d*bs/5)-c*(bs-as)*(dd(nd)*bs+d*bsd(nd))&
&           /5)/3)
        END DO
        DO nd0=1,nbdirs0
          bvnd1(nd0) = (ad0(nd0)*EXP(asr)+a*asrd0(nd0)*EXP(asr))*(1-c*(&
&           bs-as)*(1-d*bs/5)/3+c*d*as*as/5) + a*EXP(asr)*(((cd0(nd0)*d+&
&           c*dd0(nd0))*as**2+c*d*(asd0(nd0)*as+as*asd0(nd0)))/5-((cd0(&
&           nd0)*(bs-as)+c*(bsd0(nd0)-asd0(nd0)))*(1-d*bs/5)-c*(bs-as)*(&
&           dd0(nd0)*bs+d*bsd0(nd0))/5)/3)
        END DO
        bvn = a*EXP(asr)*(1-c*(bs-as)*(1-d*bs/5)/3+c*d*as*as/5)
      ELSE
        DO nd=1,nbdirs
          bvnd0(nd) = 0.d0
        END DO
        DO nd0=1,nbdirs0
          bvnd1(nd0) = 0.D0
          bvnd0d(nd0, :) = 0.D0
        END DO
      END IF
      IF (-hk .LT. 100) THEN
        DO nd0=1,nbdirs0
          IF (bs .EQ. 0.0) THEN
            bd0(nd0) = 0.D0
          ELSE
            bd0(nd0) = bsd0(nd0)/(2.0*SQRT(bs))
          END IF
        END DO
        b = SQRT(bs)
        DO nd0=1,nbdirs0
          arg1dd(nd0, :) = 0.D0
          bdd(nd0, :) = 0.D0
          arg2dd(nd0, :) = 0.D0
        END DO
        DO nd=1,nbdirs
          IF (bs .EQ. 0.0) THEN
            DO nd0=1,nbdirs0
              bdd(nd0, nd) = 0.D0
            END DO
            bd(nd) = 0.d0
          ELSE
            result10 = SQRT(bs)
            DO nd0=1,nbdirs0
              IF (bs .EQ. 0.0) THEN
                result10d(nd0) = 0.D0
              ELSE
                result10d(nd0) = bsd0(nd0)/(2.0*SQRT(bs))
              END IF
              bdd(nd0, nd) = (bsdd(nd0, nd)*2.0*result10-bsd(nd)*2.0*&
&               result10d(nd0))/(2.0*result10)**2
            END DO
            bd(nd) = bsd(nd)/(2.0*result10)
          END IF
          DO nd0=1,nbdirs0
            arg1dd(nd0, nd) = -(hkdd(nd0, nd)/2)
            arg2dd(nd0, nd) = -(((bdd(nd0, nd)*a+bd(nd)*ad0(nd0)-bd0(nd0&
&             )*ad(nd)-b*add(nd0, nd))*a**2-(bd(nd)*a-b*ad(nd))*2*a*ad0(&
&             nd0))/(a**2)**2)
          END DO
          arg1d(nd) = -(hkd(nd)/2)
          arg2d(nd) = -((bd(nd)*a-b*ad(nd))/a**2)
        END DO
        DO nd0=1,nbdirs0
          arg1d0(nd0) = -(hkd0(nd0)/2)
          arg2d0(nd0) = -((bd0(nd0)*a-b*ad0(nd0))/a**2)
          result2dd(nd0, :) = 0.D0
        END DO
        arg1 = -(hk/2)
        result1 = SQRT(twopi)
        arg2 = -(b/a)
        CALL PHID_DV_DV(arg2, arg2d0, arg2d, arg2dd, result2, result2d0&
&                 , result2d, result2dd, nbdirs, nbdirs0)
        DO nd=1,nbdirs
          DO nd0=1,nbdirs0
            bvnd0d(nd0, nd) = bvnd0d(nd0, nd) - result1*(((arg1dd(nd0, &
&             nd)*result2*b+arg1d(nd)*(result2d0(nd0)*b+result2*bd0(nd0)&
&             ))*EXP(arg1)+arg1d(nd)*result2*b*arg1d0(nd0)*EXP(arg1)+&
&             arg1d0(nd0)*EXP(arg1)*(result2d(nd)*b+result2*bd(nd))+EXP(&
&             arg1)*(result2dd(nd0, nd)*b+result2d(nd)*bd0(nd0)+&
&             result2d0(nd0)*bd(nd)+result2*bdd(nd0, nd)))*(1-c*bs*(1-d*&
&             bs/5)/3)-(arg1d(nd)*EXP(arg1)*result2*b+EXP(arg1)*(&
&             result2d(nd)*b+result2*bd(nd)))*((cd0(nd0)*bs+c*bsd0(nd0))&
&             *(1-d*bs/5)-c*bs*(dd0(nd0)*bs+d*bsd0(nd0))/5)/3-((arg1d0(&
&             nd0)*EXP(arg1)*result2*b+EXP(arg1)*(result2d0(nd0)*b+&
&             result2*bd0(nd0)))*((cd(nd)*bs+c*bsd(nd))*(1-d*bs/5)-c*bs*&
&             (dd(nd)*bs+d*bsd(nd))/5)+EXP(arg1)*result2*b*((cdd(nd0, nd&
&             )*bs+cd(nd)*bsd0(nd0)+cd0(nd0)*bsd(nd)+c*bsdd(nd0, nd))*(1&
&             -d*bs/5)-(cd(nd)*bs+c*bsd(nd))*(dd0(nd0)*bs+d*bsd0(nd0))/5&
&             -((cd0(nd0)*bs+c*bsd0(nd0))*(dd(nd)*bs+d*bsd(nd))+c*bs*(&
&             ddd(nd0, nd)*bs+dd(nd)*bsd0(nd0)+dd0(nd0)*bsd(nd)+d*bsdd(&
&             nd0, nd)))/5))/3)
          END DO
          bvnd0(nd) = bvnd0(nd) - result1*((arg1d(nd)*EXP(arg1)*result2*&
&           b+EXP(arg1)*(result2d(nd)*b+result2*bd(nd)))*(1-c*bs*(1-d*bs&
&           /5)/3)-EXP(arg1)*result2*b*((cd(nd)*bs+c*bsd(nd))*(1-d*bs/5)&
&           -c*bs*(dd(nd)*bs+d*bsd(nd))/5)/3)
        END DO
        DO nd0=1,nbdirs0
          bvnd1(nd0) = bvnd1(nd0) - result1*((arg1d0(nd0)*EXP(arg1)*&
&           result2*b+EXP(arg1)*(result2d0(nd0)*b+result2*bd0(nd0)))*(1-&
&           c*bs*(1-d*bs/5)/3)-EXP(arg1)*result2*b*((cd0(nd0)*bs+c*bsd0(&
&           nd0))*(1-d*bs/5)-c*bs*(dd0(nd0)*bs+d*bsd0(nd0))/5)/3)
        END DO
        bvn = bvn - EXP(arg1)*result1*result2*b*(1-c*bs*(1-d*bs/5)/3)
      ELSE
        DO nd0=1,nbdirs0
          arg1dd(nd0, :) = 0.D0
          result2dd(nd0, :) = 0.D0
        END DO
      END IF
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          add(nd0, nd) = add(nd0, nd)/2
        END DO
        ad(nd) = ad(nd)/2
      END DO
      DO nd0=1,nbdirs0
        ad0(nd0) = ad0(nd0)/2
      END DO
      a = a/2
      DO nd0=1,nbdirs0
        rsdd(nd0, :) = 0.D0
        xsdd(nd0, :) = 0.D0
      END DO
      DO i=1,lg
        DO is=-1,1,2
          DO nd0=1,nbdirs0
            xsd0(nd0) = 2*a*(is*x(i, ng)+1)**2*ad0(nd0)
          END DO
          xs = (a*(is*x(i, ng)+1))**2
          DO nd=1,nbdirs
            xsd(nd) = 2*a*(is*x(i, ng)+1)**2*ad(nd)
            result10 = SQRT(1 - xs)
            DO nd0=1,nbdirs0
              xsdd(nd0, nd) = 2*(is*x(i, ng)+1)**2*(ad0(nd0)*ad(nd)+a*&
&               add(nd0, nd))
              result10d(nd0) = -(xsd0(nd0)/(2.0*SQRT(1-xs)))
              rsdd(nd0, nd) = -((xsdd(nd0, nd)*2.0*result10-xsd(nd)*2.0*&
&               result10d(nd0))/(2.0*result10)**2)
              asrdd(nd0, nd) = -((((bsdd(nd0, nd)*xs+bsd(nd)*xsd0(nd0)-&
&               bsd0(nd0)*xsd(nd)-bs*xsdd(nd0, nd))*xs**2-(bsd(nd)*xs-bs&
&               *xsd(nd))*2*xs*xsd0(nd0))/(xs**2)**2+hkdd(nd0, nd))/2)
            END DO
            rsd(nd) = -(xsd(nd)/(2.0*result10))
            asrd(nd) = -(((bsd(nd)*xs-bs*xsd(nd))/xs**2+hkd(nd))/2)
          END DO
          DO nd0=1,nbdirs0
            rsd0(nd0) = -(xsd0(nd0)/(2.0*SQRT(1-xs)))
            asrd0(nd0) = -(((bsd0(nd0)*xs-bs*xsd0(nd0))/xs**2+hkd0(nd0))&
&             /2)
          END DO
          rs = SQRT(1 - xs)
          asr = -((bs/xs+hk)/2)
          IF (asr .GT. -100) THEN
            DO nd0=1,nbdirs0
              arg1d0(nd0) = -(((hkd0(nd0)*xs+hk*xsd0(nd0))*2*(1+rs)**2-&
&               hk*xs*2**2*(1+rs)*rsd0(nd0))/(2*(1+rs)**2)**2)
            END DO
            arg1 = -(hk*xs/(2*(1+rs)**2))
            DO nd=1,nbdirs
              arg1d(nd) = -(((hkd(nd)*xs+hk*xsd(nd))*2*(1+rs)**2-hk*xs*2&
&               **2*(1+rs)*rsd(nd))/(2*(1+rs)**2)**2)
              DO nd0=1,nbdirs0
                arg1dd(nd0, nd) = -(((2*((hkdd(nd0, nd)*xs+hkd(nd)*xsd0(&
&                 nd0)+hkd0(nd0)*xsd(nd)+hk*xsdd(nd0, nd))*(1+rs)**2)+2*&
&                 ((hkd(nd)*xs+hk*xsd(nd))*2*(1+rs)*rsd0(nd0))-2**2*((&
&                 hkd0(nd0)*xs+hk*xsd0(nd0))*(1+rs)*rsd(nd)+hk*xs*(rsd0(&
&                 nd0)*rsd(nd)+(1+rs)*rsdd(nd0, nd))))*2**2*(1+rs)**4-((&
&                 hkd(nd)*xs+hk*xsd(nd))*2*(1+rs)**2-hk*xs*2**2*(1+rs)*&
&                 rsd(nd))*2**4*(1+rs)**3*rsd0(nd0))/((2*(1+rs)**2)**2)&
&                 **2)
                bvnd0d(nd0, nd) = bvnd0d(nd0, nd) + w(i, ng)*((add(nd0, &
&                 nd)*EXP(asr)+ad(nd)*asrd0(nd0)*EXP(asr)+(ad0(nd0)*asrd&
&                 (nd)+a*asrdd(nd0, nd))*EXP(asr)+a*asrd(nd)*asrd0(nd0)*&
&                 EXP(asr))*(EXP(arg1)/rs-(1+c*xs*(1+d*xs)))+(ad(nd)*EXP&
&                 (asr)+a*asrd(nd)*EXP(asr))*((arg1d0(nd0)*EXP(arg1)*rs-&
&                 EXP(arg1)*rsd0(nd0))/rs**2-(cd0(nd0)*xs+c*xsd0(nd0))*(&
&                 1+d*xs)-c*xs*(dd0(nd0)*xs+d*xsd0(nd0)))+(ad0(nd0)*EXP(&
&                 asr)+a*asrd0(nd0)*EXP(asr))*((arg1d(nd)*EXP(arg1)*rs-&
&                 EXP(arg1)*rsd(nd))/rs**2-(cd(nd)*xs+c*xsd(nd))*(1+d*xs&
&                 )-c*xs*(dd(nd)*xs+d*xsd(nd)))+a*EXP(asr)*((((arg1dd(&
&                 nd0, nd)*rs+arg1d(nd)*rsd0(nd0))*EXP(arg1)+arg1d(nd)*&
&                 rs*arg1d0(nd0)*EXP(arg1)-arg1d0(nd0)*EXP(arg1)*rsd(nd)&
&                 -EXP(arg1)*rsdd(nd0, nd))*rs**2-(arg1d(nd)*EXP(arg1)*&
&                 rs-EXP(arg1)*rsd(nd))*2*rs*rsd0(nd0))/(rs**2)**2-(cdd(&
&                 nd0, nd)*xs+cd(nd)*xsd0(nd0)+cd0(nd0)*xsd(nd)+c*xsdd(&
&                 nd0, nd))*(1+d*xs)-(cd(nd)*xs+c*xsd(nd))*(dd0(nd0)*xs+&
&                 d*xsd0(nd0))-(cd0(nd0)*xs+c*xsd0(nd0))*(dd(nd)*xs+d*&
&                 xsd(nd))-c*xs*(ddd(nd0, nd)*xs+dd(nd)*xsd0(nd0)+dd0(&
&                 nd0)*xsd(nd)+d*xsdd(nd0, nd))))
              END DO
              bvnd0(nd) = bvnd0(nd) + w(i, ng)*((ad(nd)*EXP(asr)+a*asrd(&
&               nd)*EXP(asr))*(EXP(arg1)/rs-(1+c*xs*(1+d*xs)))+a*EXP(asr&
&               )*((arg1d(nd)*EXP(arg1)*rs-EXP(arg1)*rsd(nd))/rs**2-(cd(&
&               nd)*xs+c*xsd(nd))*(1+d*xs)-c*xs*(dd(nd)*xs+d*xsd(nd))))
            END DO
            DO nd0=1,nbdirs0
              bvnd1(nd0) = bvnd1(nd0) + w(i, ng)*((ad0(nd0)*EXP(asr)+a*&
&               asrd0(nd0)*EXP(asr))*(EXP(arg1)/rs-(1+c*xs*(1+d*xs)))+a*&
&               EXP(asr)*((arg1d0(nd0)*EXP(arg1)*rs-EXP(arg1)*rsd0(nd0))&
&               /rs**2-(cd0(nd0)*xs+c*xsd0(nd0))*(1+d*xs)-c*xs*(dd0(nd0)&
&               *xs+d*xsd0(nd0))))
            END DO
            bvn = bvn + a*w(i, ng)*EXP(asr)*(EXP(arg1)/rs-(1+c*xs*(1+d*&
&             xs)))
          END IF
        END DO
      END DO
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          bvnd0d(nd0, nd) = -(bvnd0d(nd0, nd)/twopi)
        END DO
        bvnd0(nd) = -(bvnd0(nd)/twopi)
      END DO
      DO nd0=1,nbdirs0
        bvnd1(nd0) = -(bvnd1(nd0)/twopi)
      END DO
      bvn = -(bvn/twopi)
    ELSE
      DO nd=1,nbdirs
        bvnd0(nd) = 0.d0
      END DO
      DO nd0=1,nbdirs0
        result2dd(nd0, :) = 0.D0
        bvnd1(nd0) = 0.D0
        bvnd0d(nd0, :) = 0.D0
      END DO
    END IF
    IF (r .GT. 0) THEN
      IF (h .LT. k) THEN
        DO nd0=1,nbdirs0
          max1dd(nd0, :) = 0.D0
        END DO
        DO nd=1,nbdirs
          DO nd0=1,nbdirs0
            max1dd(nd0, nd) = kdd(nd0, nd)
          END DO
          max1d(nd) = kd(nd)
        END DO
        DO nd0=1,nbdirs0
          max1d0(nd0) = kd0(nd0)
        END DO
        max1 = k
      ELSE
        DO nd0=1,nbdirs0
          max1dd(nd0, :) = 0.D0
        END DO
        DO nd=1,nbdirs
          DO nd0=1,nbdirs0
            max1dd(nd0, nd) = hdd(nd0, nd)
          END DO
          max1d(nd) = hd(nd)
        END DO
        DO nd0=1,nbdirs0
          max1d0(nd0) = hd0(nd0)
        END DO
        max1 = h
      END IF
      DO nd0=1,nbdirs0
        result1dd(nd0, :) = 0.D0
      END DO
      CALL PHID_DV_DV(-max1, -max1d0, -max1d, -max1dd, result1, &
&               result1d0, result1d, result1dd, nbdirs, nbdirs0)
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          bvnd0d(nd0, nd) = bvnd0d(nd0, nd) + result1dd(nd0, nd)
        END DO
        bvnd0(nd) = bvnd0(nd) + result1d(nd)
      END DO
      DO nd0=1,nbdirs0
        bvnd1(nd0) = bvnd1(nd0) + result1d0(nd0)
      END DO
      bvn = bvn + result1
    ELSE
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          bvnd0d(nd0, nd) = -bvnd0d(nd0, nd)
        END DO
        bvnd0(nd) = -bvnd0(nd)
      END DO
      DO nd0=1,nbdirs0
        bvnd1(nd0) = -bvnd1(nd0)
      END DO
      bvn = -bvn
      IF (k .GT. h) THEN
        IF (h .LT. 0) THEN
          DO nd0=1,nbdirs0
            result1dd(nd0, :) = 0.D0
          END DO
          CALL PHID_DV_DV(k, kd0, kd, kdd, result1, result1d0, result1d&
&                   , result1dd, nbdirs, nbdirs0)
          CALL PHID_DV_DV(h, hd0, hd, hdd, result2, result2d0, result2d&
&                   , result2dd, nbdirs, nbdirs0)
          DO nd=1,nbdirs
            DO nd0=1,nbdirs0
              bvnd0d(nd0, nd) = bvnd0d(nd0, nd) + result1dd(nd0, nd) - &
&               result2dd(nd0, nd)
            END DO
            bvnd0(nd) = bvnd0(nd) + result1d(nd) - result2d(nd)
          END DO
          DO nd0=1,nbdirs0
            bvnd1(nd0) = bvnd1(nd0) + result1d0(nd0) - result2d0(nd0)
          END DO
          bvn = bvn + result1 - result2
        ELSE
          DO nd0=1,nbdirs0
            result1dd(nd0, :) = 0.D0
          END DO
          CALL PHID_DV_DV(-h, -hd0, -hd, -hdd, result1, result1d0, &
&                   result1d, result1dd, nbdirs, nbdirs0)
          CALL PHID_DV_DV(-k, -kd0, -kd, -kdd, result2, result2d0, &
&                   result2d, result2dd, nbdirs, nbdirs0)
          DO nd=1,nbdirs
            DO nd0=1,nbdirs0
              bvnd0d(nd0, nd) = bvnd0d(nd0, nd) + result1dd(nd0, nd) - &
&               result2dd(nd0, nd)
            END DO
            bvnd0(nd) = bvnd0(nd) + result1d(nd) - result2d(nd)
          END DO
          DO nd0=1,nbdirs0
            bvnd1(nd0) = bvnd1(nd0) + result1d0(nd0) - result2d0(nd0)
          END DO
          bvn = bvn + result1 - result2
        END IF
      END IF
    END IF
  END IF
  DO nd=1,nbdirs
    DO nd0=1,nbdirs0
      bvnddd(nd0, nd) = bvnd0d(nd0, nd)
    END DO
    bvndd(nd) = bvnd0(nd)
  END DO
  DO nd0=1,nbdirs0
    bvndd0(nd0) = bvnd1(nd0)
  END DO
  bvnd = bvn
END SUBROUTINE BVND_DV_DV
