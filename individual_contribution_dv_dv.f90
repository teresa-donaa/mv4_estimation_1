!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.14 (r7259) - 18 Jan 2019 09:34
!
!  Differentiation of individual_contribution_dv in forward (tangent) mode (with options multiDirectional i4 dr8 r4):
!   variations   of useful results: pd
!   with respect to varying inputs: psi
!   RW status of diff variables: psi:in pd:out
!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.14 (r7259) - 18 Jan 2019 09:34
!
!  Differentiation of individual_contribution in forward (tangent) mode (with options multiDirectional i4 dr8 r4):
!   variations   of useful results: p
!   with respect to varying inputs: psi
!   RW status of diff variables: psi:in p:out
SUBROUTINE INDIVIDUAL_CONTRIBUTION_DV_DV(psi, psid0, psid, dn, asn, &
& riskavn, horizonn, p, pd, pdd, nbdirs, nbdirs0)
!
  USE CONSTANTS
  USE OBSERVATIONS
  USE UTILITIES_DIFFV_DIFFV
  USE SP_DIFFV_DIFFV
  USE DIFFSIZES
  USE DIFFSIZES
!  Hint: nbdirsmax should be the maximum number of differentiation directions
  IMPLICIT NONE
! 
! Ending subroutine and returning execution
! 
! 
! Declaring dummy variables
!   
! Vector of metaparameters
  REAL*8, INTENT(IN) :: psi(num_psi)
  REAL*8, INTENT(IN) :: psid0(nbdirsmax0, num_psi)
  REAL*8, INTENT(IN) :: psid(nbdirsmax, num_psi)
! Observed regime dummy
  INTEGER, INTENT(IN) :: dn
  REAL*8, INTENT(IN) :: asn
! Observed self-reported risk attitude
  INTEGER, INTENT(IN) :: riskavn
! Observed self-reported planning horizon
  INTEGER, INTENT(IN) :: horizonn
! Computed regime probability
  REAL*8, INTENT(OUT) :: p
  REAL*8, DIMENSION(nbdirsmax), INTENT(OUT) :: pd
  REAL*8, DIMENSION(nbdirsmax0, nbdirsmax), INTENT(OUT) :: pdd
!
! Declaring external routines
!
! Trivariate normal cdf
  REAL*8, EXTERNAL :: TVTL
! Bivariate normal survival sdf
  REAL*8, EXTERNAL :: BVND
! Univariate normal cdf
  REAL*8, EXTERNAL :: PHID
! 
! Declaring local variables
! 
  REAL*8 :: m_s, m_q, m_z, m_y
  REAL*8, DIMENSION(nbdirsmax0) :: m_sd0, m_zd0, m_yd0
  REAL*8, DIMENSION(nbdirsmax) :: m_sd, m_zd, m_yd
  REAL*8, DIMENSION(nbdirsmax0, nbdirsmax) :: m_zdd
  REAL*8 :: sigma_s, sigma_z, sigma_y
  REAL*8, DIMENSION(nbdirsmax0) :: sigma_sd0, sigma_zd0, sigma_yd0
  REAL*8, DIMENSION(nbdirsmax) :: sigma_sd, sigma_zd, sigma_yd
  REAL*8, DIMENSION(nbdirsmax0, nbdirsmax) :: sigma_sdd, sigma_zdd, &
& sigma_ydd
  REAL*8 :: rho_sz, rho_sy, rho_zy
  REAL*8, DIMENSION(nbdirsmax0) :: rho_szd0, rho_syd0, rho_zyd0
  REAL*8, DIMENSION(nbdirsmax) :: rho_szd, rho_syd, rho_zyd
  REAL*8, DIMENSION(nbdirsmax0, nbdirsmax) :: rho_szdd, rho_sydd, &
& rho_zydd
  REAL*8 :: gamma, kappa, q
  REAL*8, DIMENSION(nbdirsmax0) :: qd0
  REAL*8, DIMENSION(nbdirsmax) :: qd
  REAL*8, DIMENSION(nbdirsmax0, nbdirsmax) :: qdd
  REAL*8 :: delta_z(num_delta_z), delta_y(num_delta_y)
  REAL*8 :: delta_zd0(nbdirsmax0, num_delta_z), delta_yd0(nbdirsmax0, &
& num_delta_y)
  REAL*8 :: delta_zd(nbdirsmax, num_delta_z), delta_yd(nbdirsmax, &
& num_delta_y)
  REAL*8 :: delta_zdd(nbdirsmax0, nbdirsmax, num_delta_z), delta_ydd(&
& nbdirsmax0, nbdirsmax, num_delta_y)
  REAL*8 :: m_zs, m_ys, psi_z, psi_y, rho_psi_zy
  REAL*8, DIMENSION(nbdirsmax0) :: m_zsd0, m_ysd0, psi_zd0, psi_yd0, &
& rho_psi_zyd0
  REAL*8, DIMENSION(nbdirsmax) :: m_zsd, m_ysd, psi_zd, psi_yd, &
& rho_psi_zyd
  REAL*8, DIMENSION(nbdirsmax0, nbdirsmax) :: m_zsdd, m_ysdd, psi_zdd, &
& psi_ydd, rho_psi_zydd
  REAL*8 :: p_as, p_zy, eps
  REAL*8, DIMENSION(nbdirsmax0) :: p_asd0, p_zyd0
  REAL*8, DIMENSION(nbdirsmax) :: p_asd, p_zyd
  REAL*8, DIMENSION(nbdirsmax0, nbdirsmax) :: p_asdd, p_zydd
  REAL*8 :: limit3(3, 4), corr3(3), pcomp(4, 2)
  REAL*8 :: limit3d0(nbdirsmax0, 3, 4), corr3d0(nbdirsmax0, 3), pcompd0(&
& nbdirsmax0, 4, 2)
  REAL*8 :: limit3d(nbdirsmax, 3, 4), corr3d(nbdirsmax, 3), pcompd(&
& nbdirsmax, 4, 2)
  REAL*8 :: limit3dd(nbdirsmax0, nbdirsmax, 3, 4), corr3dd(nbdirsmax0, &
& nbdirsmax, 3), pcompdd(nbdirsmax0, nbdirsmax, 4, 2)
  INTRINSIC SQRT
  REAL*8 :: arg1
  REAL*8, DIMENSION(nbdirsmax0) :: arg1d0
  REAL*8, DIMENSION(nbdirsmax) :: arg1d
  REAL*8, DIMENSION(nbdirsmax0, nbdirsmax) :: arg1dd
  REAL*8 :: result1
  REAL*8, DIMENSION(nbdirsmax0) :: result1d0
  REAL*8, DIMENSION(nbdirsmax) :: result1d
  REAL*8, DIMENSION(nbdirsmax0, nbdirsmax) :: result1dd
  REAL*8 :: arg2
  REAL*8, DIMENSION(nbdirsmax0) :: arg2d0
  REAL*8, DIMENSION(nbdirsmax) :: arg2d
  REAL*8, DIMENSION(nbdirsmax0, nbdirsmax) :: arg2dd
  REAL*8 :: result2
  REAL*8, DIMENSION(nbdirsmax0) :: result2d0
  REAL*8, DIMENSION(nbdirsmax) :: result2d
  REAL*8, DIMENSION(nbdirsmax0, nbdirsmax) :: result2dd
  INTEGER :: nd
  INTEGER :: nbdirs
  REAL*8 :: result10
  REAL*8, DIMENSION(nbdirsmax0) :: result10d
  INTEGER :: nd0
  INTEGER :: nbdirs0
! 
! Beginning execution
! 
! Computing the b parameters
! 
  CALL COMPUTE_B_PARAMETERS_DV_DV(psi, psid0, psid, m_s, m_sd0, m_sd, &
&                           m_q, m_z, m_zd0, m_zd, m_zdd, m_y, m_yd0, &
&                           m_yd, sigma_s, sigma_sd0, sigma_sd, &
&                           sigma_sdd, sigma_z, sigma_zd0, sigma_zd, &
&                           sigma_zdd, sigma_y, sigma_yd0, sigma_yd, &
&                           sigma_ydd, rho_sz, rho_szd0, rho_szd, &
&                           rho_szdd, rho_sy, rho_syd0, rho_syd, &
&                           rho_sydd, rho_zy, rho_zyd0, rho_zyd, &
&                           rho_zydd, gamma, kappa, q, qd0, qd, qdd, &
&                           delta_z, delta_zd0, delta_zd, delta_zdd, &
&                           delta_y, delta_yd0, delta_yd, delta_ydd, &
&                           nbdirs, nbdirs0)
  pcomp = 0.d0
  limit3 = 0.d0
! 
! 
! Computing individual contribution to the loglikelihood
! 
  SELECT CASE  (dn) 
  CASE (1) 
    DO nd0=1,nbdirs0
      arg2d0(nd0) = -(2*rho_sy*rho_syd0(nd0))
    END DO
    arg2 = 1.d0 - rho_sy**2
    arg1dd(:, :) = 0.0_8
    result2dd(:, :) = 0.0_8
    m_zsdd(:, :) = 0.0_8
    arg2dd(:, :) = 0.0_8
    m_ysdd(:, :) = 0.0_8
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
!
! 0 < as < 1          
! 
! density of a_s
! 
        arg1dd(nd0, nd) = ((-((((m_sd(nd)*qd0(nd0)-m_sd0(nd0)*qd(nd)-m_s&
&         *qdd(nd0, nd))*sigma_s+(m_sd(nd)*q-m_s*qd(nd))*sigma_sd0(nd0))&
&         *q**3-(m_sd(nd)*q-m_s*qd(nd))*sigma_s*3*q**2*qd0(nd0))/(q**3)&
&         **2)-(((asn-m_s/q)*(sigma_sdd(nd0, nd)*q+sigma_sd(nd)*qd0(nd0)&
&         -sigma_sd0(nd0)*qd(nd)-sigma_s*qdd(nd0, nd))-(m_sd0(nd0)*q-m_s&
&         *qd0(nd0))*(sigma_sd(nd)*q-sigma_s*qd(nd))/q**2)*q**2-(asn-m_s&
&         /q)*(sigma_sd(nd)*q-sigma_s*qd(nd))*2*q*qd0(nd0))/(q**2)**2)*&
&         sigma_s**2/q**2-(-((m_sd(nd)*q-m_s*qd(nd))*sigma_s/q**3)-(asn-&
&         m_s/q)*(sigma_sd(nd)*q-sigma_s*qd(nd))/q**2)*2*sigma_s*(&
&         sigma_sd0(nd0)*q-sigma_s*qd0(nd0))/q**3)/((sigma_s/q)**2)**2
!
! probability of self-reported risk aversion and planning horizon
!
        m_zsdd(nd0, nd) = m_zdd(nd0, nd) + ((((rho_szdd(nd0, nd)*sigma_z&
&         +rho_szd(nd)*sigma_zd0(nd0)+rho_szd0(nd0)*sigma_zd(nd)+rho_sz*&
&         sigma_zdd(nd0, nd))*sigma_s+(rho_szd(nd)*sigma_z+rho_sz*&
&         sigma_zd(nd))*sigma_sd0(nd0)-(rho_szd0(nd0)*sigma_z+rho_sz*&
&         sigma_zd0(nd0))*sigma_sd(nd)-rho_sz*sigma_z*sigma_sdd(nd0, nd)&
&         )*(m_s-q*asn)+((rho_szd(nd)*sigma_z+rho_sz*sigma_zd(nd))*&
&         sigma_s-rho_sz*sigma_z*sigma_sd(nd))*(m_sd0(nd0)-asn*qd0(nd0))&
&         )*sigma_s**2-((rho_szd(nd)*sigma_z+rho_sz*sigma_zd(nd))*&
&         sigma_s-rho_sz*sigma_z*sigma_sd(nd))*(m_s-q*asn)*2*sigma_s*&
&         sigma_sd0(nd0))/(sigma_s**2)**2 + (((rho_szd0(nd0)*sigma_z+&
&         rho_sz*sigma_zd0(nd0))*(m_sd(nd)-asn*qd(nd))-rho_sz*sigma_z*&
&         asn*qdd(nd0, nd))*sigma_s-rho_sz*sigma_z*(m_sd(nd)-asn*qd(nd))&
&         *sigma_sd0(nd0))/sigma_s**2
        m_ysdd(nd0, nd) = ((((rho_sydd(nd0, nd)*sigma_y+rho_syd(nd)*&
&         sigma_yd0(nd0)+rho_syd0(nd0)*sigma_yd(nd)+rho_sy*sigma_ydd(nd0&
&         , nd))*sigma_s+(rho_syd(nd)*sigma_y+rho_sy*sigma_yd(nd))*&
&         sigma_sd0(nd0)-(rho_syd0(nd0)*sigma_y+rho_sy*sigma_yd0(nd0))*&
&         sigma_sd(nd)-rho_sy*sigma_y*sigma_sdd(nd0, nd))*(m_s-q*asn)+((&
&         rho_syd(nd)*sigma_y+rho_sy*sigma_yd(nd))*sigma_s-rho_sy*&
&         sigma_y*sigma_sd(nd))*(m_sd0(nd0)-asn*qd0(nd0)))*sigma_s**2-((&
&         rho_syd(nd)*sigma_y+rho_sy*sigma_yd(nd))*sigma_s-rho_sy*&
&         sigma_y*sigma_sd(nd))*(m_s-q*asn)*2*sigma_s*sigma_sd0(nd0))/(&
&         sigma_s**2)**2 + (((rho_syd0(nd0)*sigma_y+rho_sy*sigma_yd0(nd0&
&         ))*(m_sd(nd)-asn*qd(nd))-rho_sy*sigma_y*asn*qdd(nd0, nd))*&
&         sigma_s-rho_sy*sigma_y*(m_sd(nd)-asn*qd(nd))*sigma_sd0(nd0))/&
&         sigma_s**2
        arg2dd(nd0, nd) = -(2*(rho_syd0(nd0)*rho_syd(nd)+rho_sy*rho_sydd&
&         (nd0, nd)))
      END DO
      arg1d(nd) = (-((m_sd(nd)*q-m_s*qd(nd))*sigma_s/q**3)-(asn-m_s/q)*(&
&       sigma_sd(nd)*q-sigma_s*qd(nd))/q**2)/(sigma_s/q)**2
      m_zsd(nd) = m_zd(nd) + ((rho_szd(nd)*sigma_z+rho_sz*sigma_zd(nd))*&
&       sigma_s-rho_sz*sigma_z*sigma_sd(nd))*(m_s-q*asn)/sigma_s**2 + &
&       rho_sz*sigma_z*(m_sd(nd)-asn*qd(nd))/sigma_s
      m_ysd(nd) = m_yd(nd) + ((rho_syd(nd)*sigma_y+rho_sy*sigma_yd(nd))*&
&       sigma_s-rho_sy*sigma_y*sigma_sd(nd))*(m_s-q*asn)/sigma_s**2 + &
&       rho_sy*sigma_y*(m_sd(nd)-asn*qd(nd))/sigma_s
      arg2d(nd) = -(2*rho_sy*rho_syd(nd))
      IF (arg2 .EQ. 0.0) THEN
        DO nd0=1,nbdirs0
          result2dd(nd0, nd) = 0.0_8
        END DO
        result2d(nd) = 0.0_8
      ELSE
        result10 = SQRT(arg2)
        DO nd0=1,nbdirs0
          IF (arg2 .EQ. 0.0) THEN
            result10d(nd0) = 0.0_8
          ELSE
            result10d(nd0) = arg2d0(nd0)/(2.0*SQRT(arg2))
          END IF
          result2dd(nd0, nd) = (arg2dd(nd0, nd)*2.0*result10-arg2d(nd)*&
&           2.0*result10d(nd0))/(2.0*result10)**2
        END DO
        result2d(nd) = arg2d(nd)/(2.0*result10)
      END IF
    END DO
    DO nd0=1,nbdirs0
      arg1d0(nd0) = (-((m_sd0(nd0)*q-m_s*qd0(nd0))*sigma_s/q**3)-(asn-&
&       m_s/q)*(sigma_sd0(nd0)*q-sigma_s*qd0(nd0))/q**2)/(sigma_s/q)**2
    END DO
    arg1 = (asn-m_s/q)/(sigma_s/q)
    CALL PDF_N01_DV_DV(arg1, arg1d0, arg1d, arg1dd, result1, result1d0, &
&                result1d, result1dd, nbdirs, nbdirs0)
    DO nd0=1,nbdirs0
      arg1d0(nd0) = -(2*rho_sz*rho_szd0(nd0))
    END DO
    arg1 = 1.d0 - rho_sz**2
    p_asdd(:, :) = 0.0_8
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        p_asdd(nd0, nd) = ((((result1dd(nd0, nd)*sigma_s+result1d(nd)*&
&         sigma_sd0(nd0))*q-result1d(nd)*sigma_s*qd0(nd0))/q**2-((&
&         result1d0(nd0)*(sigma_sd(nd)*q-sigma_s*qd(nd))+result1*(&
&         sigma_sdd(nd0, nd)*q+sigma_sd(nd)*qd0(nd0)-sigma_sd0(nd0)*qd(&
&         nd)-sigma_s*qdd(nd0, nd)))*q**2-result1*(sigma_sd(nd)*q-&
&         sigma_s*qd(nd))*2*q*qd0(nd0))/(q**2)**2)*sigma_s**2/q**2-(&
&         result1d(nd)*sigma_s/q-result1*(sigma_sd(nd)*q-sigma_s*qd(nd))&
&         /q**2)*2*sigma_s*(sigma_sd0(nd0)*q-sigma_s*qd0(nd0))/q**3)/((&
&         sigma_s/q)**2)**2
        arg1dd(nd0, nd) = -(2*(rho_szd0(nd0)*rho_szd(nd)+rho_sz*rho_szdd&
&         (nd0, nd)))
      END DO
      p_asd(nd) = (result1d(nd)*sigma_s/q-result1*(sigma_sd(nd)*q-&
&       sigma_s*qd(nd))/q**2)/(sigma_s/q)**2
      arg1d(nd) = -(2*rho_sz*rho_szd(nd))
      IF (arg1 .EQ. 0.0) THEN
        DO nd0=1,nbdirs0
          result1dd(nd0, nd) = 0.0_8
        END DO
        result1d(nd) = 0.0_8
      ELSE
        result10 = SQRT(arg1)
        DO nd0=1,nbdirs0
          IF (arg1 .EQ. 0.0) THEN
            result10d(nd0) = 0.0_8
          ELSE
            result10d(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
          END IF
          result1dd(nd0, nd) = (arg1dd(nd0, nd)*2.0*result10-arg1d(nd)*&
&           2.0*result10d(nd0))/(2.0*result10)**2
        END DO
        result1d(nd) = arg1d(nd)/(2.0*result10)
      END IF
      DO nd0=1,nbdirs0
        arg1dd(nd0, nd) = -(2*(rho_syd0(nd0)*rho_syd(nd)+rho_sy*rho_sydd&
&         (nd0, nd)))
      END DO
      arg1d(nd) = -(2*rho_sy*rho_syd(nd))
    END DO
    DO nd0=1,nbdirs0
      p_asd0(nd0) = (result1d0(nd0)*sigma_s/q-result1*(sigma_sd0(nd0)*q-&
&       sigma_s*qd0(nd0))/q**2)/(sigma_s/q)**2
      m_zsd0(nd0) = m_zd0(nd0) + ((rho_szd0(nd0)*sigma_z+rho_sz*&
&       sigma_zd0(nd0))*sigma_s-rho_sz*sigma_z*sigma_sd0(nd0))*(m_s-q*&
&       asn)/sigma_s**2 + rho_sz*sigma_z*(m_sd0(nd0)-asn*qd0(nd0))/&
&       sigma_s
      m_ysd0(nd0) = m_yd0(nd0) + ((rho_syd0(nd0)*sigma_y+rho_sy*&
&       sigma_yd0(nd0))*sigma_s-rho_sy*sigma_y*sigma_sd0(nd0))*(m_s-q*&
&       asn)/sigma_s**2 + rho_sy*sigma_y*(m_sd0(nd0)-asn*qd0(nd0))/&
&       sigma_s
      IF (arg1 .EQ. 0.0) THEN
        result1d0(nd0) = 0.0_8
      ELSE
        result1d0(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
      END IF
      arg1d0(nd0) = -(2*rho_sy*rho_syd0(nd0))
    END DO
    p_as = result1/(sigma_s/q)
    m_zs = m_z + rho_sz*sigma_z/sigma_s*(m_s-q*asn)
    m_ys = m_y + rho_sy*sigma_y/sigma_s*(m_s-q*asn)
    result1 = SQRT(arg1)
    arg1 = 1.d0 - rho_sy**2
    psi_zdd(:, :) = 0.0_8
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        psi_zdd(nd0, nd) = sigma_zdd(nd0, nd)*result1 + sigma_zd(nd)*&
&         result1d0(nd0) + sigma_zd0(nd0)*result1d(nd) + sigma_z*&
&         result1dd(nd0, nd)
      END DO
      psi_zd(nd) = sigma_zd(nd)*result1 + sigma_z*result1d(nd)
      IF (arg1 .EQ. 0.0) THEN
        DO nd0=1,nbdirs0
          result1dd(nd0, nd) = 0.0_8
        END DO
        result1d(nd) = 0.0_8
      ELSE
        result10 = SQRT(arg1)
        DO nd0=1,nbdirs0
          IF (arg1 .EQ. 0.0) THEN
            result10d(nd0) = 0.0_8
          ELSE
            result10d(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
          END IF
          result1dd(nd0, nd) = (arg1dd(nd0, nd)*2.0*result10-arg1d(nd)*&
&           2.0*result10d(nd0))/(2.0*result10)**2
        END DO
        result1d(nd) = arg1d(nd)/(2.0*result10)
      END IF
      DO nd0=1,nbdirs0
        arg1dd(nd0, nd) = -(2*(rho_szd0(nd0)*rho_szd(nd)+rho_sz*rho_szdd&
&         (nd0, nd)))
      END DO
      arg1d(nd) = -(2*rho_sz*rho_szd(nd))
    END DO
    DO nd0=1,nbdirs0
      psi_zd0(nd0) = sigma_zd0(nd0)*result1 + sigma_z*result1d0(nd0)
      IF (arg1 .EQ. 0.0) THEN
        result1d0(nd0) = 0.0_8
      ELSE
        result1d0(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
      END IF
      arg1d0(nd0) = -(2*rho_sz*rho_szd0(nd0))
    END DO
    psi_z = sigma_z*result1
    result1 = SQRT(arg1)
    arg1 = 1.d0 - rho_sz**2
    psi_ydd(:, :) = 0.0_8
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        psi_ydd(nd0, nd) = sigma_ydd(nd0, nd)*result1 + sigma_yd(nd)*&
&         result1d0(nd0) + sigma_yd0(nd0)*result1d(nd) + sigma_y*&
&         result1dd(nd0, nd)
      END DO
      psi_yd(nd) = sigma_yd(nd)*result1 + sigma_y*result1d(nd)
      IF (arg1 .EQ. 0.0) THEN
        DO nd0=1,nbdirs0
          result1dd(nd0, nd) = 0.0_8
        END DO
        result1d(nd) = 0.0_8
      ELSE
        result10 = SQRT(arg1)
        DO nd0=1,nbdirs0
          IF (arg1 .EQ. 0.0) THEN
            result10d(nd0) = 0.0_8
          ELSE
            result10d(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
          END IF
          result1dd(nd0, nd) = (arg1dd(nd0, nd)*2.0*result10-arg1d(nd)*&
&           2.0*result10d(nd0))/(2.0*result10)**2
        END DO
        result1d(nd) = arg1d(nd)/(2.0*result10)
      END IF
    END DO
    DO nd0=1,nbdirs0
      psi_yd0(nd0) = sigma_yd0(nd0)*result1 + sigma_y*result1d0(nd0)
      IF (arg1 .EQ. 0.0) THEN
        result1d0(nd0) = 0.0_8
      ELSE
        result1d0(nd0) = arg1d0(nd0)/(2.0*SQRT(arg1))
      END IF
      IF (arg2 .EQ. 0.0) THEN
        result2d0(nd0) = 0.0_8
      ELSE
        result2d0(nd0) = arg2d0(nd0)/(2.0*SQRT(arg2))
      END IF
    END DO
    psi_y = sigma_y*result1
    result1 = SQRT(arg1)
    result2 = SQRT(arg2)
    rho_psi_zydd(:, :) = 0.0_8
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        rho_psi_zydd(nd0, nd) = (((rho_zydd(nd0, nd)-rho_szdd(nd0, nd)*&
&         rho_sy-rho_szd(nd)*rho_syd0(nd0)-rho_szd0(nd0)*rho_syd(nd)-&
&         rho_sz*rho_sydd(nd0, nd))*result1*result2+(rho_zyd(nd)-rho_szd&
&         (nd)*rho_sy-rho_sz*rho_syd(nd))*(result1d0(nd0)*result2+&
&         result1*result2d0(nd0))-(rho_zyd0(nd0)-rho_szd0(nd0)*rho_sy-&
&         rho_sz*rho_syd0(nd0))*(result1d(nd)*result2+result1*result2d(&
&         nd))-(rho_zy-rho_sz*rho_sy)*(result1dd(nd0, nd)*result2+&
&         result1d(nd)*result2d0(nd0)+result1d0(nd0)*result2d(nd)+&
&         result1*result2dd(nd0, nd)))*result1**2*result2**2-((rho_zyd(&
&         nd)-rho_szd(nd)*rho_sy-rho_sz*rho_syd(nd))*result1*result2-(&
&         rho_zy-rho_sz*rho_sy)*(result1d(nd)*result2+result1*result2d(&
&         nd)))*2*result1*result2*(result1d0(nd0)*result2+result1*&
&         result2d0(nd0)))/((result1*result2)**2)**2
      END DO
      rho_psi_zyd(nd) = ((rho_zyd(nd)-rho_szd(nd)*rho_sy-rho_sz*rho_syd(&
&       nd))*result1*result2-(rho_zy-rho_sz*rho_sy)*(result1d(nd)*&
&       result2+result1*result2d(nd)))/(result1*result2)**2
    END DO
    DO nd0=1,nbdirs0
      rho_psi_zyd0(nd0) = ((rho_zyd0(nd0)-rho_szd0(nd0)*rho_sy-rho_sz*&
&       rho_syd0(nd0))*result1*result2-(rho_zy-rho_sz*rho_sy)*(result1d0&
&       (nd0)*result2+result1*result2d0(nd0)))/(result1*result2)**2
    END DO
    rho_psi_zy = (rho_zy-rho_sz*rho_sy)/(result1*result2)
!
    IF (riskavn .EQ. 1 .AND. horizonn .EQ. 1) THEN
!
      limit3d(:, :, :) = 0.0_8
      limit3dd(:, :, :, :) = 0.0_8
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 1)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 1)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(1)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 1)-m_zsd(nd))*&
&           psi_z-(delta_z(1)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 1) = (((delta_ydd(nd0, nd, 1)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 1)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(1)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 1)-m_ysd(nd))*&
&           psi_y-(delta_y(1)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3d0(:, :, :) = 0.0_8
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_z-(&
&         delta_z(1)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_y-(&
&         delta_y(1)-m_ys)*psi_yd0(nd0))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(1)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(2, 1), -limit3d0(:, 2, 1), -limit3d(:, 2, &
&               1), -limit3dd(:, :, 2, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(1, 1), pcompd0(:, 1, 1), pcompd(:, 1, 1), pcompdd(&
&               :, :, 1, 1), nbdirs, nbdirs0)
!
      p_zydd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 2) THEN
!
      limit3d(:, :, :) = 0.0_8
      limit3dd(:, :, :, :) = 0.0_8
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 1)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 1)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(1)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 1)-m_zsd(nd))*&
&           psi_z-(delta_z(1)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 1) = (((delta_ydd(nd0, nd, 2)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 2)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(2)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 2)-m_ysd(nd))*&
&           psi_y-(delta_y(2)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 1)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 1)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(1)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 1)-m_zsd(nd))*&
&           psi_z-(delta_z(1)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 3) = (((delta_ydd(nd0, nd, 1)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 1)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(1)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 1)-m_ysd(nd))*&
&           psi_y-(delta_y(1)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3d0(:, :, :) = 0.0_8
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_z-(&
&         delta_z(1)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_y-(&
&         delta_y(2)-m_ys)*psi_yd0(nd0))/psi_y**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_z-(&
&         delta_z(1)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_y-(&
&         delta_y(1)-m_ys)*psi_yd0(nd0))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 3) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(1)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(2, 1), -limit3d0(:, 2, 1), -limit3d(:, 2, &
&               1), -limit3dd(:, :, 2, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(1, 1), pcompd0(:, 1, 1), pcompd(:, 1, 1), pcompdd(&
&               :, :, 1, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 3), -limit3d0(:, 2, 3), -limit3d(:, 2, &
&               3), -limit3dd(:, :, 2, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(3, 1), pcompd0(:, 3, 1), pcompd(:, 3, 1), pcompdd(&
&               :, :, 3, 1), nbdirs, nbdirs0)
!
      p_zydd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 3) THEN
!
      limit3d(:, :, :) = 0.0_8
      limit3dd(:, :, :, :) = 0.0_8
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 1)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 1)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(1)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 1)-m_zsd(nd))*&
&           psi_z-(delta_z(1)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 1) = (((delta_ydd(nd0, nd, 3)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 3)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 3)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(3)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 3)-m_ysd(nd))*&
&           psi_y-(delta_y(3)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 1)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 1)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(1)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 1)-m_zsd(nd))*&
&           psi_z-(delta_z(1)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 3) = (((delta_ydd(nd0, nd, 2)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 2)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(2)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 2)-m_ysd(nd))*&
&           psi_y-(delta_y(2)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_ysd(nd))*psi_y-(delta_y(&
&         3)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3d0(:, :, :) = 0.0_8
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_z-(&
&         delta_z(1)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 3)-m_ysd0(nd0))*psi_y-(&
&         delta_y(3)-m_ys)*psi_yd0(nd0))/psi_y**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_z-(&
&         delta_z(1)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_y-(&
&         delta_y(2)-m_ys)*psi_yd0(nd0))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(3)-m_ys)/psi_y
      limit3(2, 3) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(2)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(2, 1), -limit3d0(:, 2, 1), -limit3d(:, 2, &
&               1), -limit3dd(:, :, 2, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(1, 1), pcompd0(:, 1, 1), pcompd(:, 1, 1), pcompdd(&
&               :, :, 1, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 3), -limit3d0(:, 2, 3), -limit3d(:, 2, &
&               3), -limit3dd(:, :, 2, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(3, 1), pcompd0(:, 3, 1), pcompd(:, 3, 1), pcompdd(&
&               :, :, 3, 1), nbdirs, nbdirs0)
!
      p_zydd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 4) THEN
!
      limit3d(:, :, :) = 0.0_8
      limit3dd(:, :, :, :) = 0.0_8
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 1)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 1)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(1)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 1)-m_zsd(nd))*&
&           psi_z-(delta_z(1)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 1)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 1)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(1)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 1)-m_zsd(nd))*&
&           psi_z-(delta_z(1)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 3) = (((delta_ydd(nd0, nd, 3)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 3)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 3)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(3)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 3)-m_ysd(nd))*&
&           psi_y-(delta_y(3)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_ysd(nd))*psi_y-(delta_y(&
&         3)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3d0(:, :, :) = 0.0_8
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_z-(&
&         delta_z(1)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_z-(&
&         delta_z(1)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 3)-m_ysd0(nd0))*psi_y-(&
&         delta_y(3)-m_ys)*psi_yd0(nd0))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_zs)/psi_z
      limit3(2, 3) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(3)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL PHID_DV_DV(limit3(2, 1), limit3d0(:, 2, 1), limit3d(:, 2, 1)&
&               , limit3dd(:, :, 2, 1), pcomp(1, 1), pcompd0(:, 1, 1), &
&               pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 3), -limit3d0(:, 2, 3), -limit3d(:, 2, &
&               3), -limit3dd(:, :, 2, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(3, 1), pcompd0(:, 3, 1), pcompd(:, 3, 1), pcompdd(&
&               :, :, 3, 1), nbdirs, nbdirs0)
!
      p_zydd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 1) THEN
!
      limit3d(:, :, :) = 0.0_8
      limit3dd(:, :, :, :) = 0.0_8
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 2)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 2)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(2)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 2)-m_zsd(nd))*&
&           psi_z-(delta_z(2)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 1) = (((delta_ydd(nd0, nd, 1)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 1)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(1)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 1)-m_ysd(nd))*&
&           psi_y-(delta_y(1)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 1)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 1)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(1)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 1)-m_zsd(nd))*&
&           psi_z-(delta_z(1)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 2) = (((delta_ydd(nd0, nd, 1)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 1)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(1)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 1)-m_ysd(nd))*&
&           psi_y-(delta_y(1)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3d0(:, :, :) = 0.0_8
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_z-(&
&         delta_z(2)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_y-(&
&         delta_y(1)-m_ys)*psi_yd0(nd0))/psi_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_z-(&
&         delta_z(1)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_y-(&
&         delta_y(1)-m_ys)*psi_yd0(nd0))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(1)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(1)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(2, 1), -limit3d0(:, 2, 1), -limit3d(:, 2, &
&               1), -limit3dd(:, :, 2, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(1, 1), pcompd0(:, 1, 1), pcompd(:, 1, 1), pcompdd(&
&               :, :, 1, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 2), -limit3d0(:, 2, 2), -limit3d(:, 2, &
&               2), -limit3dd(:, :, 2, 2), -limit3(3, 2), -limit3d0(:, 3&
&               , 2), -limit3d(:, 3, 2), -limit3dd(:, :, 3, 2), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(2, 1), pcompd0(:, 2, 1), pcompd(:, 2, 1), pcompdd(&
&               :, :, 2, 1), nbdirs, nbdirs0)
!
      p_zydd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 2) THEN
!
      limit3d(:, :, :) = 0.0_8
      limit3dd(:, :, :, :) = 0.0_8
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 2)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 2)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(2)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 2)-m_zsd(nd))*&
&           psi_z-(delta_z(2)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 1) = (((delta_ydd(nd0, nd, 2)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 2)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(2)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 2)-m_ysd(nd))*&
&           psi_y-(delta_y(2)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 1)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 1)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(1)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 1)-m_zsd(nd))*&
&           psi_z-(delta_z(1)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 2) = (((delta_ydd(nd0, nd, 2)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 2)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(2)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 2)-m_ysd(nd))*&
&           psi_y-(delta_y(2)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 2)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 2)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(2)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 2)-m_zsd(nd))*&
&           psi_z-(delta_z(2)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 3) = (((delta_ydd(nd0, nd, 1)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 1)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(1)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 1)-m_ysd(nd))*&
&           psi_y-(delta_y(1)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 1)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 1)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(1)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 1)-m_zsd(nd))*&
&           psi_z-(delta_z(1)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 4) = (((delta_ydd(nd0, nd, 1)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 1)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(1)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 1)-m_ysd(nd))*&
&           psi_y-(delta_y(1)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3d0(:, :, :) = 0.0_8
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_z-(&
&         delta_z(2)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_y-(&
&         delta_y(2)-m_ys)*psi_yd0(nd0))/psi_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_z-(&
&         delta_z(1)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_y-(&
&         delta_y(2)-m_ys)*psi_yd0(nd0))/psi_y**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_z-(&
&         delta_z(2)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_y-(&
&         delta_y(1)-m_ys)*psi_yd0(nd0))/psi_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_z-(&
&         delta_z(1)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_y-(&
&         delta_y(1)-m_ys)*psi_yd0(nd0))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 3) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(1)-m_ys)/psi_y
      limit3(2, 4) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 4) = (delta_y(1)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(2, 1), -limit3d0(:, 2, 1), -limit3d(:, 2, &
&               1), -limit3dd(:, :, 2, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(1, 1), pcompd0(:, 1, 1), pcompd(:, 1, 1), pcompdd(&
&               :, :, 1, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 2), -limit3d0(:, 2, 2), -limit3d(:, 2, &
&               2), -limit3dd(:, :, 2, 2), -limit3(3, 2), -limit3d0(:, 3&
&               , 2), -limit3d(:, 3, 2), -limit3dd(:, :, 3, 2), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(2, 1), pcompd0(:, 2, 1), pcompd(:, 2, 1), pcompdd(&
&               :, :, 2, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 3), -limit3d0(:, 2, 3), -limit3d(:, 2, &
&               3), -limit3dd(:, :, 2, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(3, 1), pcompd0(:, 3, 1), pcompd(:, 3, 1), pcompdd(&
&               :, :, 3, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 4), -limit3d0(:, 2, 4), -limit3d(:, 2, &
&               4), -limit3dd(:, :, 2, 4), -limit3(3, 4), -limit3d0(:, 3&
&               , 4), -limit3d(:, 3, 4), -limit3dd(:, :, 3, 4), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(4, 1), pcompd0(:, 4, 1), pcompd(:, 4, 1), pcompdd(&
&               :, :, 4, 1), nbdirs, nbdirs0)
!
      p_zydd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 3) THEN
!
      limit3d(:, :, :) = 0.0_8
      limit3dd(:, :, :, :) = 0.0_8
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 2)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 2)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(2)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 2)-m_zsd(nd))*&
&           psi_z-(delta_z(2)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 1) = (((delta_ydd(nd0, nd, 3)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 3)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 3)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(3)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 3)-m_ysd(nd))*&
&           psi_y-(delta_y(3)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 1)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 1)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(1)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 1)-m_zsd(nd))*&
&           psi_z-(delta_z(1)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 2) = (((delta_ydd(nd0, nd, 3)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 3)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 3)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(3)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 3)-m_ysd(nd))*&
&           psi_y-(delta_y(3)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 2)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 2)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(2)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 2)-m_zsd(nd))*&
&           psi_z-(delta_z(2)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 3) = (((delta_ydd(nd0, nd, 2)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 2)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(2)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 2)-m_ysd(nd))*&
&           psi_y-(delta_y(2)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 1)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 1)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(1)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 1)-m_zsd(nd))*&
&           psi_z-(delta_z(1)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 4) = (((delta_ydd(nd0, nd, 2)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 2)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(2)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 2)-m_ysd(nd))*&
&           psi_y-(delta_y(2)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_ysd(nd))*psi_y-(delta_y(&
&         3)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 3)-m_ysd(nd))*psi_y-(delta_y(&
&         3)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3d0(:, :, :) = 0.0_8
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_z-(&
&         delta_z(2)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 3)-m_ysd0(nd0))*psi_y-(&
&         delta_y(3)-m_ys)*psi_yd0(nd0))/psi_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_z-(&
&         delta_z(1)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 3)-m_ysd0(nd0))*psi_y-(&
&         delta_y(3)-m_ys)*psi_yd0(nd0))/psi_y**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_z-(&
&         delta_z(2)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_y-(&
&         delta_y(2)-m_ys)*psi_yd0(nd0))/psi_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_z-(&
&         delta_z(1)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_y-(&
&         delta_y(2)-m_ys)*psi_yd0(nd0))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(3)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(3)-m_ys)/psi_y
      limit3(2, 3) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 4) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 4) = (delta_y(2)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(2, 1), -limit3d0(:, 2, 1), -limit3d(:, 2, &
&               1), -limit3dd(:, :, 2, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(1, 1), pcompd0(:, 1, 1), pcompd(:, 1, 1), pcompdd(&
&               :, :, 1, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 2), -limit3d0(:, 2, 2), -limit3d(:, 2, &
&               2), -limit3dd(:, :, 2, 2), -limit3(3, 2), -limit3d0(:, 3&
&               , 2), -limit3d(:, 3, 2), -limit3dd(:, :, 3, 2), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(2, 1), pcompd0(:, 2, 1), pcompd(:, 2, 1), pcompdd(&
&               :, :, 2, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 3), -limit3d0(:, 2, 3), -limit3d(:, 2, &
&               3), -limit3dd(:, :, 2, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(3, 1), pcompd0(:, 3, 1), pcompd(:, 3, 1), pcompdd(&
&               :, :, 3, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 4), -limit3d0(:, 2, 4), -limit3d(:, 2, &
&               4), -limit3dd(:, :, 2, 4), -limit3(3, 4), -limit3d0(:, 3&
&               , 4), -limit3d(:, 3, 4), -limit3dd(:, :, 3, 4), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(4, 1), pcompd0(:, 4, 1), pcompd(:, 4, 1), pcompdd(&
&               :, :, 4, 1), nbdirs, nbdirs0)
!
      p_zydd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 4) THEN
!
      limit3d(:, :, :) = 0.0_8
      limit3dd(:, :, :, :) = 0.0_8
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 2)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 2)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(2)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 2)-m_zsd(nd))*&
&           psi_z-(delta_z(2)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 1)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 1)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(1)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 1)-m_zsd(nd))*&
&           psi_z-(delta_z(1)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 2)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 2)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(2)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 2)-m_zsd(nd))*&
&           psi_z-(delta_z(2)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 3) = (((delta_ydd(nd0, nd, 3)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 3)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 3)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(3)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 3)-m_ysd(nd))*&
&           psi_y-(delta_y(3)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 1)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 1)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(1)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 1)-m_zsd(nd))*&
&           psi_z-(delta_z(1)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 4) = (((delta_ydd(nd0, nd, 3)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 3)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 3)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(3)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 3)-m_ysd(nd))*&
&           psi_y-(delta_y(3)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_ysd(nd))*psi_y-(delta_y(&
&         3)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 3)-m_ysd(nd))*psi_y-(delta_y(&
&         3)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3d0(:, :, :) = 0.0_8
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_z-(&
&         delta_z(2)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_z-(&
&         delta_z(1)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_z-(&
&         delta_z(2)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 3)-m_ysd0(nd0))*psi_y-(&
&         delta_y(3)-m_ys)*psi_yd0(nd0))/psi_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 1)-m_zsd0(nd0))*psi_z-(&
&         delta_z(1)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 3)-m_ysd0(nd0))*psi_y-(&
&         delta_y(3)-m_ys)*psi_yd0(nd0))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_zs)/psi_z
      limit3(2, 2) = (delta_z(1)-m_zs)/psi_z
      limit3(2, 3) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(3)-m_ys)/psi_y
      limit3(2, 4) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 4) = (delta_y(3)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL PHID_DV_DV(limit3(2, 1), limit3d0(:, 2, 1), limit3d(:, 2, 1)&
&               , limit3dd(:, :, 2, 1), pcomp(1, 1), pcompd0(:, 1, 1), &
&               pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL PHID_DV_DV(limit3(2, 2), limit3d0(:, 2, 2), limit3d(:, 2, 2)&
&               , limit3dd(:, :, 2, 2), pcomp(2, 1), pcompd0(:, 2, 1), &
&               pcompd(:, 2, 1), pcompdd(:, :, 2, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 3), -limit3d0(:, 2, 3), -limit3d(:, 2, &
&               3), -limit3dd(:, :, 2, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(3, 1), pcompd0(:, 3, 1), pcompd(:, 3, 1), pcompdd(&
&               :, :, 3, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 4), -limit3d0(:, 2, 4), -limit3d(:, 2, &
&               4), -limit3dd(:, :, 2, 4), -limit3(3, 4), -limit3d0(:, 3&
&               , 4), -limit3d(:, 3, 4), -limit3dd(:, :, 3, 4), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(4, 1), pcompd0(:, 4, 1), pcompd(:, 4, 1), pcompdd(&
&               :, :, 4, 1), nbdirs, nbdirs0)
!
      p_zydd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 1) THEN
!
      limit3d(:, :, :) = 0.0_8
      limit3dd(:, :, :, :) = 0.0_8
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          limit3dd(nd0, nd, 3, 1) = (((delta_ydd(nd0, nd, 1)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 1)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(1)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 1)-m_ysd(nd))*&
&           psi_y-(delta_y(1)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 2)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 2)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(2)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 2)-m_zsd(nd))*&
&           psi_z-(delta_z(2)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 2) = (((delta_ydd(nd0, nd, 1)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 1)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(1)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 1)-m_ysd(nd))*&
&           psi_y-(delta_y(1)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
        END DO
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3d0(:, :, :) = 0.0_8
      DO nd0=1,nbdirs0
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_y-(&
&         delta_y(1)-m_ys)*psi_yd0(nd0))/psi_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_z-(&
&         delta_z(2)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_y-(&
&         delta_y(1)-m_ys)*psi_yd0(nd0))/psi_y**2
      END DO
      limit3(3, 1) = (delta_y(1)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(1)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL PHID_DV_DV(limit3(3, 1), limit3d0(:, 3, 1), limit3d(:, 3, 1)&
&               , limit3dd(:, :, 3, 1), pcomp(1, 1), pcompd0(:, 1, 1), &
&               pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 2), -limit3d0(:, 2, 2), -limit3d(:, 2, &
&               2), -limit3dd(:, :, 2, 2), -limit3(3, 2), -limit3d0(:, 3&
&               , 2), -limit3d(:, 3, 2), -limit3dd(:, :, 3, 2), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(2, 1), pcompd0(:, 2, 1), pcompd(:, 2, 1), pcompdd(&
&               :, :, 2, 1), nbdirs, nbdirs0)
!
      p_zydd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 2) THEN
!
      limit3d(:, :, :) = 0.0_8
      limit3dd(:, :, :, :) = 0.0_8
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          limit3dd(nd0, nd, 3, 1) = (((delta_ydd(nd0, nd, 2)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 2)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(2)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 2)-m_ysd(nd))*&
&           psi_y-(delta_y(2)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 2)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 2)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(2)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 2)-m_zsd(nd))*&
&           psi_z-(delta_z(2)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 2) = (((delta_ydd(nd0, nd, 2)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 2)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(2)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 2)-m_ysd(nd))*&
&           psi_y-(delta_y(2)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
          limit3dd(nd0, nd, 3, 3) = (((delta_ydd(nd0, nd, 1)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 1)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(1)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 1)-m_ysd(nd))*&
&           psi_y-(delta_y(1)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 2)-m_zsdd(nd0&
&           , nd))*psi_z+(delta_zd(nd, 2)-m_zsd(nd))*psi_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_zd(nd)-(delta_z(2)-m_zs)*&
&           psi_zdd(nd0, nd))*psi_z**2-((delta_zd(nd, 2)-m_zsd(nd))*&
&           psi_z-(delta_z(2)-m_zs)*psi_zd(nd))*2*psi_z*psi_zd0(nd0))/(&
&           psi_z**2)**2
          limit3dd(nd0, nd, 3, 4) = (((delta_ydd(nd0, nd, 1)-m_ysdd(nd0&
&           , nd))*psi_y+(delta_yd(nd, 1)-m_ysd(nd))*psi_yd0(nd0)-(&
&           delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_yd(nd)-(delta_y(1)-m_ys)*&
&           psi_ydd(nd0, nd))*psi_y**2-((delta_yd(nd, 1)-m_ysd(nd))*&
&           psi_y-(delta_y(1)-m_ys)*psi_yd(nd))*2*psi_y*psi_yd0(nd0))/(&
&           psi_y**2)**2
        END DO
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3d0(:, :, :) = 0.0_8
      DO nd0=1,nbdirs0
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_y-(&
&         delta_y(2)-m_ys)*psi_yd0(nd0))/psi_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_z-(&
&         delta_z(2)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 2)-m_ysd0(nd0))*psi_y-(&
&         delta_y(2)-m_ys)*psi_yd0(nd0))/psi_y**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_y-(&
&         delta_y(1)-m_ys)*psi_yd0(nd0))/psi_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 2)-m_zsd0(nd0))*psi_z-(&
&         delta_z(2)-m_zs)*psi_zd0(nd0))/psi_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 1)-m_ysd0(nd0))*psi_y-(&
&         delta_y(1)-m_ys)*psi_yd0(nd0))/psi_y**2
      END DO
      limit3(3, 1) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(2)-m_ys)/psi_y
      limit3(3, 3) = (delta_y(1)-m_ys)/psi_y
      limit3(2, 4) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 4) = (delta_y(1)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL PHID_DV_DV(limit3(3, 1), limit3d0(:, 3, 1), limit3d(:, 3, 1)&
&               , limit3dd(:, :, 3, 1), pcomp(1, 1), pcompd0(:, 1, 1), &
&               pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 2), -limit3d0(:, 2, 2), -limit3d(:, 2, &
&               2), -limit3dd(:, :, 2, 2), -limit3(3, 2), -limit3d0(:, 3&
&               , 2), -limit3d(:, 3, 2), -limit3dd(:, :, 3, 2), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(2, 1), pcompd0(:, 2, 1), pcompd(:, 2, 1), pcompdd(&
&               :, :, 2, 1), nbdirs, nbdirs0)
      CALL PHID_DV_DV(limit3(3, 3), limit3d0(:, 3, 3), limit3d(:, 3, 3)&
&               , limit3dd(:, :, 3, 3), pcomp(3, 1), pcompd0(:, 3, 1), &
&               pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 4), -limit3d0(:, 2, 4), -limit3d(:, 2, &
&               4), -limit3dd(:, :, 2, 4), -limit3(3, 4), -limit3d0(:, 3&
&               , 4), -limit3d(:, 3, 4), -limit3dd(:, :, 3, 4), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(4, 1), pcompd0(:, 4, 1), pcompd(:, 4, 1), pcompdd(&
&               :, :, 4, 1), nbdirs, nbdirs0)
!
      p_zydd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 3) THEN
!
      limit3d(:, :, :) = 0.0_8
      limit3dd(:, :, :, :) = 0.0_8
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 2) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 4) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3d0(:, :, :) = 0.0_8
      DO nd0=1,nbdirs0
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL PHID_DV_DV(limit3(3, 1), limit3d0(:, 3, 1), limit3d(:, 3, 1)&
&               , limit3dd(:, :, 3, 1), pcomp(1, 1), pcompd0(:, 1, 1), &
&               pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 2), -limit3d0(:, 2, 2), -limit3d(:, 2, &
&               2), -limit3dd(:, :, 2, 2), -limit3(3, 2), -limit3d0(:, 3&
&               , 2), -limit3d(:, 3, 2), -limit3dd(:, :, 3, 2), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(2, 1), pcompd0(:, 2, 1), pcompd(:, 2, 1), pcompdd(&
&               :, :, 2, 1), nbdirs, nbdirs0)
      CALL PHID_DV_DV(limit3(3, 3), limit3d0(:, 3, 3), limit3d(:, 3, 3)&
&               , limit3dd(:, :, 3, 3), pcomp(3, 1), pcompd0(:, 3, 1), &
&               pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 4), -limit3d0(:, 2, 4), -limit3d(:, 2, &
&               4), -limit3dd(:, :, 2, 4), -limit3(3, 4), -limit3d0(:, 3&
&               , 4), -limit3d(:, 3, 4), -limit3dd(:, :, 3, 4), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(4, 1), pcompd0(:, 4, 1), pcompd(:, 4, 1), pcompdd(&
&               :, :, 4, 1), nbdirs, nbdirs0)
!
      p_zydd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 4) THEN
!
      limit3d(:, :, :) = 0.0_8
      limit3dd(:, :, :, :) = 0.0_8
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 4) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3d0(:, :, :) = 0.0_8
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcomp(1, 1) = 1.d0
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL PHID_DV_DV(limit3(2, 2), limit3d0(:, 2, 2), limit3d(:, 2, 2)&
&               , limit3dd(:, :, 2, 2), pcomp(2, 1), pcompd0(:, 2, 1), &
&               pcompd(:, 2, 1), pcompdd(:, :, 2, 1), nbdirs, nbdirs0)
      CALL PHID_DV_DV(limit3(3, 3), limit3d0(:, 3, 3), limit3d(:, 3, 3)&
&               , limit3dd(:, :, 3, 3), pcomp(3, 1), pcompd0(:, 3, 1), &
&               pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 4), -limit3d0(:, 2, 4), -limit3d(:, 2, &
&               4), -limit3dd(:, :, 2, 4), -limit3(3, 4), -limit3d0(:, 3&
&               , 4), -limit3d(:, 3, 4), -limit3dd(:, :, 3, 4), &
&               rho_psi_zy, rho_psi_zyd0, rho_psi_zyd, rho_psi_zydd, &
&               pcomp(4, 1), pcompd0(:, 4, 1), pcompd(:, 4, 1), pcompdd(&
&               :, :, 4, 1), nbdirs, nbdirs0)
!
      p_zydd(:, :) = 0.0_8
    ELSE
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      pcompd0(:, :, :) = 0.0_8
      p_zydd(:, :) = 0.0_8
    END IF
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
!
        p_zydd(nd0, nd) = pcompdd(nd0, nd, 1, 1) - pcompdd(nd0, nd, 2, 1&
&         ) - pcompdd(nd0, nd, 3, 1) + pcompdd(nd0, nd, 4, 1)
      END DO
      p_zyd(nd) = pcompd(nd, 1, 1) - pcompd(nd, 2, 1) - pcompd(nd, 3, 1)&
&       + pcompd(nd, 4, 1)
    END DO
    DO nd0=1,nbdirs0
      p_zyd0(nd0) = pcompd0(nd0, 1, 1) - pcompd0(nd0, 2, 1) - pcompd0(&
&       nd0, 3, 1) + pcompd0(nd0, 4, 1)
    END DO
    p_zy = pcomp(1, 1) - pcomp(2, 1) - pcomp(3, 1) + pcomp(4, 1)
    pdd(:, :) = 0.0_8
  CASE (2) 
! 
! as = 0
! 
! joint probability
! 
    p_zy = 1.d0
    limit3d(:, :, :) = 0.0_8
    corr3dd(:, :, :) = 0.0_8
    limit3dd(:, :, :, :) = 0.0_8
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        corr3dd(nd0, nd, :) = (/rho_szdd(nd0, nd), rho_sydd(nd0, nd), &
&         rho_zydd(nd0, nd)/)
        limit3dd(nd0, nd, 1, :) = -(((m_sd(nd)*sigma_sd0(nd0)-m_sd0(nd0)&
&         *sigma_sd(nd)-m_s*sigma_sdd(nd0, nd))*sigma_s**2-(m_sd(nd)*&
&         sigma_s-m_s*sigma_sd(nd))*2*sigma_s*sigma_sd0(nd0))/(sigma_s**&
&         2)**2)
      END DO
      corr3d(nd, :) = (/rho_szd(nd), rho_syd(nd), rho_zyd(nd)/)
      limit3d(nd, 1, :) = -((m_sd(nd)*sigma_s-m_s*sigma_sd(nd))/sigma_s&
&       **2)
    END DO
    limit3d0(:, :, :) = 0.0_8
    DO nd0=1,nbdirs0
      corr3d0(nd0, :) = (/rho_szd0(nd0), rho_syd0(nd0), rho_zyd0(nd0)/)
      limit3d0(nd0, 1, :) = -((m_sd0(nd0)*sigma_s-m_s*sigma_sd0(nd0))/&
&       sigma_s**2)
    END DO
    corr3 = (/rho_sz, rho_sy, rho_zy/)
    limit3(1, :) = -(m_s/sigma_s)
    eps = 1.d-13
!
    IF (riskavn .EQ. 1 .AND. horizonn .EQ. 1) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL TVTL_DV_DV(0, limit3(:, 1), limit3d0(:, :, 1), limit3d(:, :, &
&               1), limit3dd(:, :, :, 1), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(1, 1), pcompd0(:, 1, 1), pcompd(:, 1&
&               , 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 2) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL TVTL_DV_DV(0, limit3(:, 1), limit3d0(:, :, 1), limit3d(:, :, &
&               1), limit3dd(:, :, :, 1), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(1, 1), pcompd0(:, 1, 1), pcompd(:, 1&
&               , 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 3), limit3d0(:, :, 3), limit3d(:, :, &
&               3), limit3dd(:, :, :, 3), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(3, 1), pcompd0(:, 3, 1), pcompd(:, 3&
&               , 1), pcompdd(:, :, 3, 1), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 3) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL TVTL_DV_DV(0, limit3(:, 1), limit3d0(:, :, 1), limit3d(:, :, &
&               1), limit3dd(:, :, :, 1), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(1, 1), pcompd0(:, 1, 1), pcompd(:, 1&
&               , 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 3), limit3d0(:, :, 3), limit3d(:, :, &
&               3), limit3dd(:, :, :, 3), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(3, 1), pcompd0(:, 3, 1), pcompd(:, 3&
&               , 1), pcompdd(:, :, 3, 1), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 4) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(1, 1), -limit3d0(:, 1, 1), -limit3d(:, 1, &
&               1), -limit3dd(:, :, 1, 1), -limit3(2, 1), -limit3d0(:, 2&
&               , 1), -limit3d(:, 2, 1), -limit3dd(:, :, 2, 1), rho_sz, &
&               rho_szd0, rho_szd, rho_szdd, pcomp(1, 1), pcompd0(:, 1, &
&               1), pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 3), limit3d0(:, :, 3), limit3d(:, :, &
&               3), limit3dd(:, :, :, 3), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(3, 1), pcompd0(:, 3, 1), pcompd(:, 3&
&               , 1), pcompdd(:, :, 3, 1), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 1) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 2) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL TVTL_DV_DV(0, limit3(:, 1), limit3d0(:, :, 1), limit3d(:, :, &
&               1), limit3dd(:, :, :, 1), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(1, 1), pcompd0(:, 1, 1), pcompd(:, 1&
&               , 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 2), limit3d0(:, :, 2), limit3d(:, :, &
&               2), limit3dd(:, :, :, 2), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(2, 1), pcompd0(:, 2, 1), pcompd(:, 2&
&               , 1), pcompdd(:, :, 2, 1), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 2) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 2) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 4) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL TVTL_DV_DV(0, limit3(:, 1), limit3d0(:, :, 1), limit3d(:, :, &
&               1), limit3dd(:, :, :, 1), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(1, 1), pcompd0(:, 1, 1), pcompd(:, 1&
&               , 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 2), limit3d0(:, :, 2), limit3d(:, :, &
&               2), limit3dd(:, :, :, 2), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(2, 1), pcompd0(:, 2, 1), pcompd(:, 2&
&               , 1), pcompdd(:, :, 2, 1), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 3), limit3d0(:, :, 3), limit3d(:, :, &
&               3), limit3dd(:, :, :, 3), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(3, 1), pcompd0(:, 3, 1), pcompd(:, 3&
&               , 1), pcompdd(:, :, 3, 1), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 4), limit3d0(:, :, 4), limit3d(:, :, &
&               4), limit3dd(:, :, :, 4), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(4, 1), pcompd0(:, 4, 1), pcompd(:, 4&
&               , 1), pcompdd(:, :, 4, 1), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 3) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 2) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 4) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL TVTL_DV_DV(0, limit3(:, 1), limit3d0(:, :, 1), limit3d(:, :, &
&               1), limit3dd(:, :, :, 1), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(1, 1), pcompd0(:, 1, 1), pcompd(:, 1&
&               , 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 2), limit3d0(:, :, 2), limit3d(:, :, &
&               2), limit3dd(:, :, :, 2), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(2, 1), pcompd0(:, 2, 1), pcompd(:, 2&
&               , 1), pcompdd(:, :, 2, 1), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 3), limit3d0(:, :, 3), limit3d(:, :, &
&               3), limit3dd(:, :, :, 3), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(3, 1), pcompd0(:, 3, 1), pcompd(:, 3&
&               , 1), pcompdd(:, :, 3, 1), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 4), limit3d0(:, :, 4), limit3d(:, :, &
&               4), limit3dd(:, :, :, 4), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(4, 1), pcompd0(:, 4, 1), pcompd(:, 4&
&               , 1), pcompdd(:, :, 4, 1), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 4) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 4) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(1, 1), -limit3d0(:, 1, 1), -limit3d(:, 1, &
&               1), -limit3dd(:, :, 1, 1), -limit3(2, 1), -limit3d0(:, 2&
&               , 1), -limit3d(:, 2, 1), -limit3dd(:, :, 2, 1), rho_sz, &
&               rho_szd0, rho_szd, rho_szdd, pcomp(1, 1), pcompd0(:, 1, &
&               1), pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(1, 2), -limit3d0(:, 1, 2), -limit3d(:, 1, &
&               2), -limit3dd(:, :, 1, 2), -limit3(2, 2), -limit3d0(:, 2&
&               , 2), -limit3d(:, 2, 2), -limit3dd(:, :, 2, 2), rho_sz, &
&               rho_szd0, rho_szd, rho_szdd, pcomp(2, 1), pcompd0(:, 2, &
&               1), pcompd(:, 2, 1), pcompdd(:, :, 2, 1), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 3), limit3d0(:, :, 3), limit3d(:, :, &
&               3), limit3dd(:, :, :, 3), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(3, 1), pcompd0(:, 3, 1), pcompd(:, 3&
&               , 1), pcompdd(:, :, 3, 1), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 4), limit3d0(:, :, 4), limit3d(:, :, &
&               4), limit3dd(:, :, :, 4), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(4, 1), pcompd0(:, 4, 1), pcompd(:, 4&
&               , 1), pcompdd(:, :, 4, 1), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 1) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 2) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(1, 1), -limit3d0(:, 1, 1), -limit3d(:, 1, &
&               1), -limit3dd(:, :, 1, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), rho_sy, &
&               rho_syd0, rho_syd, rho_sydd, pcomp(1, 1), pcompd0(:, 1, &
&               1), pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 2), limit3d0(:, :, 2), limit3d(:, :, &
&               2), limit3dd(:, :, :, 2), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(2, 1), pcompd0(:, 2, 1), pcompd(:, 2&
&               , 1), pcompdd(:, :, 2, 1), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 2) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 2) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 4) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(2)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(1, 1), -limit3d0(:, 1, 1), -limit3d(:, 1, &
&               1), -limit3dd(:, :, 1, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), rho_sy, &
&               rho_syd0, rho_syd, rho_sydd, pcomp(1, 1), pcompd0(:, 1, &
&               1), pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 2), limit3d0(:, :, 2), limit3d(:, :, &
&               2), limit3dd(:, :, :, 2), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(2, 1), pcompd0(:, 2, 1), pcompd(:, 2&
&               , 1), pcompdd(:, :, 2, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(1, 3), -limit3d0(:, 1, 3), -limit3d(:, 1, &
&               3), -limit3dd(:, :, 1, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), rho_sy, &
&               rho_syd0, rho_syd, rho_sydd, pcomp(3, 1), pcompd0(:, 3, &
&               1), pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 4), limit3d0(:, :, 4), limit3d(:, :, &
&               4), limit3dd(:, :, :, 4), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(4, 1), pcompd0(:, 4, 1), pcompd(:, 4&
&               , 1), pcompdd(:, :, 4, 1), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 3) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 2) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 4) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(1, 1), -limit3d0(:, 1, 1), -limit3d(:, 1, &
&               1), -limit3dd(:, :, 1, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), rho_sy, &
&               rho_syd0, rho_syd, rho_sydd, pcomp(1, 1), pcompd0(:, 1, &
&               1), pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 2), limit3d0(:, :, 2), limit3d(:, :, &
&               2), limit3dd(:, :, :, 2), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(2, 1), pcompd0(:, 2, 1), pcompd(:, 2&
&               , 1), pcompdd(:, :, 2, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(1, 3), -limit3d0(:, 1, 3), -limit3d(:, 1, &
&               3), -limit3dd(:, :, 1, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), rho_sy, &
&               rho_syd0, rho_syd, rho_sydd, pcomp(3, 1), pcompd0(:, 3, &
&               1), pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 4), limit3d0(:, :, 4), limit3d(:, :, &
&               4), limit3dd(:, :, :, 4), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(4, 1), pcompd0(:, 4, 1), pcompd(:, 4&
&               , 1), pcompdd(:, :, 4, 1), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 4) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 4) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcomp(1, 1) = 1.d0
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(1, 2), -limit3d0(:, 1, 2), -limit3d(:, 1, &
&               2), -limit3dd(:, :, 1, 2), -limit3(2, 2), -limit3d0(:, 2&
&               , 2), -limit3d(:, 2, 2), -limit3dd(:, :, 2, 2), rho_sz, &
&               rho_szd0, rho_szd, rho_szdd, pcomp(2, 1), pcompd0(:, 2, &
&               1), pcompd(:, 2, 1), pcompdd(:, :, 2, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(1, 3), -limit3d0(:, 1, 3), -limit3d(:, 1, &
&               3), -limit3dd(:, :, 1, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), rho_sy, &
&               rho_syd0, rho_syd, rho_sydd, pcomp(3, 1), pcompd0(:, 3, &
&               1), pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 4), limit3d0(:, :, 4), limit3d(:, :, &
&               4), limit3dd(:, :, :, 4), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(4, 1), pcompd0(:, 4, 1), pcompd(:, 4&
&               , 1), pcompdd(:, :, 4, 1), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      pcompd0(:, :, :) = 0.0_8
      p_asdd(:, :) = 0.0_8
    END IF
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
!
        p_asdd(nd0, nd) = pcompdd(nd0, nd, 1, 1) - pcompdd(nd0, nd, 2, 1&
&         ) - pcompdd(nd0, nd, 3, 1) + pcompdd(nd0, nd, 4, 1)
      END DO
      p_asd(nd) = pcompd(nd, 1, 1) - pcompd(nd, 2, 1) - pcompd(nd, 3, 1)&
&       + pcompd(nd, 4, 1)
    END DO
    DO nd0=1,nbdirs0
      p_asd0(nd0) = pcompd0(nd0, 1, 1) - pcompd0(nd0, 2, 1) - pcompd0(&
&       nd0, 3, 1) + pcompd0(nd0, 4, 1)
    END DO
    p_as = pcomp(1, 1) - pcomp(2, 1) - pcomp(3, 1) + pcomp(4, 1)
    p_zyd(:) = 0.0_8
    pdd(:, :) = 0.0_8
    p_zydd(:, :) = 0.0_8
    p_zyd0(:) = 0.0_8
  CASE (3) 
! 
! as = 1
! 
! joint probability
! 
    p_zy = 1.d0
    limit3d(:, :, :) = 0.0_8
    corr3dd(:, :, :) = 0.0_8
    limit3dd(:, :, :, :) = 0.0_8
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
        corr3dd(nd0, nd, :) = (/rho_szdd(nd0, nd), rho_sydd(nd0, nd), &
&         rho_zydd(nd0, nd)/)
        limit3dd(nd0, nd, 1, :) = ((qdd(nd0, nd)*sigma_s+(qd(nd)-m_sd(nd&
&         ))*sigma_sd0(nd0)-(qd0(nd0)-m_sd0(nd0))*sigma_sd(nd)-(q-m_s)*&
&         sigma_sdd(nd0, nd))*sigma_s**2-((qd(nd)-m_sd(nd))*sigma_s-(q-&
&         m_s)*sigma_sd(nd))*2*sigma_s*sigma_sd0(nd0))/(sigma_s**2)**2
      END DO
      corr3d(nd, :) = (/rho_szd(nd), rho_syd(nd), rho_zyd(nd)/)
      limit3d(nd, 1, :) = ((qd(nd)-m_sd(nd))*sigma_s-(q-m_s)*sigma_sd(nd&
&       ))/sigma_s**2
    END DO
    limit3d0(:, :, :) = 0.0_8
    DO nd0=1,nbdirs0
      corr3d0(nd0, :) = (/rho_szd0(nd0), rho_syd0(nd0), rho_zyd0(nd0)/)
      limit3d0(nd0, 1, :) = ((qd0(nd0)-m_sd0(nd0))*sigma_s-(q-m_s)*&
&       sigma_sd0(nd0))/sigma_s**2
    END DO
    corr3 = (/rho_sz, rho_sy, rho_zy/)
    limit3(1, :) = (q-m_s)/sigma_s
    eps = 1.d-13
!
    IF (riskavn .EQ. 1 .AND. horizonn .EQ. 1) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(2, 1), -limit3d0(:, 2, 1), -limit3d(:, 2, &
&               1), -limit3dd(:, :, 2, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(1, 1), pcompd0(:, 1, &
&               1), pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 1), limit3d0(:, :, 1), limit3d(:, :, &
&               1), limit3dd(:, :, :, 1), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(1, 2), pcompd0(:, 1, 2), pcompd(:, 1&
&               , 2), pcompdd(:, :, 1, 2), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 2) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(2, 1), -limit3d0(:, 2, 1), -limit3d(:, 2, &
&               1), -limit3dd(:, :, 2, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(1, 1), pcompd0(:, 1, &
&               1), pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 3), -limit3d0(:, 2, 3), -limit3d(:, 2, &
&               3), -limit3dd(:, :, 2, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(3, 1), pcompd0(:, 3, &
&               1), pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 1), limit3d0(:, :, 1), limit3d(:, :, &
&               1), limit3dd(:, :, :, 1), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(1, 2), pcompd0(:, 1, 2), pcompd(:, 1&
&               , 2), pcompdd(:, :, 1, 2), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 3), limit3d0(:, :, 3), limit3d(:, :, &
&               3), limit3dd(:, :, :, 3), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(3, 2), pcompd0(:, 3, 2), pcompd(:, 3&
&               , 2), pcompdd(:, :, 3, 2), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 3) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(2, 1), -limit3d0(:, 2, 1), -limit3d(:, 2, &
&               1), -limit3dd(:, :, 2, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(1, 1), pcompd0(:, 1, &
&               1), pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 3), -limit3d0(:, 2, 3), -limit3d(:, 2, &
&               3), -limit3dd(:, :, 2, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(3, 1), pcompd0(:, 3, &
&               1), pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 1), limit3d0(:, :, 1), limit3d(:, :, &
&               1), limit3dd(:, :, :, 1), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(1, 2), pcompd0(:, 1, 2), pcompd(:, 1&
&               , 2), pcompdd(:, :, 1, 2), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 3), limit3d0(:, :, 3), limit3d(:, :, &
&               3), limit3dd(:, :, :, 3), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(3, 2), pcompd0(:, 3, 2), pcompd(:, 3&
&               , 2), pcompdd(:, :, 3, 2), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 4) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL PHID_DV_DV(limit3(2, 1), limit3d0(:, 2, 1), limit3d(:, 2, 1)&
&               , limit3dd(:, :, 2, 1), pcomp(1, 1), pcompd0(:, 1, 1), &
&               pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 3), -limit3d0(:, 2, 3), -limit3d(:, 2, &
&               3), -limit3dd(:, :, 2, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(3, 1), pcompd0(:, 3, &
&               1), pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(1, 1), -limit3d0(:, 1, 1), -limit3d(:, 1, &
&               1), -limit3dd(:, :, 1, 1), -limit3(2, 1), -limit3d0(:, 2&
&               , 1), -limit3d(:, 2, 1), -limit3dd(:, :, 2, 1), rho_sz, &
&               rho_szd0, rho_szd, rho_szdd, pcomp(1, 2), pcompd0(:, 1, &
&               2), pcompd(:, 1, 2), pcompdd(:, :, 1, 2), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 3), limit3d0(:, :, 3), limit3d(:, :, &
&               3), limit3dd(:, :, :, 3), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(3, 2), pcompd0(:, 3, 2), pcompd(:, 3&
&               , 2), pcompdd(:, :, 3, 2), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 1) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 2) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(2, 1), -limit3d0(:, 2, 1), -limit3d(:, 2, &
&               1), -limit3dd(:, :, 2, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(1, 1), pcompd0(:, 1, &
&               1), pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 2), -limit3d0(:, 2, 2), -limit3d(:, 2, &
&               2), -limit3dd(:, :, 2, 2), -limit3(3, 2), -limit3d0(:, 3&
&               , 2), -limit3d(:, 3, 2), -limit3dd(:, :, 3, 2), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(2, 1), pcompd0(:, 2, &
&               1), pcompd(:, 2, 1), pcompdd(:, :, 2, 1), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 1), limit3d0(:, :, 1), limit3d(:, :, &
&               1), limit3dd(:, :, :, 1), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(1, 2), pcompd0(:, 1, 2), pcompd(:, 1&
&               , 2), pcompdd(:, :, 1, 2), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 2), limit3d0(:, :, 2), limit3d(:, :, &
&               2), limit3dd(:, :, :, 2), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(2, 2), pcompd0(:, 2, 2), pcompd(:, 2&
&               , 2), pcompdd(:, :, 2, 2), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 2) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 2) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 4) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(2, 1), -limit3d0(:, 2, 1), -limit3d(:, 2, &
&               1), -limit3dd(:, :, 2, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(1, 1), pcompd0(:, 1, &
&               1), pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 2), -limit3d0(:, 2, 2), -limit3d(:, 2, &
&               2), -limit3dd(:, :, 2, 2), -limit3(3, 2), -limit3d0(:, 3&
&               , 2), -limit3d(:, 3, 2), -limit3dd(:, :, 3, 2), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(2, 1), pcompd0(:, 2, &
&               1), pcompd(:, 2, 1), pcompdd(:, :, 2, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 3), -limit3d0(:, 2, 3), -limit3d(:, 2, &
&               3), -limit3dd(:, :, 2, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(3, 1), pcompd0(:, 3, &
&               1), pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 4), -limit3d0(:, 2, 4), -limit3d(:, 2, &
&               4), -limit3dd(:, :, 2, 4), -limit3(3, 4), -limit3d0(:, 3&
&               , 4), -limit3d(:, 3, 4), -limit3dd(:, :, 3, 4), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(4, 1), pcompd0(:, 4, &
&               1), pcompd(:, 4, 1), pcompdd(:, :, 4, 1), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 1), limit3d0(:, :, 1), limit3d(:, :, &
&               1), limit3dd(:, :, :, 1), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(1, 2), pcompd0(:, 1, 2), pcompd(:, 1&
&               , 2), pcompdd(:, :, 1, 2), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 2), limit3d0(:, :, 2), limit3d(:, :, &
&               2), limit3dd(:, :, :, 2), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(2, 2), pcompd0(:, 2, 2), pcompd(:, 2&
&               , 2), pcompdd(:, :, 2, 2), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 3), limit3d0(:, :, 3), limit3d(:, :, &
&               3), limit3dd(:, :, :, 3), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(3, 2), pcompd0(:, 3, 2), pcompd(:, 3&
&               , 2), pcompdd(:, :, 3, 2), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 4), limit3d0(:, :, 4), limit3d(:, :, &
&               4), limit3dd(:, :, :, 4), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(4, 2), pcompd0(:, 4, 2), pcompd(:, 4&
&               , 2), pcompdd(:, :, 4, 2), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 3) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 2) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 4) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL BVND_DV_DV(-limit3(2, 1), -limit3d0(:, 2, 1), -limit3d(:, 2, &
&               1), -limit3dd(:, :, 2, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(1, 1), pcompd0(:, 1, &
&               1), pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 2), -limit3d0(:, 2, 2), -limit3d(:, 2, &
&               2), -limit3dd(:, :, 2, 2), -limit3(3, 2), -limit3d0(:, 3&
&               , 2), -limit3d(:, 3, 2), -limit3dd(:, :, 3, 2), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(2, 1), pcompd0(:, 2, &
&               1), pcompd(:, 2, 1), pcompdd(:, :, 2, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 3), -limit3d0(:, 2, 3), -limit3d(:, 2, &
&               3), -limit3dd(:, :, 2, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(3, 1), pcompd0(:, 3, &
&               1), pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 4), -limit3d0(:, 2, 4), -limit3d(:, 2, &
&               4), -limit3dd(:, :, 2, 4), -limit3(3, 4), -limit3d0(:, 3&
&               , 4), -limit3d(:, 3, 4), -limit3dd(:, :, 3, 4), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(4, 1), pcompd0(:, 4, &
&               1), pcompd(:, 4, 1), pcompdd(:, :, 4, 1), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 1), limit3d0(:, :, 1), limit3d(:, :, &
&               1), limit3dd(:, :, :, 1), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(1, 2), pcompd0(:, 1, 2), pcompd(:, 1&
&               , 2), pcompdd(:, :, 1, 2), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 2), limit3d0(:, :, 2), limit3d(:, :, &
&               2), limit3dd(:, :, :, 2), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(2, 2), pcompd0(:, 2, 2), pcompd(:, 2&
&               , 2), pcompdd(:, :, 2, 2), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 3), limit3d0(:, :, 3), limit3d(:, :, &
&               3), limit3dd(:, :, :, 3), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(3, 2), pcompd0(:, 3, 2), pcompd(:, 3&
&               , 2), pcompdd(:, :, 3, 2), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 4), limit3d0(:, :, 4), limit3d(:, :, &
&               4), limit3dd(:, :, :, 4), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(4, 2), pcompd0(:, 4, 2), pcompd(:, 4&
&               , 2), pcompdd(:, :, 4, 2), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 4) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 1) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 2, 3) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 1)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 1)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(1)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 1)-m_zd(nd))*&
&           sigma_z-(delta_z(1)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 4) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 1) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 2, 3) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 1)-m_zd0(nd0))*sigma_z-(&
&         delta_z(1)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL PHID_DV_DV(limit3(2, 1), limit3d0(:, 2, 1), limit3d(:, 2, 1)&
&               , limit3dd(:, :, 2, 1), pcomp(1, 1), pcompd0(:, 1, 1), &
&               pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL PHID_DV_DV(limit3(2, 2), limit3d0(:, 2, 2), limit3d(:, 2, 2)&
&               , limit3dd(:, :, 2, 2), pcomp(2, 1), pcompd0(:, 2, 1), &
&               pcompd(:, 2, 1), pcompdd(:, :, 2, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 3), -limit3d0(:, 2, 3), -limit3d(:, 2, &
&               3), -limit3dd(:, :, 2, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(3, 1), pcompd0(:, 3, &
&               1), pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 4), -limit3d0(:, 2, 4), -limit3d(:, 2, &
&               4), -limit3dd(:, :, 2, 4), -limit3(3, 4), -limit3d0(:, 3&
&               , 4), -limit3d(:, 3, 4), -limit3dd(:, :, 3, 4), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(4, 1), pcompd0(:, 4, &
&               1), pcompd(:, 4, 1), pcompdd(:, :, 4, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(1, 1), -limit3d0(:, 1, 1), -limit3d(:, 1, &
&               1), -limit3dd(:, :, 1, 1), -limit3(2, 1), -limit3d0(:, 2&
&               , 1), -limit3d(:, 2, 1), -limit3dd(:, :, 2, 1), rho_sz, &
&               rho_szd0, rho_szd, rho_szdd, pcomp(1, 2), pcompd0(:, 1, &
&               2), pcompd(:, 1, 2), pcompdd(:, :, 1, 2), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(1, 2), -limit3d0(:, 1, 2), -limit3d(:, 1, &
&               2), -limit3dd(:, :, 1, 2), -limit3(2, 2), -limit3d0(:, 2&
&               , 2), -limit3d(:, 2, 2), -limit3dd(:, :, 2, 2), rho_sz, &
&               rho_szd0, rho_szd, rho_szdd, pcomp(2, 2), pcompd0(:, 2, &
&               2), pcompd(:, 2, 2), pcompdd(:, :, 2, 2), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 3), limit3d0(:, :, 3), limit3d(:, :, &
&               3), limit3dd(:, :, :, 3), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(3, 2), pcompd0(:, 3, 2), pcompd(:, 3&
&               , 2), pcompdd(:, :, 3, 2), nbdirs, nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 4), limit3d0(:, :, 4), limit3d(:, :, &
&               4), limit3dd(:, :, :, 4), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(4, 2), pcompd0(:, 4, 2), pcompd(:, 4&
&               , 2), pcompdd(:, :, 4, 2), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 1) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 2) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL PHID_DV_DV(limit3(3, 1), limit3d0(:, 3, 1), limit3d(:, 3, 1)&
&               , limit3dd(:, :, 3, 1), pcomp(1, 1), pcompd0(:, 1, 1), &
&               pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 2), -limit3d0(:, 2, 2), -limit3d(:, 2, &
&               2), -limit3dd(:, :, 2, 2), -limit3(3, 2), -limit3d0(:, 3&
&               , 2), -limit3d(:, 3, 2), -limit3dd(:, :, 3, 2), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(2, 1), pcompd0(:, 2, &
&               1), pcompd(:, 2, 1), pcompdd(:, :, 2, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(1, 1), -limit3d0(:, 1, 1), -limit3d(:, 1, &
&               1), -limit3dd(:, :, 1, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), rho_sy, &
&               rho_syd0, rho_syd, rho_sydd, pcomp(1, 2), pcompd0(:, 1, &
&               2), pcompd(:, 1, 2), pcompdd(:, :, 1, 2), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 2), limit3d0(:, :, 2), limit3d(:, :, &
&               2), limit3dd(:, :, :, 2), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(2, 2), pcompd0(:, 2, 2), pcompd(:, 2&
&               , 2), pcompdd(:, :, 2, 2), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 2) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 2) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 4) = ((delta_ydd(nd0, nd, 1)*sigma_y+(&
&           delta_yd(nd, 1)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 1)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(1)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y(1)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 1)-m_yd0(nd0))*sigma_y-(&
&         delta_y(1)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(2)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL PHID_DV_DV(limit3(3, 1), limit3d0(:, 3, 1), limit3d(:, 3, 1)&
&               , limit3dd(:, :, 3, 1), pcomp(1, 1), pcompd0(:, 1, 1), &
&               pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 2), -limit3d0(:, 2, 2), -limit3d(:, 2, &
&               2), -limit3dd(:, :, 2, 2), -limit3(3, 2), -limit3d0(:, 3&
&               , 2), -limit3d(:, 3, 2), -limit3dd(:, :, 3, 2), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(2, 1), pcompd0(:, 2, &
&               1), pcompd(:, 2, 1), pcompdd(:, :, 2, 1), nbdirs, &
&               nbdirs0)
      CALL PHID_DV_DV(limit3(3, 3), limit3d0(:, 3, 3), limit3d(:, 3, 3)&
&               , limit3dd(:, :, 3, 3), pcomp(3, 1), pcompd0(:, 3, 1), &
&               pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 4), -limit3d0(:, 2, 4), -limit3d(:, 2, &
&               4), -limit3dd(:, :, 2, 4), -limit3(3, 4), -limit3d0(:, 3&
&               , 4), -limit3d(:, 3, 4), -limit3dd(:, :, 3, 4), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(4, 1), pcompd0(:, 4, &
&               1), pcompd(:, 4, 1), pcompdd(:, :, 4, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(1, 1), -limit3d0(:, 1, 1), -limit3d(:, 1, &
&               1), -limit3dd(:, :, 1, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), rho_sy, &
&               rho_syd0, rho_syd, rho_sydd, pcomp(1, 2), pcompd0(:, 1, &
&               2), pcompd(:, 1, 2), pcompdd(:, :, 1, 2), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 2), limit3d0(:, :, 2), limit3d(:, :, &
&               2), limit3dd(:, :, :, 2), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(2, 2), pcompd0(:, 2, 2), pcompd(:, 2&
&               , 2), pcompdd(:, :, 2, 2), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(1, 3), -limit3d0(:, 1, 3), -limit3d(:, 1, &
&               3), -limit3dd(:, :, 1, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), rho_sy, &
&               rho_syd0, rho_syd, rho_sydd, pcomp(3, 2), pcompd0(:, 3, &
&               2), pcompd(:, 3, 2), pcompdd(:, :, 3, 2), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 4), limit3d0(:, :, 4), limit3d(:, :, &
&               4), limit3dd(:, :, :, 4), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(4, 2), pcompd0(:, 4, 2), pcompd(:, 4&
&               , 2), pcompdd(:, :, 4, 2), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 3) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 3, 1) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 2) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 4) = ((delta_ydd(nd0, nd, 2)*sigma_y+(&
&           delta_yd(nd, 2)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 2)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(2)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y(2)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 3, 1) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 2) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 2)-m_yd0(nd0))*sigma_y-(&
&         delta_y(2)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL PHID_DV_DV(limit3(3, 1), limit3d0(:, 3, 1), limit3d(:, 3, 1)&
&               , limit3dd(:, :, 3, 1), pcomp(1, 1), pcompd0(:, 1, 1), &
&               pcompd(:, 1, 1), pcompdd(:, :, 1, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 2), -limit3d0(:, 2, 2), -limit3d(:, 2, &
&               2), -limit3dd(:, :, 2, 2), -limit3(3, 2), -limit3d0(:, 3&
&               , 2), -limit3d(:, 3, 2), -limit3dd(:, :, 3, 2), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(2, 1), pcompd0(:, 2, &
&               1), pcompd(:, 2, 1), pcompdd(:, :, 2, 1), nbdirs, &
&               nbdirs0)
      CALL PHID_DV_DV(limit3(3, 3), limit3d0(:, 3, 3), limit3d(:, 3, 3)&
&               , limit3dd(:, :, 3, 3), pcomp(3, 1), pcompd0(:, 3, 1), &
&               pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 4), -limit3d0(:, 2, 4), -limit3d(:, 2, &
&               4), -limit3dd(:, :, 2, 4), -limit3(3, 4), -limit3d0(:, 3&
&               , 4), -limit3d(:, 3, 4), -limit3dd(:, :, 3, 4), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(4, 1), pcompd0(:, 4, &
&               1), pcompd(:, 4, 1), pcompdd(:, :, 4, 1), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(1, 1), -limit3d0(:, 1, 1), -limit3d(:, 1, &
&               1), -limit3dd(:, :, 1, 1), -limit3(3, 1), -limit3d0(:, 3&
&               , 1), -limit3d(:, 3, 1), -limit3dd(:, :, 3, 1), rho_sy, &
&               rho_syd0, rho_syd, rho_sydd, pcomp(1, 2), pcompd0(:, 1, &
&               2), pcompd(:, 1, 2), pcompdd(:, :, 1, 2), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 2), limit3d0(:, :, 2), limit3d(:, :, &
&               2), limit3dd(:, :, :, 2), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(2, 2), pcompd0(:, 2, 2), pcompd(:, 2&
&               , 2), pcompdd(:, :, 2, 2), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(1, 3), -limit3d0(:, 1, 3), -limit3d(:, 1, &
&               3), -limit3dd(:, :, 1, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), rho_sy, &
&               rho_syd0, rho_syd, rho_sydd, pcomp(3, 2), pcompd0(:, 3, &
&               2), pcompd(:, 3, 2), pcompdd(:, :, 3, 2), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 4), limit3d0(:, :, 4), limit3d(:, :, &
&               4), limit3dd(:, :, :, 4), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(4, 2), pcompd0(:, 4, 2), pcompd(:, 4&
&               , 2), pcompdd(:, :, 4, 2), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 4) THEN
      DO nd=1,nbdirs
        DO nd0=1,nbdirs0
!
          limit3dd(nd0, nd, 2, 2) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 3) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
          limit3dd(nd0, nd, 2, 4) = (((delta_zdd(nd0, nd, 2)-m_zdd(nd0, &
&           nd))*sigma_z+(delta_zd(nd, 2)-m_zd(nd))*sigma_zd0(nd0)-(&
&           delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_zd(nd)-(delta_z(2)-m_z)*&
&           sigma_zdd(nd0, nd))*sigma_z**2-((delta_zd(nd, 2)-m_zd(nd))*&
&           sigma_z-(delta_z(2)-m_z)*sigma_zd(nd))*2*sigma_z*sigma_zd0(&
&           nd0))/(sigma_z**2)**2
          limit3dd(nd0, nd, 3, 4) = ((delta_ydd(nd0, nd, 3)*sigma_y+(&
&           delta_yd(nd, 3)-m_yd(nd))*sigma_yd0(nd0)-(delta_yd0(nd0, 3)-&
&           m_yd0(nd0))*sigma_yd(nd)-(delta_y(3)-m_y)*sigma_ydd(nd0, nd)&
&           )*sigma_y**2-((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y(3)&
&           -m_y)*sigma_yd(nd))*2*sigma_y*sigma_yd0(nd0))/(sigma_y**2)**&
&           2
        END DO
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      DO nd0=1,nbdirs0
        limit3d0(nd0, 2, 2) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 3) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
        limit3d0(nd0, 2, 4) = ((delta_zd0(nd0, 2)-m_zd0(nd0))*sigma_z-(&
&         delta_z(2)-m_z)*sigma_zd0(nd0))/sigma_z**2
        limit3d0(nd0, 3, 4) = ((delta_yd0(nd0, 3)-m_yd0(nd0))*sigma_y-(&
&         delta_y(3)-m_y)*sigma_yd0(nd0))/sigma_y**2
      END DO
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcomp(1, 1) = 1.d0
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      CALL PHID_DV_DV(limit3(2, 2), limit3d0(:, 2, 2), limit3d(:, 2, 2)&
&               , limit3dd(:, :, 2, 2), pcomp(2, 1), pcompd0(:, 2, 1), &
&               pcompd(:, 2, 1), pcompdd(:, :, 2, 1), nbdirs, nbdirs0)
      CALL PHID_DV_DV(limit3(3, 3), limit3d0(:, 3, 3), limit3d(:, 3, 3)&
&               , limit3dd(:, :, 3, 3), pcomp(3, 1), pcompd0(:, 3, 1), &
&               pcompd(:, 3, 1), pcompdd(:, :, 3, 1), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(2, 4), -limit3d0(:, 2, 4), -limit3d(:, 2, &
&               4), -limit3dd(:, :, 2, 4), -limit3(3, 4), -limit3d0(:, 3&
&               , 4), -limit3d(:, 3, 4), -limit3dd(:, :, 3, 4), rho_zy, &
&               rho_zyd0, rho_zyd, rho_zydd, pcomp(4, 1), pcompd0(:, 4, &
&               1), pcompd(:, 4, 1), pcompdd(:, :, 4, 1), nbdirs, &
&               nbdirs0)
      CALL PHID_DV_DV(limit3(1, 1), limit3d0(:, 1, 1), limit3d(:, 1, 1)&
&               , limit3dd(:, :, 1, 1), pcomp(1, 2), pcompd0(:, 1, 2), &
&               pcompd(:, 1, 2), pcompdd(:, :, 1, 2), nbdirs, nbdirs0)
      CALL BVND_DV_DV(-limit3(1, 2), -limit3d0(:, 1, 2), -limit3d(:, 1, &
&               2), -limit3dd(:, :, 1, 2), -limit3(2, 2), -limit3d0(:, 2&
&               , 2), -limit3d(:, 2, 2), -limit3dd(:, :, 2, 2), rho_sz, &
&               rho_szd0, rho_szd, rho_szdd, pcomp(2, 2), pcompd0(:, 2, &
&               2), pcompd(:, 2, 2), pcompdd(:, :, 2, 2), nbdirs, &
&               nbdirs0)
      CALL BVND_DV_DV(-limit3(1, 3), -limit3d0(:, 1, 3), -limit3d(:, 1, &
&               3), -limit3dd(:, :, 1, 3), -limit3(3, 3), -limit3d0(:, 3&
&               , 3), -limit3d(:, 3, 3), -limit3dd(:, :, 3, 3), rho_sy, &
&               rho_syd0, rho_syd, rho_sydd, pcomp(3, 2), pcompd0(:, 3, &
&               2), pcompd(:, 3, 2), pcompdd(:, :, 3, 2), nbdirs, &
&               nbdirs0)
      CALL TVTL_DV_DV(0, limit3(:, 4), limit3d0(:, :, 4), limit3d(:, :, &
&               4), limit3dd(:, :, :, 4), corr3, corr3d0, corr3d, &
&               corr3dd, eps, pcomp(4, 2), pcompd0(:, 4, 2), pcompd(:, 4&
&               , 2), pcompdd(:, :, 4, 2), nbdirs, nbdirs0)
!
      p_asdd(:, :) = 0.0_8
    ELSE
      pcompd(:, :, :) = 0.0_8
      pcompdd(:, :, :, :) = 0.0_8
      pcompd0(:, :, :) = 0.0_8
      p_asdd(:, :) = 0.0_8
    END IF
    DO nd=1,nbdirs
      DO nd0=1,nbdirs0
!
        p_asdd(nd0, nd) = pcompdd(nd0, nd, 1, 1) - pcompdd(nd0, nd, 2, 1&
&         ) - pcompdd(nd0, nd, 3, 1) + pcompdd(nd0, nd, 4, 1) - pcompdd(&
&         nd0, nd, 1, 2) + pcompdd(nd0, nd, 2, 2) + pcompdd(nd0, nd, 3, &
&         2) - pcompdd(nd0, nd, 4, 2)
      END DO
      p_asd(nd) = pcompd(nd, 1, 1) - pcompd(nd, 2, 1) - pcompd(nd, 3, 1)&
&       + pcompd(nd, 4, 1) - pcompd(nd, 1, 2) + pcompd(nd, 2, 2) + &
&       pcompd(nd, 3, 2) - pcompd(nd, 4, 2)
    END DO
    DO nd0=1,nbdirs0
      p_asd0(nd0) = pcompd0(nd0, 1, 1) - pcompd0(nd0, 2, 1) - pcompd0(&
&       nd0, 3, 1) + pcompd0(nd0, 4, 1) - pcompd0(nd0, 1, 2) + pcompd0(&
&       nd0, 2, 2) + pcompd0(nd0, 3, 2) - pcompd0(nd0, 4, 2)
    END DO
    p_as = pcomp(1, 1) - pcomp(2, 1) - pcomp(3, 1) + pcomp(4, 1) - (&
&     pcomp(1, 2)-pcomp(2, 2)-pcomp(3, 2)+pcomp(4, 2))
    p_zyd(:) = 0.0_8
    pdd(:, :) = 0.0_8
    p_zydd(:, :) = 0.0_8
    p_zyd0(:) = 0.0_8
  CASE DEFAULT
    p_asd(:) = 0.0_8
    p_zyd(:) = 0.0_8
    pdd(:, :) = 0.0_8
    p_asd0(:) = 0.0_8
    p_asdd(:, :) = 0.0_8
    p_zydd(:, :) = 0.0_8
    p_zyd0(:) = 0.0_8
  END SELECT
  DO nd=1,nbdirs
    DO nd0=1,nbdirs0
!
! Evaluating the integrand
!
      pdd(nd0, nd) = p_asdd(nd0, nd)*p_zy + p_asd(nd)*p_zyd0(nd0) + &
&       p_asd0(nd0)*p_zyd(nd) + p_as*p_zydd(nd0, nd)
    END DO
    pd(nd) = p_asd(nd)*p_zy + p_as*p_zyd(nd)
  END DO
  p = p_as*p_zy + minimum_p
END SUBROUTINE INDIVIDUAL_CONTRIBUTION_DV_DV

!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.14 (r7259) - 18 Jan 2019 09:34
!
!  Differentiation of individual_contribution in forward (tangent) mode (with options multiDirectional i4 dr8 r4):
!   variations   of useful results: p
!   with respect to varying inputs: psi
!   RW status of diff variables: psi:in p:out
SUBROUTINE INDIVIDUAL_CONTRIBUTION_DV_NODIFF(psi, psid, dn, asn, riskavn&
& , horizonn, p, pd, nbdirs)
!
  USE CONSTANTS
  USE OBSERVATIONS
  USE UTILITIES_DIFFV_DIFFV
  USE SP_DIFFV_DIFFV
  USE DIFFSIZES
  IMPLICIT NONE
! 
! Ending subroutine and returning execution
! 
! 
! Declaring dummy variables
!   
! Vector of metaparameters
  REAL*8, INTENT(IN) :: psi(num_psi)
  REAL*8, INTENT(IN) :: psid(nbdirsmax, num_psi)
! Observed regime dummy
  INTEGER, INTENT(IN) :: dn
  REAL*8, INTENT(IN) :: asn
! Observed self-reported risk attitude
  INTEGER, INTENT(IN) :: riskavn
! Observed self-reported planning horizon
  INTEGER, INTENT(IN) :: horizonn
! Computed regime probability
  REAL*8, INTENT(OUT) :: p
  REAL*8, DIMENSION(nbdirsmax), INTENT(OUT) :: pd
!
! Declaring external routines
!
! Trivariate normal cdf
  REAL*8, EXTERNAL :: TVTL
! Bivariate normal survival sdf
  REAL*8, EXTERNAL :: BVND
! Univariate normal cdf
  REAL*8, EXTERNAL :: PHID
! 
! Declaring local variables
! 
  REAL*8 :: m_s, m_q, m_z, m_y
  REAL*8, DIMENSION(nbdirsmax) :: m_sd, m_zd, m_yd
  REAL*8 :: sigma_s, sigma_z, sigma_y
  REAL*8, DIMENSION(nbdirsmax) :: sigma_sd, sigma_zd, sigma_yd
  REAL*8 :: rho_sz, rho_sy, rho_zy
  REAL*8, DIMENSION(nbdirsmax) :: rho_szd, rho_syd, rho_zyd
  REAL*8 :: gamma, kappa, q
  REAL*8, DIMENSION(nbdirsmax) :: qd
  REAL*8 :: delta_z(num_delta_z), delta_y(num_delta_y)
  REAL*8 :: delta_zd(nbdirsmax, num_delta_z), delta_yd(nbdirsmax, &
& num_delta_y)
  REAL*8 :: m_zs, m_ys, psi_z, psi_y, rho_psi_zy
  REAL*8, DIMENSION(nbdirsmax) :: m_zsd, m_ysd, psi_zd, psi_yd, &
& rho_psi_zyd
  REAL*8 :: p_as, p_zy, eps
  REAL*8, DIMENSION(nbdirsmax) :: p_asd, p_zyd
  REAL*8 :: limit3(3, 4), corr3(3), pcomp(4, 2)
  REAL*8 :: limit3d(nbdirsmax, 3, 4), corr3d(nbdirsmax, 3), pcompd(&
& nbdirsmax, 4, 2)
  INTRINSIC SQRT
  REAL*8 :: arg1
  REAL*8, DIMENSION(nbdirsmax) :: arg1d
  REAL*8 :: result1
  REAL*8, DIMENSION(nbdirsmax) :: result1d
  REAL*8 :: arg2
  REAL*8, DIMENSION(nbdirsmax) :: arg2d
  REAL*8 :: result2
  REAL*8, DIMENSION(nbdirsmax) :: result2d
  INTEGER :: nd
  INTEGER :: nbdirs
  REAL*8 :: result10
! 
! Beginning execution
! 
! Computing the b parameters
! 
  CALL COMPUTE_B_PARAMETERS_DV(psi, psid, m_s, m_sd, m_q, m_z, m_zd, m_y&
&                        , m_yd, sigma_s, sigma_sd, sigma_z, sigma_zd, &
&                        sigma_y, sigma_yd, rho_sz, rho_szd, rho_sy, &
&                        rho_syd, rho_zy, rho_zyd, gamma, kappa, q, qd, &
&                        delta_z, delta_zd, delta_y, delta_yd, nbdirs)
  pcomp = 0.d0
  limit3 = 0.d0
! 
! 
! Computing individual contribution to the loglikelihood
! 
  SELECT CASE  (dn) 
  CASE (1) 
    arg2 = 1.d0 - rho_sy**2
    DO nd=1,nbdirs
!
! 0 < as < 1          
! 
! density of a_s
! 
      arg1d(nd) = (-((m_sd(nd)*q-m_s*qd(nd))*sigma_s/q**3)-(asn-m_s/q)*(&
&       sigma_sd(nd)*q-sigma_s*qd(nd))/q**2)/(sigma_s/q)**2
!
! probability of self-reported risk aversion and planning horizon
!
      m_zsd(nd) = m_zd(nd) + ((rho_szd(nd)*sigma_z+rho_sz*sigma_zd(nd))*&
&       sigma_s-rho_sz*sigma_z*sigma_sd(nd))*(m_s-q*asn)/sigma_s**2 + &
&       rho_sz*sigma_z*(m_sd(nd)-asn*qd(nd))/sigma_s
      m_ysd(nd) = m_yd(nd) + ((rho_syd(nd)*sigma_y+rho_sy*sigma_yd(nd))*&
&       sigma_s-rho_sy*sigma_y*sigma_sd(nd))*(m_s-q*asn)/sigma_s**2 + &
&       rho_sy*sigma_y*(m_sd(nd)-asn*qd(nd))/sigma_s
      arg2d(nd) = -(2*rho_sy*rho_syd(nd))
      IF (arg2 .EQ. 0.0) THEN
        result2d(nd) = 0.0_8
      ELSE
        result10 = SQRT(arg2)
        result2d(nd) = arg2d(nd)/(2.0*result10)
      END IF
    END DO
    arg1 = (asn-m_s/q)/(sigma_s/q)
    CALL PDF_N01_DV(arg1, arg1d, result1, result1d, nbdirs)
    arg1 = 1.d0 - rho_sz**2
    DO nd=1,nbdirs
      p_asd(nd) = (result1d(nd)*sigma_s/q-result1*(sigma_sd(nd)*q-&
&       sigma_s*qd(nd))/q**2)/(sigma_s/q)**2
      arg1d(nd) = -(2*rho_sz*rho_szd(nd))
      IF (arg1 .EQ. 0.0) THEN
        result1d(nd) = 0.0_8
      ELSE
        result10 = SQRT(arg1)
        result1d(nd) = arg1d(nd)/(2.0*result10)
      END IF
      arg1d(nd) = -(2*rho_sy*rho_syd(nd))
    END DO
    p_as = result1/(sigma_s/q)
    m_zs = m_z + rho_sz*sigma_z/sigma_s*(m_s-q*asn)
    m_ys = m_y + rho_sy*sigma_y/sigma_s*(m_s-q*asn)
    result1 = SQRT(arg1)
    arg1 = 1.d0 - rho_sy**2
    DO nd=1,nbdirs
      psi_zd(nd) = sigma_zd(nd)*result1 + sigma_z*result1d(nd)
      IF (arg1 .EQ. 0.0) THEN
        result1d(nd) = 0.0_8
      ELSE
        result10 = SQRT(arg1)
        result1d(nd) = arg1d(nd)/(2.0*result10)
      END IF
      arg1d(nd) = -(2*rho_sz*rho_szd(nd))
    END DO
    psi_z = sigma_z*result1
    result1 = SQRT(arg1)
    arg1 = 1.d0 - rho_sz**2
    DO nd=1,nbdirs
      psi_yd(nd) = sigma_yd(nd)*result1 + sigma_y*result1d(nd)
      IF (arg1 .EQ. 0.0) THEN
        result1d(nd) = 0.0_8
      ELSE
        result10 = SQRT(arg1)
        result1d(nd) = arg1d(nd)/(2.0*result10)
      END IF
    END DO
    psi_y = sigma_y*result1
    result1 = SQRT(arg1)
    result2 = SQRT(arg2)
    DO nd=1,nbdirs
      rho_psi_zyd(nd) = ((rho_zyd(nd)-rho_szd(nd)*rho_sy-rho_sz*rho_syd(&
&       nd))*result1*result2-(rho_zy-rho_sz*rho_sy)*(result1d(nd)*&
&       result2+result1*result2d(nd)))/(result1*result2)**2
    END DO
    rho_psi_zy = (rho_zy-rho_sz*rho_sy)/(result1*result2)
!
    IF (riskavn .EQ. 1 .AND. horizonn .EQ. 1) THEN
!
      limit3d(:, :, :) = 0.0_8
      DO nd=1,nbdirs
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(1)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(2, 1), -limit3d(:, 2, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_psi_zy, rho_psi_zyd, pcomp(1, 1), &
&            pcompd(:, 1, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 2) THEN
!
      limit3d(:, :, :) = 0.0_8
      DO nd=1,nbdirs
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 3) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(1)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(2, 1), -limit3d(:, 2, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_psi_zy, rho_psi_zyd, pcomp(1, 1), &
&            pcompd(:, 1, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 3), -limit3d(:, 2, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_psi_zy, rho_psi_zyd, pcomp(3, 1), &
&            pcompd(:, 3, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 3) THEN
!
      limit3d(:, :, :) = 0.0_8
      DO nd=1,nbdirs
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_ysd(nd))*psi_y-(delta_y(&
&         3)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(3)-m_ys)/psi_y
      limit3(2, 3) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(2)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(2, 1), -limit3d(:, 2, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_psi_zy, rho_psi_zyd, pcomp(1, 1), &
&            pcompd(:, 1, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 3), -limit3d(:, 2, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_psi_zy, rho_psi_zyd, pcomp(3, 1), &
&            pcompd(:, 3, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 4) THEN
!
      limit3d(:, :, :) = 0.0_8
      DO nd=1,nbdirs
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_ysd(nd))*psi_y-(delta_y(&
&         3)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_zs)/psi_z
      limit3(2, 3) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(3)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      CALL PHID_DV(limit3(2, 1), limit3d(:, 2, 1), pcomp(1, 1), pcompd(:&
&            , 1, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 3), -limit3d(:, 2, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_psi_zy, rho_psi_zyd, pcomp(3, 1), &
&            pcompd(:, 3, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 1) THEN
!
      limit3d(:, :, :) = 0.0_8
      DO nd=1,nbdirs
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(1)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(1)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(2, 1), -limit3d(:, 2, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_psi_zy, rho_psi_zyd, pcomp(1, 1), &
&            pcompd(:, 1, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 2), -limit3d(:, 2, 2), -limit3(3, 2), -&
&            limit3d(:, 3, 2), rho_psi_zy, rho_psi_zyd, pcomp(2, 1), &
&            pcompd(:, 2, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 2) THEN
!
      limit3d(:, :, :) = 0.0_8
      DO nd=1,nbdirs
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 3) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(1)-m_ys)/psi_y
      limit3(2, 4) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 4) = (delta_y(1)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(2, 1), -limit3d(:, 2, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_psi_zy, rho_psi_zyd, pcomp(1, 1), &
&            pcompd(:, 1, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 2), -limit3d(:, 2, 2), -limit3(3, 2), -&
&            limit3d(:, 3, 2), rho_psi_zy, rho_psi_zyd, pcomp(2, 1), &
&            pcompd(:, 2, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 3), -limit3d(:, 2, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_psi_zy, rho_psi_zyd, pcomp(3, 1), &
&            pcompd(:, 3, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 4), -limit3d(:, 2, 4), -limit3(3, 4), -&
&            limit3d(:, 3, 4), rho_psi_zy, rho_psi_zyd, pcomp(4, 1), &
&            pcompd(:, 4, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 3) THEN
!
      limit3d(:, :, :) = 0.0_8
      DO nd=1,nbdirs
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_ysd(nd))*psi_y-(delta_y(&
&         3)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 3)-m_ysd(nd))*psi_y-(delta_y(&
&         3)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(3)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(3)-m_ys)/psi_y
      limit3(2, 3) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 4) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 4) = (delta_y(2)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(2, 1), -limit3d(:, 2, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_psi_zy, rho_psi_zyd, pcomp(1, 1), &
&            pcompd(:, 1, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 2), -limit3d(:, 2, 2), -limit3(3, 2), -&
&            limit3d(:, 3, 2), rho_psi_zy, rho_psi_zyd, pcomp(2, 1), &
&            pcompd(:, 2, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 3), -limit3d(:, 2, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_psi_zy, rho_psi_zyd, pcomp(3, 1), &
&            pcompd(:, 3, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 4), -limit3d(:, 2, 4), -limit3(3, 4), -&
&            limit3d(:, 3, 4), rho_psi_zy, rho_psi_zyd, pcomp(4, 1), &
&            pcompd(:, 4, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 4) THEN
!
      limit3d(:, :, :) = 0.0_8
      DO nd=1,nbdirs
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_ysd(nd))*psi_y-(delta_y(&
&         3)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zsd(nd))*psi_z-(delta_z(&
&         1)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 3)-m_ysd(nd))*psi_y-(delta_y(&
&         3)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_zs)/psi_z
      limit3(2, 2) = (delta_z(1)-m_zs)/psi_z
      limit3(2, 3) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(3)-m_ys)/psi_y
      limit3(2, 4) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 4) = (delta_y(3)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      CALL PHID_DV(limit3(2, 1), limit3d(:, 2, 1), pcomp(1, 1), pcompd(:&
&            , 1, 1), nbdirs)
      CALL PHID_DV(limit3(2, 2), limit3d(:, 2, 2), pcomp(2, 1), pcompd(:&
&            , 2, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 3), -limit3d(:, 2, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_psi_zy, rho_psi_zyd, pcomp(3, 1), &
&            pcompd(:, 3, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 4), -limit3d(:, 2, 4), -limit3(3, 4), -&
&            limit3d(:, 3, 4), rho_psi_zy, rho_psi_zyd, pcomp(4, 1), &
&            pcompd(:, 4, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 1) THEN
!
      limit3d(:, :, :) = 0.0_8
      DO nd=1,nbdirs
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3(3, 1) = (delta_y(1)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(1)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      CALL PHID_DV(limit3(3, 1), limit3d(:, 3, 1), pcomp(1, 1), pcompd(:&
&            , 1, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 2), -limit3d(:, 2, 2), -limit3(3, 2), -&
&            limit3d(:, 3, 2), rho_psi_zy, rho_psi_zyd, pcomp(2, 1), &
&            pcompd(:, 2, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 2) THEN
!
      limit3d(:, :, :) = 0.0_8
      DO nd=1,nbdirs
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 2)-m_ysd(nd))*psi_y-(delta_y(&
&         2)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zsd(nd))*psi_z-(delta_z(&
&         2)-m_zs)*psi_zd(nd))/psi_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 1)-m_ysd(nd))*psi_y-(delta_y(&
&         1)-m_ys)*psi_yd(nd))/psi_y**2
      END DO
      limit3(3, 1) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(2)-m_ys)/psi_y
      limit3(3, 3) = (delta_y(1)-m_ys)/psi_y
      limit3(2, 4) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 4) = (delta_y(1)-m_ys)/psi_y
      pcompd(:, :, :) = 0.0_8
      CALL PHID_DV(limit3(3, 1), limit3d(:, 3, 1), pcomp(1, 1), pcompd(:&
&            , 1, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 2), -limit3d(:, 2, 2), -limit3(3, 2), -&
&            limit3d(:, 3, 2), rho_psi_zy, rho_psi_zyd, pcomp(2, 1), &
&            pcompd(:, 2, 1), nbdirs)
      CALL PHID_DV(limit3(3, 3), limit3d(:, 3, 3), pcomp(3, 1), pcompd(:&
&            , 3, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 4), -limit3d(:, 2, 4), -limit3(3, 4), -&
&            limit3d(:, 3, 4), rho_psi_zy, rho_psi_zyd, pcomp(4, 1), &
&            pcompd(:, 4, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 3) THEN
!
      limit3d(:, :, :) = 0.0_8
      DO nd=1,nbdirs
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL PHID_DV(limit3(3, 1), limit3d(:, 3, 1), pcomp(1, 1), pcompd(:&
&            , 1, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 2), -limit3d(:, 2, 2), -limit3(3, 2), -&
&            limit3d(:, 3, 2), rho_psi_zy, rho_psi_zyd, pcomp(2, 1), &
&            pcompd(:, 2, 1), nbdirs)
      CALL PHID_DV(limit3(3, 3), limit3d(:, 3, 3), pcomp(3, 1), pcompd(:&
&            , 3, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 4), -limit3d(:, 2, 4), -limit3(3, 4), -&
&            limit3d(:, 3, 4), rho_psi_zy, rho_psi_zyd, pcomp(4, 1), &
&            pcompd(:, 4, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 4) THEN
!
      limit3d(:, :, :) = 0.0_8
      DO nd=1,nbdirs
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcomp(1, 1) = 1.d0
      pcompd(:, :, :) = 0.0_8
      CALL PHID_DV(limit3(2, 2), limit3d(:, 2, 2), pcomp(2, 1), pcompd(:&
&            , 2, 1), nbdirs)
      CALL PHID_DV(limit3(3, 3), limit3d(:, 3, 3), pcomp(3, 1), pcompd(:&
&            , 3, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 4), -limit3d(:, 2, 4), -limit3(3, 4), -&
&            limit3d(:, 3, 4), rho_psi_zy, rho_psi_zyd, pcomp(4, 1), &
&            pcompd(:, 4, 1), nbdirs)
!
    ELSE
      pcompd(:, :, :) = 0.0_8
    END IF
    DO nd=1,nbdirs
!
      p_zyd(nd) = pcompd(nd, 1, 1) - pcompd(nd, 2, 1) - pcompd(nd, 3, 1)&
&       + pcompd(nd, 4, 1)
    END DO
    p_zy = pcomp(1, 1) - pcomp(2, 1) - pcomp(3, 1) + pcomp(4, 1)
  CASE (2) 
! 
! as = 0
! 
! joint probability
! 
    p_zy = 1.d0
    limit3d(:, :, :) = 0.0_8
    DO nd=1,nbdirs
      corr3d(nd, :) = (/rho_szd(nd), rho_syd(nd), rho_zyd(nd)/)
      limit3d(nd, 1, :) = -((m_sd(nd)*sigma_s-m_s*sigma_sd(nd))/sigma_s&
&       **2)
    END DO
    corr3 = (/rho_sz, rho_sy, rho_zy/)
    limit3(1, :) = -(m_s/sigma_s)
    eps = 1.d-13
!
    IF (riskavn .EQ. 1 .AND. horizonn .EQ. 1) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL TVTL_DV(0, limit3(:, 1), limit3d(:, :, 1), corr3, corr3d, eps&
&            , pcomp(1, 1), pcompd(:, 1, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 2) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL TVTL_DV(0, limit3(:, 1), limit3d(:, :, 1), corr3, corr3d, eps&
&            , pcomp(1, 1), pcompd(:, 1, 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 3), limit3d(:, :, 3), corr3, corr3d, eps&
&            , pcomp(3, 1), pcompd(:, 3, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 3) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL TVTL_DV(0, limit3(:, 1), limit3d(:, :, 1), corr3, corr3d, eps&
&            , pcomp(1, 1), pcompd(:, 1, 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 3), limit3d(:, :, 3), corr3, corr3d, eps&
&            , pcomp(3, 1), pcompd(:, 3, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 4) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(1, 1), -limit3d(:, 1, 1), -limit3(2, 1), -&
&            limit3d(:, 2, 1), rho_sz, rho_szd, pcomp(1, 1), pcompd(:, 1&
&            , 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 3), limit3d(:, :, 3), corr3, corr3d, eps&
&            , pcomp(3, 1), pcompd(:, 3, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 1) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL TVTL_DV(0, limit3(:, 1), limit3d(:, :, 1), corr3, corr3d, eps&
&            , pcomp(1, 1), pcompd(:, 1, 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 2), limit3d(:, :, 2), corr3, corr3d, eps&
&            , pcomp(2, 1), pcompd(:, 2, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 2) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL TVTL_DV(0, limit3(:, 1), limit3d(:, :, 1), corr3, corr3d, eps&
&            , pcomp(1, 1), pcompd(:, 1, 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 2), limit3d(:, :, 2), corr3, corr3d, eps&
&            , pcomp(2, 1), pcompd(:, 2, 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 3), limit3d(:, :, 3), corr3, corr3d, eps&
&            , pcomp(3, 1), pcompd(:, 3, 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 4), limit3d(:, :, 4), corr3, corr3d, eps&
&            , pcomp(4, 1), pcompd(:, 4, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 3) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL TVTL_DV(0, limit3(:, 1), limit3d(:, :, 1), corr3, corr3d, eps&
&            , pcomp(1, 1), pcompd(:, 1, 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 2), limit3d(:, :, 2), corr3, corr3d, eps&
&            , pcomp(2, 1), pcompd(:, 2, 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 3), limit3d(:, :, 3), corr3, corr3d, eps&
&            , pcomp(3, 1), pcompd(:, 3, 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 4), limit3d(:, :, 4), corr3, corr3d, eps&
&            , pcomp(4, 1), pcompd(:, 4, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 4) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(1, 1), -limit3d(:, 1, 1), -limit3(2, 1), -&
&            limit3d(:, 2, 1), rho_sz, rho_szd, pcomp(1, 1), pcompd(:, 1&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(1, 2), -limit3d(:, 1, 2), -limit3(2, 2), -&
&            limit3d(:, 2, 2), rho_sz, rho_szd, pcomp(2, 1), pcompd(:, 2&
&            , 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 3), limit3d(:, :, 3), corr3, corr3d, eps&
&            , pcomp(3, 1), pcompd(:, 3, 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 4), limit3d(:, :, 4), corr3, corr3d, eps&
&            , pcomp(4, 1), pcompd(:, 4, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 1) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(1, 1), -limit3d(:, 1, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_sy, rho_syd, pcomp(1, 1), pcompd(:, 1&
&            , 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 2), limit3d(:, :, 2), corr3, corr3d, eps&
&            , pcomp(2, 1), pcompd(:, 2, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 2) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(2)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(1, 1), -limit3d(:, 1, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_sy, rho_syd, pcomp(1, 1), pcompd(:, 1&
&            , 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 2), limit3d(:, :, 2), corr3, corr3d, eps&
&            , pcomp(2, 1), pcompd(:, 2, 1), nbdirs)
      CALL BVND_DV(-limit3(1, 3), -limit3d(:, 1, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_sy, rho_syd, pcomp(3, 1), pcompd(:, 3&
&            , 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 4), limit3d(:, :, 4), corr3, corr3d, eps&
&            , pcomp(4, 1), pcompd(:, 4, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 3) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(1, 1), -limit3d(:, 1, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_sy, rho_syd, pcomp(1, 1), pcompd(:, 1&
&            , 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 2), limit3d(:, :, 2), corr3, corr3d, eps&
&            , pcomp(2, 1), pcompd(:, 2, 1), nbdirs)
      CALL BVND_DV(-limit3(1, 3), -limit3d(:, 1, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_sy, rho_syd, pcomp(3, 1), pcompd(:, 3&
&            , 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 4), limit3d(:, :, 4), corr3, corr3d, eps&
&            , pcomp(4, 1), pcompd(:, 4, 1), nbdirs)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 4) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcomp(1, 1) = 1.d0
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(1, 2), -limit3d(:, 1, 2), -limit3(2, 2), -&
&            limit3d(:, 2, 2), rho_sz, rho_szd, pcomp(2, 1), pcompd(:, 2&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(1, 3), -limit3d(:, 1, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_sy, rho_syd, pcomp(3, 1), pcompd(:, 3&
&            , 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 4), limit3d(:, :, 4), corr3, corr3d, eps&
&            , pcomp(4, 1), pcompd(:, 4, 1), nbdirs)
!
    ELSE
      pcompd(:, :, :) = 0.0_8
    END IF
    DO nd=1,nbdirs
!
      p_asd(nd) = pcompd(nd, 1, 1) - pcompd(nd, 2, 1) - pcompd(nd, 3, 1)&
&       + pcompd(nd, 4, 1)
    END DO
    p_as = pcomp(1, 1) - pcomp(2, 1) - pcomp(3, 1) + pcomp(4, 1)
    p_zyd(:) = 0.0_8
  CASE (3) 
! 
! as = 1
! 
! joint probability
! 
    p_zy = 1.d0
    limit3d(:, :, :) = 0.0_8
    DO nd=1,nbdirs
      corr3d(nd, :) = (/rho_szd(nd), rho_syd(nd), rho_zyd(nd)/)
      limit3d(nd, 1, :) = ((qd(nd)-m_sd(nd))*sigma_s-(q-m_s)*sigma_sd(nd&
&       ))/sigma_s**2
    END DO
    corr3 = (/rho_sz, rho_sy, rho_zy/)
    limit3(1, :) = (q-m_s)/sigma_s
    eps = 1.d-13
!
    IF (riskavn .EQ. 1 .AND. horizonn .EQ. 1) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(2, 1), -limit3d(:, 2, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_zy, rho_zyd, pcomp(1, 1), pcompd(:, 1&
&            , 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 1), limit3d(:, :, 1), corr3, corr3d, eps&
&            , pcomp(1, 2), pcompd(:, 1, 2), nbdirs)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 2) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(2, 1), -limit3d(:, 2, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_zy, rho_zyd, pcomp(1, 1), pcompd(:, 1&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(2, 3), -limit3d(:, 2, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_zy, rho_zyd, pcomp(3, 1), pcompd(:, 3&
&            , 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 1), limit3d(:, :, 1), corr3, corr3d, eps&
&            , pcomp(1, 2), pcompd(:, 1, 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 3), limit3d(:, :, 3), corr3, corr3d, eps&
&            , pcomp(3, 2), pcompd(:, 3, 2), nbdirs)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 3) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(2, 1), -limit3d(:, 2, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_zy, rho_zyd, pcomp(1, 1), pcompd(:, 1&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(2, 3), -limit3d(:, 2, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_zy, rho_zyd, pcomp(3, 1), pcompd(:, 3&
&            , 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 1), limit3d(:, :, 1), corr3, corr3d, eps&
&            , pcomp(1, 2), pcompd(:, 1, 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 3), limit3d(:, :, 3), corr3, corr3d, eps&
&            , pcomp(3, 2), pcompd(:, 3, 2), nbdirs)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 4) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL PHID_DV(limit3(2, 1), limit3d(:, 2, 1), pcomp(1, 1), pcompd(:&
&            , 1, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 3), -limit3d(:, 2, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_zy, rho_zyd, pcomp(3, 1), pcompd(:, 3&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(1, 1), -limit3d(:, 1, 1), -limit3(2, 1), -&
&            limit3d(:, 2, 1), rho_sz, rho_szd, pcomp(1, 2), pcompd(:, 1&
&            , 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 3), limit3d(:, :, 3), corr3, corr3d, eps&
&            , pcomp(3, 2), pcompd(:, 3, 2), nbdirs)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 1) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(2, 1), -limit3d(:, 2, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_zy, rho_zyd, pcomp(1, 1), pcompd(:, 1&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(2, 2), -limit3d(:, 2, 2), -limit3(3, 2), -&
&            limit3d(:, 3, 2), rho_zy, rho_zyd, pcomp(2, 1), pcompd(:, 2&
&            , 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 1), limit3d(:, :, 1), corr3, corr3d, eps&
&            , pcomp(1, 2), pcompd(:, 1, 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 2), limit3d(:, :, 2), corr3, corr3d, eps&
&            , pcomp(2, 2), pcompd(:, 2, 2), nbdirs)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 2) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(2, 1), -limit3d(:, 2, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_zy, rho_zyd, pcomp(1, 1), pcompd(:, 1&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(2, 2), -limit3d(:, 2, 2), -limit3(3, 2), -&
&            limit3d(:, 3, 2), rho_zy, rho_zyd, pcomp(2, 1), pcompd(:, 2&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(2, 3), -limit3d(:, 2, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_zy, rho_zyd, pcomp(3, 1), pcompd(:, 3&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(2, 4), -limit3d(:, 2, 4), -limit3(3, 4), -&
&            limit3d(:, 3, 4), rho_zy, rho_zyd, pcomp(4, 1), pcompd(:, 4&
&            , 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 1), limit3d(:, :, 1), corr3, corr3d, eps&
&            , pcomp(1, 2), pcompd(:, 1, 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 2), limit3d(:, :, 2), corr3, corr3d, eps&
&            , pcomp(2, 2), pcompd(:, 2, 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 3), limit3d(:, :, 3), corr3, corr3d, eps&
&            , pcomp(3, 2), pcompd(:, 3, 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 4), limit3d(:, :, 4), corr3, corr3d, eps&
&            , pcomp(4, 2), pcompd(:, 4, 2), nbdirs)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 3) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL BVND_DV(-limit3(2, 1), -limit3d(:, 2, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_zy, rho_zyd, pcomp(1, 1), pcompd(:, 1&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(2, 2), -limit3d(:, 2, 2), -limit3(3, 2), -&
&            limit3d(:, 3, 2), rho_zy, rho_zyd, pcomp(2, 1), pcompd(:, 2&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(2, 3), -limit3d(:, 2, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_zy, rho_zyd, pcomp(3, 1), pcompd(:, 3&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(2, 4), -limit3d(:, 2, 4), -limit3(3, 4), -&
&            limit3d(:, 3, 4), rho_zy, rho_zyd, pcomp(4, 1), pcompd(:, 4&
&            , 1), nbdirs)
      CALL TVTL_DV(0, limit3(:, 1), limit3d(:, :, 1), corr3, corr3d, eps&
&            , pcomp(1, 2), pcompd(:, 1, 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 2), limit3d(:, :, 2), corr3, corr3d, eps&
&            , pcomp(2, 2), pcompd(:, 2, 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 3), limit3d(:, :, 3), corr3, corr3d, eps&
&            , pcomp(3, 2), pcompd(:, 3, 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 4), limit3d(:, :, 4), corr3, corr3d, eps&
&            , pcomp(4, 2), pcompd(:, 4, 2), nbdirs)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 4) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 1) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 2, 3) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 1)-m_zd(nd))*sigma_z-(delta_z&
&         (1)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL PHID_DV(limit3(2, 1), limit3d(:, 2, 1), pcomp(1, 1), pcompd(:&
&            , 1, 1), nbdirs)
      CALL PHID_DV(limit3(2, 2), limit3d(:, 2, 2), pcomp(2, 1), pcompd(:&
&            , 2, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 3), -limit3d(:, 2, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_zy, rho_zyd, pcomp(3, 1), pcompd(:, 3&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(2, 4), -limit3d(:, 2, 4), -limit3(3, 4), -&
&            limit3d(:, 3, 4), rho_zy, rho_zyd, pcomp(4, 1), pcompd(:, 4&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(1, 1), -limit3d(:, 1, 1), -limit3(2, 1), -&
&            limit3d(:, 2, 1), rho_sz, rho_szd, pcomp(1, 2), pcompd(:, 1&
&            , 2), nbdirs)
      CALL BVND_DV(-limit3(1, 2), -limit3d(:, 1, 2), -limit3(2, 2), -&
&            limit3d(:, 2, 2), rho_sz, rho_szd, pcomp(2, 2), pcompd(:, 2&
&            , 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 3), limit3d(:, :, 3), corr3, corr3d, eps&
&            , pcomp(3, 2), pcompd(:, 3, 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 4), limit3d(:, :, 4), corr3, corr3d, eps&
&            , pcomp(4, 2), pcompd(:, 4, 2), nbdirs)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 1) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 3, 1) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL PHID_DV(limit3(3, 1), limit3d(:, 3, 1), pcomp(1, 1), pcompd(:&
&            , 1, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 2), -limit3d(:, 2, 2), -limit3(3, 2), -&
&            limit3d(:, 3, 2), rho_zy, rho_zyd, pcomp(2, 1), pcompd(:, 2&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(1, 1), -limit3d(:, 1, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_sy, rho_syd, pcomp(1, 2), pcompd(:, 1&
&            , 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 2), limit3d(:, :, 2), corr3, corr3d, eps&
&            , pcomp(2, 2), pcompd(:, 2, 2), nbdirs)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 2) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 3, 1) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 1)-m_yd(nd))*sigma_y-(delta_y&
&         (1)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(2)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(1)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL PHID_DV(limit3(3, 1), limit3d(:, 3, 1), pcomp(1, 1), pcompd(:&
&            , 1, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 2), -limit3d(:, 2, 2), -limit3(3, 2), -&
&            limit3d(:, 3, 2), rho_zy, rho_zyd, pcomp(2, 1), pcompd(:, 2&
&            , 1), nbdirs)
      CALL PHID_DV(limit3(3, 3), limit3d(:, 3, 3), pcomp(3, 1), pcompd(:&
&            , 3, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 4), -limit3d(:, 2, 4), -limit3(3, 4), -&
&            limit3d(:, 3, 4), rho_zy, rho_zyd, pcomp(4, 1), pcompd(:, 4&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(1, 1), -limit3d(:, 1, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_sy, rho_syd, pcomp(1, 2), pcompd(:, 1&
&            , 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 2), limit3d(:, :, 2), corr3, corr3d, eps&
&            , pcomp(2, 2), pcompd(:, 2, 2), nbdirs)
      CALL BVND_DV(-limit3(1, 3), -limit3d(:, 1, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_sy, rho_syd, pcomp(3, 2), pcompd(:, 3&
&            , 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 4), limit3d(:, :, 4), corr3, corr3d, eps&
&            , pcomp(4, 2), pcompd(:, 4, 2), nbdirs)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 3) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 3, 1) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 2) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 2)-m_yd(nd))*sigma_y-(delta_y&
&         (2)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcompd(:, :, :) = 0.0_8
      CALL PHID_DV(limit3(3, 1), limit3d(:, 3, 1), pcomp(1, 1), pcompd(:&
&            , 1, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 2), -limit3d(:, 2, 2), -limit3(3, 2), -&
&            limit3d(:, 3, 2), rho_zy, rho_zyd, pcomp(2, 1), pcompd(:, 2&
&            , 1), nbdirs)
      CALL PHID_DV(limit3(3, 3), limit3d(:, 3, 3), pcomp(3, 1), pcompd(:&
&            , 3, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 4), -limit3d(:, 2, 4), -limit3(3, 4), -&
&            limit3d(:, 3, 4), rho_zy, rho_zyd, pcomp(4, 1), pcompd(:, 4&
&            , 1), nbdirs)
      CALL BVND_DV(-limit3(1, 1), -limit3d(:, 1, 1), -limit3(3, 1), -&
&            limit3d(:, 3, 1), rho_sy, rho_syd, pcomp(1, 2), pcompd(:, 1&
&            , 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 2), limit3d(:, :, 2), corr3, corr3d, eps&
&            , pcomp(2, 2), pcompd(:, 2, 2), nbdirs)
      CALL BVND_DV(-limit3(1, 3), -limit3d(:, 1, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_sy, rho_syd, pcomp(3, 2), pcompd(:, 3&
&            , 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 4), limit3d(:, :, 4), corr3, corr3d, eps&
&            , pcomp(4, 2), pcompd(:, 4, 2), nbdirs)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 4) THEN
      DO nd=1,nbdirs
!
        limit3d(nd, 2, 2) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 3) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
        limit3d(nd, 2, 4) = ((delta_zd(nd, 2)-m_zd(nd))*sigma_z-(delta_z&
&         (2)-m_z)*sigma_zd(nd))/sigma_z**2
        limit3d(nd, 3, 4) = ((delta_yd(nd, 3)-m_yd(nd))*sigma_y-(delta_y&
&         (3)-m_y)*sigma_yd(nd))/sigma_y**2
      END DO
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcomp(1, 1) = 1.d0
      pcompd(:, :, :) = 0.0_8
      CALL PHID_DV(limit3(2, 2), limit3d(:, 2, 2), pcomp(2, 1), pcompd(:&
&            , 2, 1), nbdirs)
      CALL PHID_DV(limit3(3, 3), limit3d(:, 3, 3), pcomp(3, 1), pcompd(:&
&            , 3, 1), nbdirs)
      CALL BVND_DV(-limit3(2, 4), -limit3d(:, 2, 4), -limit3(3, 4), -&
&            limit3d(:, 3, 4), rho_zy, rho_zyd, pcomp(4, 1), pcompd(:, 4&
&            , 1), nbdirs)
      CALL PHID_DV(limit3(1, 1), limit3d(:, 1, 1), pcomp(1, 2), pcompd(:&
&            , 1, 2), nbdirs)
      CALL BVND_DV(-limit3(1, 2), -limit3d(:, 1, 2), -limit3(2, 2), -&
&            limit3d(:, 2, 2), rho_sz, rho_szd, pcomp(2, 2), pcompd(:, 2&
&            , 2), nbdirs)
      CALL BVND_DV(-limit3(1, 3), -limit3d(:, 1, 3), -limit3(3, 3), -&
&            limit3d(:, 3, 3), rho_sy, rho_syd, pcomp(3, 2), pcompd(:, 3&
&            , 2), nbdirs)
      CALL TVTL_DV(0, limit3(:, 4), limit3d(:, :, 4), corr3, corr3d, eps&
&            , pcomp(4, 2), pcompd(:, 4, 2), nbdirs)
!
    ELSE
      pcompd(:, :, :) = 0.0_8
    END IF
    DO nd=1,nbdirs
!
      p_asd(nd) = pcompd(nd, 1, 1) - pcompd(nd, 2, 1) - pcompd(nd, 3, 1)&
&       + pcompd(nd, 4, 1) - pcompd(nd, 1, 2) + pcompd(nd, 2, 2) + &
&       pcompd(nd, 3, 2) - pcompd(nd, 4, 2)
    END DO
    p_as = pcomp(1, 1) - pcomp(2, 1) - pcomp(3, 1) + pcomp(4, 1) - (&
&     pcomp(1, 2)-pcomp(2, 2)-pcomp(3, 2)+pcomp(4, 2))
    p_zyd(:) = 0.0_8
  CASE DEFAULT
    p_asd(:) = 0.0_8
    p_zyd(:) = 0.0_8
  END SELECT
  DO nd=1,nbdirs
!
! Evaluating the integrand
!
    pd(nd) = p_asd(nd)*p_zy + p_as*p_zyd(nd)
  END DO
  p = p_as*p_zy + minimum_p
END SUBROUTINE INDIVIDUAL_CONTRIBUTION_DV_NODIFF

SUBROUTINE INDIVIDUAL_CONTRIBUTION_NODIFF_NODIFF(psi, dn, asn, riskavn, &
& horizonn, p)
!
  USE CONSTANTS
  USE OBSERVATIONS
  USE UTILITIES_DIFFV_DIFFV
  USE SP_DIFFV_DIFFV
  IMPLICIT NONE
! 
! Ending subroutine and returning execution
! 
! 
! Declaring dummy variables
!   
! Vector of metaparameters
  REAL*8, INTENT(IN) :: psi(num_psi)
! Observed regime dummy
  INTEGER, INTENT(IN) :: dn
  REAL*8, INTENT(IN) :: asn
! Observed self-reported risk attitude
  INTEGER, INTENT(IN) :: riskavn
! Observed self-reported planning horizon
  INTEGER, INTENT(IN) :: horizonn
! Computed regime probability
  REAL*8, INTENT(OUT) :: p
!
! Declaring external routines
!
! Trivariate normal cdf
  REAL*8, EXTERNAL :: TVTL
! Bivariate normal survival sdf
  REAL*8, EXTERNAL :: BVND
! Univariate normal cdf
  REAL*8, EXTERNAL :: PHID
! 
! Declaring local variables
! 
  REAL*8 :: m_s, m_q, m_z, m_y
  REAL*8 :: sigma_s, sigma_z, sigma_y
  REAL*8 :: rho_sz, rho_sy, rho_zy
  REAL*8 :: gamma, kappa, q
  REAL*8 :: delta_z(num_delta_z), delta_y(num_delta_y)
  REAL*8 :: m_zs, m_ys, psi_z, psi_y, rho_psi_zy
  REAL*8 :: p_as, p_zy, eps
  REAL*8 :: limit3(3, 4), corr3(3), pcomp(4, 2)
  INTRINSIC SQRT
  REAL*8 :: arg1
  REAL*8 :: result1
  REAL*8 :: arg2
  REAL*8 :: result2
! 
! Beginning execution
! 
! Computing the b parameters
! 
  CALL COMPUTE_B_PARAMETERS(psi, m_s, m_q, m_z, m_y, sigma_s, sigma_z, &
&                     sigma_y, rho_sz, rho_sy, rho_zy, gamma, kappa, q, &
&                     delta_z, delta_y)
  pcomp = 0.d0
  limit3 = 0.d0
! 
! 
! Computing individual contribution to the loglikelihood
! 
  SELECT CASE  (dn) 
  CASE (1) 
!
! 0 < as < 1          
! 
! density of a_s
! 
    arg1 = (asn-m_s/q)/(sigma_s/q)
    result1 = PDF_N01(arg1)
    p_as = result1/(sigma_s/q)
!
! probability of self-reported risk aversion and planning horizon
!
    m_zs = m_z + rho_sz*sigma_z/sigma_s*(m_s-q*asn)
    m_ys = m_y + rho_sy*sigma_y/sigma_s*(m_s-q*asn)
    arg1 = 1.d0 - rho_sz**2
    result1 = SQRT(arg1)
    psi_z = sigma_z*result1
    arg1 = 1.d0 - rho_sy**2
    result1 = SQRT(arg1)
    psi_y = sigma_y*result1
    arg1 = 1.d0 - rho_sz**2
    result1 = SQRT(arg1)
    arg2 = 1.d0 - rho_sy**2
    result2 = SQRT(arg2)
    rho_psi_zy = (rho_zy-rho_sz*rho_sy)/(result1*result2)
!
    IF (riskavn .EQ. 1 .AND. horizonn .EQ. 1) THEN
!
      limit3(2, 1) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(1)-m_ys)/psi_y
      pcomp(1, 1) = BVND(-limit3(2, 1), -limit3(3, 1), rho_psi_zy)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 2) THEN
!
      limit3(2, 1) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 3) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(1)-m_ys)/psi_y
      pcomp(1, 1) = BVND(-limit3(2, 1), -limit3(3, 1), rho_psi_zy)
      pcomp(3, 1) = BVND(-limit3(2, 3), -limit3(3, 3), rho_psi_zy)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 3) THEN
!
      limit3(2, 1) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(3)-m_ys)/psi_y
      limit3(2, 3) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(2)-m_ys)/psi_y
      pcomp(1, 1) = BVND(-limit3(2, 1), -limit3(3, 1), rho_psi_zy)
      pcomp(3, 1) = BVND(-limit3(2, 3), -limit3(3, 3), rho_psi_zy)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 4) THEN
!
      limit3(2, 1) = (delta_z(1)-m_zs)/psi_z
      limit3(2, 3) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(3)-m_ys)/psi_y
      pcomp(1, 1) = PHID(limit3(2, 1))
      pcomp(3, 1) = BVND(-limit3(2, 3), -limit3(3, 3), rho_psi_zy)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 1) THEN
!
      limit3(2, 1) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(1)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(1)-m_ys)/psi_y
      pcomp(1, 1) = BVND(-limit3(2, 1), -limit3(3, 1), rho_psi_zy)
      pcomp(2, 1) = BVND(-limit3(2, 2), -limit3(3, 2), rho_psi_zy)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 2) THEN
!
      limit3(2, 1) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 3) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(1)-m_ys)/psi_y
      limit3(2, 4) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 4) = (delta_y(1)-m_ys)/psi_y
      pcomp(1, 1) = BVND(-limit3(2, 1), -limit3(3, 1), rho_psi_zy)
      pcomp(2, 1) = BVND(-limit3(2, 2), -limit3(3, 2), rho_psi_zy)
      pcomp(3, 1) = BVND(-limit3(2, 3), -limit3(3, 3), rho_psi_zy)
      pcomp(4, 1) = BVND(-limit3(2, 4), -limit3(3, 4), rho_psi_zy)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 3) THEN
!
      limit3(2, 1) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 1) = (delta_y(3)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(3)-m_ys)/psi_y
      limit3(2, 3) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 4) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 4) = (delta_y(2)-m_ys)/psi_y
      pcomp(1, 1) = BVND(-limit3(2, 1), -limit3(3, 1), rho_psi_zy)
      pcomp(2, 1) = BVND(-limit3(2, 2), -limit3(3, 2), rho_psi_zy)
      pcomp(3, 1) = BVND(-limit3(2, 3), -limit3(3, 3), rho_psi_zy)
      pcomp(4, 1) = BVND(-limit3(2, 4), -limit3(3, 4), rho_psi_zy)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 4) THEN
!
      limit3(2, 1) = (delta_z(2)-m_zs)/psi_z
      limit3(2, 2) = (delta_z(1)-m_zs)/psi_z
      limit3(2, 3) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 3) = (delta_y(3)-m_ys)/psi_y
      limit3(2, 4) = (delta_z(1)-m_zs)/psi_z
      limit3(3, 4) = (delta_y(3)-m_ys)/psi_y
      pcomp(1, 1) = PHID(limit3(2, 1))
      pcomp(2, 1) = PHID(limit3(2, 2))
      pcomp(3, 1) = BVND(-limit3(2, 3), -limit3(3, 3), rho_psi_zy)
      pcomp(4, 1) = BVND(-limit3(2, 4), -limit3(3, 4), rho_psi_zy)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 1) THEN
!
      limit3(3, 1) = (delta_y(1)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(1)-m_ys)/psi_y
      pcomp(1, 1) = PHID(limit3(3, 1))
      pcomp(2, 1) = BVND(-limit3(2, 2), -limit3(3, 2), rho_psi_zy)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 2) THEN
!
      limit3(3, 1) = (delta_y(2)-m_ys)/psi_y
      limit3(2, 2) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 2) = (delta_y(2)-m_ys)/psi_y
      limit3(3, 3) = (delta_y(1)-m_ys)/psi_y
      limit3(2, 4) = (delta_z(2)-m_zs)/psi_z
      limit3(3, 4) = (delta_y(1)-m_ys)/psi_y
      pcomp(1, 1) = PHID(limit3(3, 1))
      pcomp(2, 1) = BVND(-limit3(2, 2), -limit3(3, 2), rho_psi_zy)
      pcomp(3, 1) = PHID(limit3(3, 3))
      pcomp(4, 1) = BVND(-limit3(2, 4), -limit3(3, 4), rho_psi_zy)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 3) THEN
!
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcomp(1, 1) = PHID(limit3(3, 1))
      pcomp(2, 1) = BVND(-limit3(2, 2), -limit3(3, 2), rho_psi_zy)
      pcomp(3, 1) = PHID(limit3(3, 3))
      pcomp(4, 1) = BVND(-limit3(2, 4), -limit3(3, 4), rho_psi_zy)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 4) THEN
!
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcomp(1, 1) = 1.d0
      pcomp(2, 1) = PHID(limit3(2, 2))
      pcomp(3, 1) = PHID(limit3(3, 3))
      pcomp(4, 1) = BVND(-limit3(2, 4), -limit3(3, 4), rho_psi_zy)
!
    END IF
!
    p_zy = pcomp(1, 1) - pcomp(2, 1) - pcomp(3, 1) + pcomp(4, 1)
  CASE (2) 
! 
! as = 0
! 
! joint probability
! 
    p_zy = 1.d0
    corr3 = (/rho_sz, rho_sy, rho_zy/)
    limit3(1, :) = -(m_s/sigma_s)
    eps = 1.d-13
!
    IF (riskavn .EQ. 1 .AND. horizonn .EQ. 1) THEN
!
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      pcomp(1, 1) = TVTL(0, limit3(:, 1), corr3, eps)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 2) THEN
!
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      pcomp(1, 1) = TVTL(0, limit3(:, 1), corr3, eps)
      pcomp(3, 1) = TVTL(0, limit3(:, 3), corr3, eps)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 3) THEN
!
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      pcomp(1, 1) = TVTL(0, limit3(:, 1), corr3, eps)
      pcomp(3, 1) = TVTL(0, limit3(:, 3), corr3, eps)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 4) THEN
!
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      pcomp(1, 1) = BVND(-limit3(1, 1), -limit3(2, 1), rho_sz)
      pcomp(3, 1) = TVTL(0, limit3(:, 3), corr3, eps)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 1) THEN
!
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(1)-m_y)/sigma_y
      pcomp(1, 1) = TVTL(0, limit3(:, 1), corr3, eps)
      pcomp(2, 1) = TVTL(0, limit3(:, 2), corr3, eps)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 2) THEN
!
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(1)-m_y)/sigma_y
      pcomp(1, 1) = TVTL(0, limit3(:, 1), corr3, eps)
      pcomp(2, 1) = TVTL(0, limit3(:, 2), corr3, eps)
      pcomp(3, 1) = TVTL(0, limit3(:, 3), corr3, eps)
      pcomp(4, 1) = TVTL(0, limit3(:, 4), corr3, eps)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 3) THEN
!
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcomp(1, 1) = TVTL(0, limit3(:, 1), corr3, eps)
      pcomp(2, 1) = TVTL(0, limit3(:, 2), corr3, eps)
      pcomp(3, 1) = TVTL(0, limit3(:, 3), corr3, eps)
      pcomp(4, 1) = TVTL(0, limit3(:, 4), corr3, eps)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 4) THEN
!
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcomp(1, 1) = BVND(-limit3(1, 1), -limit3(2, 1), rho_sz)
      pcomp(2, 1) = BVND(-limit3(1, 2), -limit3(2, 2), rho_sz)
      pcomp(3, 1) = TVTL(0, limit3(:, 3), corr3, eps)
      pcomp(4, 1) = TVTL(0, limit3(:, 4), corr3, eps)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 1) THEN
!
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(1)-m_y)/sigma_y
      pcomp(1, 1) = BVND(-limit3(1, 1), -limit3(3, 1), rho_sy)
      pcomp(2, 1) = TVTL(0, limit3(:, 2), corr3, eps)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 2) THEN
!
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(2)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(1)-m_y)/sigma_y
      pcomp(1, 1) = BVND(-limit3(1, 1), -limit3(3, 1), rho_sy)
      pcomp(2, 1) = TVTL(0, limit3(:, 2), corr3, eps)
      pcomp(3, 1) = BVND(-limit3(1, 3), -limit3(3, 3), rho_sy)
      pcomp(4, 1) = TVTL(0, limit3(:, 4), corr3, eps)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 3) THEN
!
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcomp(1, 1) = BVND(-limit3(1, 1), -limit3(3, 1), rho_sy)
      pcomp(2, 1) = TVTL(0, limit3(:, 2), corr3, eps)
      pcomp(3, 1) = BVND(-limit3(1, 3), -limit3(3, 3), rho_sy)
      pcomp(4, 1) = TVTL(0, limit3(:, 4), corr3, eps)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 4) THEN
!
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcomp(1, 1) = 1.d0
      pcomp(2, 1) = BVND(-limit3(1, 2), -limit3(2, 2), rho_sz)
      pcomp(3, 1) = BVND(-limit3(1, 3), -limit3(3, 3), rho_sy)
      pcomp(4, 1) = TVTL(0, limit3(:, 4), corr3, eps)
!
    END IF
!
    p_as = pcomp(1, 1) - pcomp(2, 1) - pcomp(3, 1) + pcomp(4, 1)
  CASE (3) 
! 
! as = 1
! 
! joint probability
! 
    p_zy = 1.d0
    corr3 = (/rho_sz, rho_sy, rho_zy/)
    limit3(1, :) = (q-m_s)/sigma_s
    eps = 1.d-13
!
    IF (riskavn .EQ. 1 .AND. horizonn .EQ. 1) THEN
!
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      pcomp(1, 1) = BVND(-limit3(2, 1), -limit3(3, 1), rho_zy)
      pcomp(1, 2) = TVTL(0, limit3(:, 1), corr3, eps)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 2) THEN
!
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      pcomp(1, 1) = BVND(-limit3(2, 1), -limit3(3, 1), rho_zy)
      pcomp(3, 1) = BVND(-limit3(2, 3), -limit3(3, 3), rho_zy)
      pcomp(1, 2) = TVTL(0, limit3(:, 1), corr3, eps)
      pcomp(3, 2) = TVTL(0, limit3(:, 3), corr3, eps)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 3) THEN
!
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      pcomp(1, 1) = BVND(-limit3(2, 1), -limit3(3, 1), rho_zy)
      pcomp(3, 1) = BVND(-limit3(2, 3), -limit3(3, 3), rho_zy)
      pcomp(1, 2) = TVTL(0, limit3(:, 1), corr3, eps)
      pcomp(3, 2) = TVTL(0, limit3(:, 3), corr3, eps)
!
    ELSE IF (riskavn .EQ. 1 .AND. horizonn .EQ. 4) THEN
!
      limit3(2, 1) = (delta_z(1)-m_z)/sigma_z
      limit3(2, 3) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      pcomp(1, 1) = PHID(limit3(2, 1))
      pcomp(3, 1) = BVND(-limit3(2, 3), -limit3(3, 3), rho_zy)
      pcomp(1, 2) = BVND(-limit3(1, 1), -limit3(2, 1), rho_sz)
      pcomp(3, 2) = TVTL(0, limit3(:, 3), corr3, eps)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 1) THEN
!
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(1)-m_y)/sigma_y
      pcomp(1, 1) = BVND(-limit3(2, 1), -limit3(3, 1), rho_zy)
      pcomp(2, 1) = BVND(-limit3(2, 2), -limit3(3, 2), rho_zy)
      pcomp(1, 2) = TVTL(0, limit3(:, 1), corr3, eps)
      pcomp(2, 2) = TVTL(0, limit3(:, 2), corr3, eps)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 2) THEN
!
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(1)-m_y)/sigma_y
      pcomp(1, 1) = BVND(-limit3(2, 1), -limit3(3, 1), rho_zy)
      pcomp(2, 1) = BVND(-limit3(2, 2), -limit3(3, 2), rho_zy)
      pcomp(3, 1) = BVND(-limit3(2, 3), -limit3(3, 3), rho_zy)
      pcomp(4, 1) = BVND(-limit3(2, 4), -limit3(3, 4), rho_zy)
      pcomp(1, 2) = TVTL(0, limit3(:, 1), corr3, eps)
      pcomp(2, 2) = TVTL(0, limit3(:, 2), corr3, eps)
      pcomp(3, 2) = TVTL(0, limit3(:, 3), corr3, eps)
      pcomp(4, 2) = TVTL(0, limit3(:, 4), corr3, eps)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 3) THEN
!
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcomp(1, 1) = BVND(-limit3(2, 1), -limit3(3, 1), rho_zy)
      pcomp(2, 1) = BVND(-limit3(2, 2), -limit3(3, 2), rho_zy)
      pcomp(3, 1) = BVND(-limit3(2, 3), -limit3(3, 3), rho_zy)
      pcomp(4, 1) = BVND(-limit3(2, 4), -limit3(3, 4), rho_zy)
      pcomp(1, 2) = TVTL(0, limit3(:, 1), corr3, eps)
      pcomp(2, 2) = TVTL(0, limit3(:, 2), corr3, eps)
      pcomp(3, 2) = TVTL(0, limit3(:, 3), corr3, eps)
      pcomp(4, 2) = TVTL(0, limit3(:, 4), corr3, eps)
!
    ELSE IF (riskavn .EQ. 2 .AND. horizonn .EQ. 4) THEN
!
      limit3(2, 1) = (delta_z(2)-m_z)/sigma_z
      limit3(2, 2) = (delta_z(1)-m_z)/sigma_z
      limit3(2, 3) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(1)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcomp(1, 1) = PHID(limit3(2, 1))
      pcomp(2, 1) = PHID(limit3(2, 2))
      pcomp(3, 1) = BVND(-limit3(2, 3), -limit3(3, 3), rho_zy)
      pcomp(4, 1) = BVND(-limit3(2, 4), -limit3(3, 4), rho_zy)
      pcomp(1, 2) = BVND(-limit3(1, 1), -limit3(2, 1), rho_sz)
      pcomp(2, 2) = BVND(-limit3(1, 2), -limit3(2, 2), rho_sz)
      pcomp(3, 2) = TVTL(0, limit3(:, 3), corr3, eps)
      pcomp(4, 2) = TVTL(0, limit3(:, 4), corr3, eps)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 1) THEN
!
      limit3(3, 1) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(1)-m_y)/sigma_y
      pcomp(1, 1) = PHID(limit3(3, 1))
      pcomp(2, 1) = BVND(-limit3(2, 2), -limit3(3, 2), rho_zy)
      pcomp(1, 2) = BVND(-limit3(1, 1), -limit3(3, 1), rho_sy)
      pcomp(2, 2) = TVTL(0, limit3(:, 2), corr3, eps)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 2) THEN
!
      limit3(3, 1) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(2)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(1)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(1)-m_y)/sigma_y
      pcomp(1, 1) = PHID(limit3(3, 1))
      pcomp(2, 1) = BVND(-limit3(2, 2), -limit3(3, 2), rho_zy)
      pcomp(3, 1) = PHID(limit3(3, 3))
      pcomp(4, 1) = BVND(-limit3(2, 4), -limit3(3, 4), rho_zy)
      pcomp(1, 2) = BVND(-limit3(1, 1), -limit3(3, 1), rho_sy)
      pcomp(2, 2) = TVTL(0, limit3(:, 2), corr3, eps)
      pcomp(3, 2) = BVND(-limit3(1, 3), -limit3(3, 3), rho_sy)
      pcomp(4, 2) = TVTL(0, limit3(:, 4), corr3, eps)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 3) THEN
!
      limit3(3, 1) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 2) = (delta_y(3)-m_y)/sigma_y
      limit3(3, 3) = (delta_y(2)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(2)-m_y)/sigma_y
      pcomp(1, 1) = PHID(limit3(3, 1))
      pcomp(2, 1) = BVND(-limit3(2, 2), -limit3(3, 2), rho_zy)
      pcomp(3, 1) = PHID(limit3(3, 3))
      pcomp(4, 1) = BVND(-limit3(2, 4), -limit3(3, 4), rho_zy)
      pcomp(1, 2) = BVND(-limit3(1, 1), -limit3(3, 1), rho_sy)
      pcomp(2, 2) = TVTL(0, limit3(:, 2), corr3, eps)
      pcomp(3, 2) = BVND(-limit3(1, 3), -limit3(3, 3), rho_sy)
      pcomp(4, 2) = TVTL(0, limit3(:, 4), corr3, eps)
!
    ELSE IF (riskavn .EQ. 3 .AND. horizonn .EQ. 4) THEN
!
      limit3(2, 2) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 3) = (delta_y(3)-m_y)/sigma_y
      limit3(2, 4) = (delta_z(2)-m_z)/sigma_z
      limit3(3, 4) = (delta_y(3)-m_y)/sigma_y
      pcomp(1, 1) = 1.d0
      pcomp(2, 1) = PHID(limit3(2, 2))
      pcomp(3, 1) = PHID(limit3(3, 3))
      pcomp(4, 1) = BVND(-limit3(2, 4), -limit3(3, 4), rho_zy)
      pcomp(1, 2) = PHID(limit3(1, 1))
      pcomp(2, 2) = BVND(-limit3(1, 2), -limit3(2, 2), rho_sz)
      pcomp(3, 2) = BVND(-limit3(1, 3), -limit3(3, 3), rho_sy)
      pcomp(4, 2) = TVTL(0, limit3(:, 4), corr3, eps)
!
    END IF
!
    p_as = pcomp(1, 1) - pcomp(2, 1) - pcomp(3, 1) + pcomp(4, 1) - (&
&     pcomp(1, 2)-pcomp(2, 2)-pcomp(3, 2)+pcomp(4, 2))
  END SELECT
!
! Evaluating the integrand
!
  p = p_as*p_zy + minimum_p
END SUBROUTINE INDIVIDUAL_CONTRIBUTION_NODIFF_NODIFF

